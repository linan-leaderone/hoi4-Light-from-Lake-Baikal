initiate_display_vars = {
	#PURELY FOR DISPLAY PURPOSES
	set_variable = { GDP_trillion = 0 }
	set_variable = { GDP_million = 0 }
	set_variable = { total_budget_billion = 0 }
	set_variable = { total_budget_thousand = 0 }
	set_variable = { total_expenditures_billion = 0 }
	set_variable = { total_expenditures_thousand = 0 }
	set_variable = { civilian_expenditures_billion = 0 }
	set_variable = { civilian_expenditures_thousand = 0 }
	set_variable = { military_expenditures_billion = 0 }
	set_variable = { military_expenditures_thousand = 0 }
	set_variable = { money_reserves_billion = 0 }
	set_variable = { money_reserves_thousand = 0 }
	set_variable = { national_debt_trillion = 0 }
	set_variable = { national_debt_million = 0 }
	set_variable = { deficit_billion = 0 }
	set_variable = { deficit_thousand = 0 }
	set_variable = { manpower_costs_billion = 0 }
	set_variable = { manpower_costs_thousand = 0 }
	set_variable = { military_factory_costs_billion = 0 }
	set_variable = { military_factory_costs_thousand = 0 }
	set_variable = { misc_costs_billion = 0 }
	set_variable = { misc_costs_thousand = 0 }
	set_variable = { misc_income_billion = 0 }
	set_variable = { misc_income_thousand = 0 }
	set_variable = { annual_debt_payments_thousand = 0 }
	set_variable = { annual_debt_payments_billion = 0 }
}


## SLIDERS
TNO_sliders_initialize = {
	set_variable = { econ_deficit_monetization_minimal_pct = 0 }
	set_variable = { econ_deficit_monetization_maximal_pct = 100 }
	set_variable = { econ_deficit_monetization_slider_pct = 0 }

	set_variable = { econ_army_expenditures_slider_pct = 50 }
	set_variable = { econ_naval_expenditures_slider_pct = 50 }
	set_variable = { econ_research_expenditures_slider_pct = 50 }
	set_variable = { econ_social_expenditures_slider_pct = 50 }
	set_variable = { econ_admin_expenditures_slider_pct = 50 }
	set_variable = { econ_nuclear_expenditures_slider_pct = 50 }
	set_variable = { econ_consumer_goods_slider_pct = 50 }

	set_variable = { econ_army_expenditures_minimal_pct = 25 }
	set_variable = { econ_army_expenditures_maximal_pct = 75 }

	set_variable = { econ_naval_expenditures_minimal_pct = 25 }
	set_variable = { econ_naval_expenditures_maximal_pct = 75 }

	set_variable = { econ_nuclear_expenditures_minimal_pct = 25 }
	set_variable = { econ_nuclear_expenditures_maximal_pct = 75 }

	set_variable = { econ_research_expenditures_minimal_pct = 25 }
	set_variable = { econ_research_expenditures_maximal_pct = 75 }

	set_variable = { econ_social_expenditures_minimal_pct = 25 }
	set_variable = { econ_social_expenditures_maximal_pct = 75 }

	set_variable = { econ_admin_expenditures_minimal_pct = 25 }
	set_variable = { econ_admin_expenditures_maximal_pct = 75 }

	set_variable = { econ_consumer_goods_minimal_pct = 25 }
	set_variable = { econ_consumer_goods_maximal_pct = 75 }
	##########
	set_variable = { econ_army_maintenance_slider_pct = 50 }
	set_variable = { econ_army_R_D_slider_pct = 50 }
	set_variable = { econ_army_logistics_slider_pct = 50 }
	set_variable = { econ_army_procurement_slider_pct = 50 }

	set_variable = { econ_social_healthcare_slider_pct = 50 }
	set_variable = { econ_social_pensions_slider_pct = 50 }
	set_variable = { econ_social_education_slider_pct = 50 }
	set_variable = { econ_social_unemployment_slider_pct = 50 }

	set_variable = { econ_admin_security_slider_pct = 50 }
	set_variable = { econ_admin_regulations_slider_pct = 50 }
	set_variable = { econ_admin_bureaucracy_slider_pct = 50 }

	set_variable = { econ_research_science_slider_pct = 50 }
	set_variable = { econ_research_facilities_slider_pct = 50 }

	set_variable = { econ_army_maintenance_minimal_pct = 25 }
	set_variable = { econ_army_R_D_minimal_pct = 25 }
	set_variable = { econ_army_logistics_minimal_pct = 25 }
	set_variable = { econ_army_procurement_minimal_pct = 25 }

	set_variable = { econ_social_healthcare_minimal_pct = 25 }
	set_variable = { econ_social_pensions_minimal_pct = 25 }
	set_variable = { econ_social_education_minimal_pct = 25 }
	set_variable = { econ_social_unemployment_minimal_pct = 25 }

	set_variable = { econ_admin_security_minimal_pct = 25 }
	set_variable = { econ_admin_regulations_minimal_pct = 25 }
	set_variable = { econ_admin_pollution_minimal_pct = 25 }
	set_variable = { econ_admin_bureaucracy_minimal_pct = 25 }

	set_variable = { econ_research_science_minimal_pct = 25 }
	set_variable = { econ_research_facilities_minimal_pct = 25 }

	set_variable = { econ_army_maintenance_maximal_pct = 75 }
	set_variable = { econ_army_R_D_maximal_pct = 75 }
	set_variable = { econ_army_logistics_maximal_pct = 75 }
	set_variable = { econ_army_procurement_maximal_pct = 75 }

	set_variable = { econ_social_healthcare_maximal_pct = 75 }
	set_variable = { econ_social_pensions_maximal_pct = 75 }
	set_variable = { econ_social_education_maximal_pct = 75 }
	set_variable = { econ_social_unemployment_maximal_pct = 75 }

	set_variable = { econ_admin_security_maximal_pct = 75 }
	set_variable = { econ_admin_regulations_maximal_pct = 75 }
	set_variable = { econ_admin_pollution_maximal_pct = 75 }
	set_variable = { econ_admin_bureaucracy_maximal_pct = 75 }

	set_variable = { econ_research_science_maximal_pct = 75 }
	set_variable = { econ_research_facilities_maximal_pct = 75 }
	TNO_nation_specific_slider_values_initialize = yes
}

TNO_nation_specific_slider_values_initialize = {
	GNG = {
		set_variable = { econ_army_expenditures_minimal_pct = 0 }
		set_variable = { econ_army_expenditures_maximal_pct = 100 }

		set_variable = { econ_naval_expenditures_minimal_pct = 0 }
		set_variable = { econ_naval_expenditures_maximal_pct = 100 }

		set_variable = { econ_nuclear_expenditures_minimal_pct = 0 }
		set_variable = { econ_nuclear_expenditures_maximal_pct = 100 }

		set_variable = { econ_research_expenditures_minimal_pct = 0 }
		set_variable = { econ_research_expenditures_maximal_pct = 100 }

		set_variable = { econ_social_expenditures_minimal_pct = 0 }
		set_variable = { econ_social_expenditures_maximal_pct = 100 }

		set_variable = { econ_admin_expenditures_minimal_pct = 0 }
		set_variable = { econ_admin_expenditures_maximal_pct = 100 }

		set_variable = { econ_consumer_goods_minimal_pct = 0 }
		set_variable = { econ_consumer_goods_maximal_pct = 100 }
	}

	MGN = {
		set_variable = { econ_research_expenditures_minimal_pct = 60 }
		set_variable = { econ_research_expenditures_maximal_pct = 100 }
	}

	IRE = {
		set_variable = { econ_army_expenditures_minimal_pct = 20 }
		set_variable = { econ_army_expenditures_maximal_pct = 40 }
		set_variable = { econ_army_expenditures_slider_pct = 30 }
	}

	CHL = {
		set_variable = { econ_army_expenditures_minimal_pct = 0 }
		set_variable = { econ_army_expenditures_maximal_pct = 50 }

		set_variable = { econ_admin_expenditures_minimal_pct = 15 }
		set_variable = { econ_admin_expenditures_maximal_pct = 55 }
	}
	
	MEX = {
		set_variable = { econ_army_expenditures_minimal_pct = 15 }
		set_variable = { econ_army_expenditures_maximal_pct = 40 }
		set_variable = { econ_army_expenditures_slider_pct = 20 }
		
		set_variable = { econ_naval_expenditures_minimal_pct = 15 }
		set_variable = { econ_naval_expenditures_maximal_pct = 35 }
		set_variable = { econ_naval_expenditures_slider_pct = 20 }

		set_variable = { econ_research_expenditures_minimal_pct = 0 }
		set_variable = { econ_research_expenditures_maximal_pct = 50 }
		set_variable = { econ_research_expenditures_slider_pct = 20 }
	}
}

## PRODUCTION UNITS


# Toggles the econ tab PU menu, used for some shortcuts
toggle_production_unit_menu = {
	if = {
		limit = { NOT = { has_country_flag = econ_view_visible } }
		set_country_flag = econ_view_visible
		set_country_flag = economy_production_units_open
	}
	else = {
		clr_country_flag = econ_view_visible
	}
	update_economy_tab = yes
	update_all_econ_pie_charts = yes
	update_production_unit_allocation = yes
	set_country_flag = has_opened_pu_menu
	add_to_variable = { TNO_pu_menu_dirty = 1 }
}


# Update the production units menu display
update_prod_units_display = {
	clear_array = prod_units_display_amounts_frame
	clear_array = prod_units_displaying_5
	clear_array = prod_units_displaying_10

	for_loop_effect = {
		start = 0
		end = 4
		value = i

		if = {
			limit = { check_variable = { prod_units_display_amounts^i = 10 } }
			add_to_array = { prod_units_display_amounts_frame = 3 }
			add_to_array = { prod_units_displaying_5 = 1 }
			add_to_array = { prod_units_displaying_10 = 2 }
		}
		else_if = {
			limit = { check_variable = { prod_units_display_amounts^i = 5 } }
			add_to_array = { prod_units_display_amounts_frame = 2 }
			add_to_array = { prod_units_displaying_5 = 2 }
			add_to_array = { prod_units_displaying_10 = 1 }
		}
		else = {
			add_to_array = { prod_units_display_amounts_frame = 1 }
			add_to_array = { prod_units_displaying_5 = 1 }
			add_to_array = { prod_units_displaying_10 = 1 }
		}
	}

	clamp_variable = { var = econ_consumer_goods_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_consumer_goods_maximal_pct min = 0 max = 100 }
	# Consumer goods (Only multiples of 10 allowed)
	clamp_variable = { var = econ_consumer_goods_slider_pct min = econ_consumer_goods_minimal_pct max = econ_consumer_goods_maximal_pct }
	divide_variable = { econ_consumer_goods_slider_pct = 5 }
	round_variable = econ_consumer_goods_slider_pct
	multiply_variable = { econ_consumer_goods_slider_pct = 5 }

	set_variable = { econ_consumer_goods_slider_dot_x = econ_consumer_goods_slider_pct }
	multiply_variable = { econ_consumer_goods_slider_dot_x = 1.88 }
	add_to_variable = { econ_consumer_goods_slider_dot_x = 45 }
	set_variable = { econ_consumer_goods_minimal_x = econ_consumer_goods_minimal_pct }
	multiply_variable = { econ_consumer_goods_minimal_x = 1.88 }
	add_to_variable = { econ_consumer_goods_minimal_x = 45 }
	set_variable = { econ_consumer_goods_maximal_x = econ_consumer_goods_maximal_pct }
	multiply_variable = { econ_consumer_goods_maximal_x = 1.88 }
	add_to_variable = { econ_consumer_goods_maximal_x = 42 }

	add_to_variable = { TNO_economy_GUI_dirty = 1 }
	add_to_variable = { TNO_production_gui_dirty = 1 }
	#force_update_dynamic_modifier = yes
}


# Game-start setup for production units
setup_production_units = {
	clear_array = prod_units_allocation_types
	add_to_array = { prod_units_allocation_types = 0 }
	add_to_array = { prod_units_allocation_types = 1 }
	add_to_array = { prod_units_allocation_types = 2 }

	clear_array = prod_units_production_display
	resize_array = { array = prod_units_production_display value = 0 size = 15 }

	clear_array = prod_units_display_amounts
	resize_array = { array = prod_units_display_amounts value = 1 size = 3 }

	set_variable = { PU_consumer_goods_production = 0 }
	add_dynamic_modifier = { modifier = TNO_consumer_goods_production_dynamic_modifier }
	set_variable = { PU_consumer_goods_stability_impact = 0 }
	set_variable = { PU_consumer_goods_gdp_impact = 0 }
	set_variable = { consumer_goods_desired_ratio = 0 }

	set_variable = { PU_consumer_goods = 0 }
	set_variable = { PU_military_factories = 0 }
	set_variable = { PU_civilian_factories = 0 }
	set_variable = { mils_mult = 1 }
	set_variable = { mils_mult_old = 1 }

	set_variable = { PU_imports = 0 }
	set_variable = { PU_exports = 0 }
	set_variable = { PU_imports_m = 0 }
	set_variable = { PU_exports_m = 0 }
	clear_array = pending_trade_deals

	set_variable = { PU_consumer_goods_desired = 0 }
	set_variable = { PU_military_factories_desired = 0 }
	set_variable = { PU_civilian_factories_desired = 0 }

	update_prod_units_amnt = yes
	update_prod_units_display = yes

	auto_set_ai_pus = yes
}


# Sets up AI production unit allocation
# AI currently is dumb as hell and will split 50/50 mils civs
auto_set_ai_pus = {
	calculate_consumer_goods_need = yes
	set_variable = { PU_consumer_goods_desired = consumer_goods_monthly_use } #Amount needed per month

	add_to_variable = { PU_consumer_goods_desired = TNO_market_consumer_goods } #Market imports/exports
	divide_variable = { PU_consumer_goods_desired = 10 }

	set_temp_variable = { consumer_goods_production_modifier = 1 }
	add_to_temp_variable = { consumer_goods_production_modifier = modifier@consumer_goods_production_factor }
	clamp_temp_variable = { var = consumer_goods_production_modifier min = 0.1 }

	divide_variable = { PU_consumer_goods_desired = consumer_goods_production_modifier }
	round_variable = PU_consumer_goods_desired

	set_temp_variable = { production_units_temp = production_units }
	if = {
		limit = { check_variable = { resource@power < production_units } }
		set_temp_variable = { production_units_temp = resource@power }
	}
	subtract_from_temp_variable = { production_units_temp = PU_consumer_goods_desired }
	set_variable = { PU_military_factories_desired = production_units_temp }
	divide_variable = { PU_military_factories_desired = 2 }
	add_to_variable = { PU_military_factories_desired = 0.5 }
	round_variable = PU_military_factories_desired

	set_variable = { PU_civilian_factories_desired = production_units_temp }
	divide_variable = { PU_civilian_factories_desired = 2 }
	subtract_from_variable = { PU_civilian_factories_desired = 0.49 }
	round_variable = PU_civilian_factories_desired
}


# Refreshes the GDP-based production unit base
update_prod_units_amnt = {
	set_variable = { production_units = totalstateGDP }
	# set_temp_variable = { temp_tsGDP = totalstateGDP }
	# clamp_temp_variable = { var = temp_tsGDP max = 5 }
	# add_to_variable = { production_units = temp_tsGDP }

	#log ="[?modifier@production_units_to_GDP_ratio_modifier] is production unit value for [THIS.GetTag]"

	set_variable = { production_units_multiplier = modifier@production_units_to_GDP_ratio_modifier }

	multiply_variable = { production_units = production_units_multiplier } # magic number
	add_to_variable = { production_units = 0.499 }
	round_variable = production_units
	set_variable = { production_units_gdp_raw = production_units }
	set_variable = { production_units_modifier = 0 }
	add_to_variable = { production_units_modifier = modifier@free_production_units_modifier }
	add_to_variable = { production_units_modifier = free_production_units }
	round_variable = production_units_modifier
	add_to_variable = { production_units = production_units_modifier }
	round_variable = production_units
	set_variable = { production_units_raw = production_units }

	if = {
		limit = { is_ai = yes }
		else = {
			if = {
				limit = { check_variable = { last_months_production_units > production_units } }
				set_temp_variable = { alert_id = token:Alert_LostPU }
				add_TNO_alert_unless_exists = yes
			}
			else = {
				set_temp_variable = { alert_id = token:Alert_LostPU }
				remove_TNO_alert = yes
			}
		}
	}

	set_variable = { pu_to_gdp_ratio = production_units }
	divide_variable = { pu_to_gdp_ratio = totalstateGDP }

	update_prod_units_trade = yes
	set_variable = { last_months_production_units = production_units }
}


# Updates production units available
# Called when a bulk trade is performed or a monthly trade triggers at the start of each month
update_prod_units_trade = {
	set_variable = { production_units = production_units_raw }

	add_to_variable = { production_units = PU_exports }
	subtract_from_variable = { production_units = PU_imports }
	add_to_variable = { production_units = PU_exports_m }
	subtract_from_variable = { production_units = PU_imports_m }
	clamp_variable = { var = production_units min = 0 }

	set_variable = { PU_trade_balance = PU_exports }
	subtract_from_variable = { PU_trade_balance = PU_imports }
	add_to_variable = { PU_trade_balance = PU_exports_m }
	subtract_from_variable = { PU_trade_balance = PU_imports_m }

	update_market_recurring_trade = yes

	update_production_unit_allocation = yes

	calculate_navy_size_effect = yes

	calculate_fuel_consumption = yes
}


# Reallocates production units, taking away factories or granting new factories if need be
update_production_unit_allocation = {

	set_temp_variable = { consumer_goods_min = 0 }

	set_temp_variable = { civs_temp = PU_civilian_factories }
	set_temp_variable = { mils_temp = PU_military_factories }
	multiply_temp_variable = { civs_temp = -1 }
	multiply_temp_variable = { mils_temp = -1 }
	multiply_temp_variable = { mils_temp = mils_mult_old }

	add_offsite_building = { type = industrial_complex level = civs_temp }
	add_offsite_building = { type = arms_factory level = mils_temp }
	set_variable = { mils_mult_old = mils_mult }

	if = {
		limit = { is_ai = yes }
		auto_set_ai_pus = yes
	}

	set_temp_variable = { consumer_goods_min = consumer_goods_monthly_use } #Amount needed per month
	add_to_temp_variable = { consumer_goods_min = TNO_market_consumer_goods } #Market imports/exports
	divide_temp_variable = { consumer_goods_min = 10 }

	set_temp_variable = { consumer_goods_production_modifier = 1 }
	add_to_temp_variable = { consumer_goods_production_modifier = modifier@consumer_goods_production_factor }
	clamp_temp_variable = { var = consumer_goods_production_modifier min = 0.1 }

	divide_temp_variable = { consumer_goods_min = consumer_goods_production_modifier }
	round_temp_variable = consumer_goods_min

	clamp_variable = { var = PU_civilian_factories_desired min = 0 }
	clamp_variable = { var = PU_military_factories_desired min = 0 }
	set_variable = { PU_consumer_goods_desired = consumer_goods_min }

	clamp_variable = { var = PU_civilian_factories max = PU_civilian_factories_desired }
	clamp_variable = { var = PU_military_factories max = PU_military_factories_desired }
	clamp_variable = { var = PU_consumer_goods max = PU_consumer_goods_desired }

	set_temp_variable = { units_left = production_units }

	clamp_temp_variable = { var = units_left max = resource@power }
	subtract_from_temp_variable = { units_left = PU_civilian_factories }
	subtract_from_temp_variable = { units_left = PU_military_factories }
	subtract_from_temp_variable = { units_left = PU_consumer_goods }

	set_temp_variable = { civilian_factories_needed = PU_civilian_factories_desired }
	subtract_from_temp_variable = { civilian_factories_needed = PU_civilian_factories }

	set_temp_variable = { military_factories_needed = PU_military_factories_desired }
	subtract_from_temp_variable = { military_factories_needed = PU_military_factories }

	set_temp_variable = { consumer_goods_needed = PU_consumer_goods_desired }
	subtract_from_temp_variable = { consumer_goods_needed = PU_consumer_goods } #Consumer goods needed to meet the players goal
	subtract_from_temp_variable = { consumer_goods_min = PU_consumer_goods } #Amount needed to cover our minimum needs

	clamp_variable = { var = PU_civilian_factories min = 0 }
	clamp_variable = { var = PU_military_factories min = 0 }
	#log = "[GetDateText]: [Root.GetName]: PU_civilian_factories: [?PU_civilian_factories] PU_military_factories: [?PU_military_factories]"
	while_loop_effect = { #Ensure consumer goods are covered
		limit = { check_variable = { consumer_goods_min > 0 } }
		if = { #Allocate unused PUs
			limit = { check_variable = { units_left > 0 } }
			subtract_from_temp_variable = { units_left = 1 }
		}
		else_if = { #Something is broken somewhere, just add the var w/o taking any thing
			limit = {
				check_variable = { PU_civilian_factories = 0 }
				check_variable = { PU_military_factories = 0 }
			}
		}
		else = { #Steal from others
			random_list = {
				50 = {
					modifier = {
						factor = 0
						check_variable = { PU_civilian_factories = 0 }
					}
					subtract_from_variable = { PU_civilian_factories = 1 }
					add_to_temp_variable = { civilian_factories_needed = 1 }
				}
				50 = {
					modifier = {
						factor = 0
						check_variable = { PU_military_factories = 0 }
					}
					subtract_from_variable = { PU_military_factories = 1 }
					add_to_temp_variable = { military_factories_needed = 1 }
				}
			}
		}

		add_to_variable = { PU_consumer_goods = 1 }

		subtract_from_temp_variable = { consumer_goods_min = 1 } #Minimum obligation to cover our needs
		subtract_from_temp_variable = { consumer_goods_needed = 1 } #Excess desired
	}

	# Allocate unused factories
	while_loop_effect = {
		limit = {
			check_variable = { units_left > 0 }
			OR = {
				check_variable = { civilian_factories_needed > 0 }
				check_variable = { military_factories_needed > 0 }
				check_variable = { consumer_goods_needed > 0 }
			}
		}
		random_list = { # Prioritize categories with lowest % fulfillment
			var:civilian_factories_needed = {
				subtract_from_temp_variable = { civilian_factories_needed = 1 }
				add_to_variable = { PU_civilian_factories = 1 }
			}
			var:military_factories_needed = {
				subtract_from_temp_variable = { military_factories_needed = 1 }
				add_to_variable = { PU_military_factories = 1 }
			}
			var:consumer_goods_needed = {
				subtract_from_temp_variable = { consumer_goods_needed = 1 }
				add_to_variable = { PU_consumer_goods = 1 }
			}
		}
		subtract_from_temp_variable = { units_left = 1 }
	}

	# Remove unspent PU alert
	if = {
		limit = { is_ai = yes }
		else = {
			if = {
				limit = { check_variable = { units_left < 1 } }
				set_temp_variable = { alert_id = token:Alert_UnallocatedPU }
				remove_TNO_alert = yes
			}
			else = {
				set_temp_variable = { alert_id = token:Alert_UnallocatedPU }
				add_TNO_alert_unless_exists = yes
			}
		}
	}

	set_temp_variable = { to_remove = units_left }
	multiply_temp_variable = { to_remove = -1 }

	# Remove excess factories if overallocated
	while_loop_effect = {
		limit = {
			check_variable = { to_remove > 0 }
		}

		#set_temp_variable = { civ_ratio = PU_civilian_factories }
		#divide_temp_variable = { civ_ratio = PU_civilian_factories_desired }
		#set_temp_variable = { mil_ratio = PU_military_factories }
		#divide_temp_variable = { mil_ratio = PU_military_factories_desired }
		#set_temp_variable = { cg_ratio = PU_consumer_goods }
		#divide_temp_variable = { cg_ratio = PU_consumer_goods_desired }
		#
		#clamp_temp_variable = { var = civ_ratio min = 0 }
		#clamp_temp_variable = { var = mil_ratio min = 0 }
		#clamp_temp_variable = { var = cg_ratio min = 0 }
		#
		#if = { # This is so I don't get bombarded with 200 errors on startup
		#	limit = {
		#		check_variable = { civ_ratio = 0 }
		#		check_variable = { mil_ratio = 0 }
		#		check_variable = { cg_ratio = 0 }
		#	}
		#	set_temp_variable = { civ_ratio = 1 }
		#	set_temp_variable = { mil_ratio = 1 }
		#	set_temp_variable = { cg_ratio = 1 }
		#}
		#log = "[GetDateText]: [Root.GetName]: civ_ratio: [?civ_ratio] mil_ratio: [?mil_ratio] cg_ratio: [?cg_ratio]"

		# Tried to keep % fulfillment of desired factories the same (weight higher % fulfilled)
		# Breaks a lot after AAT (or was it breaking before and just not throwing errors?)
		# Now just uses flat 33% across the board, and stops removing after it hits 0
		# Marethyu here - made a small revision so that the code doesn't throw errors out while still achieving the same purpose
		# Rune here again - another revision, Mare's version left chance where it could try to remove all PUs w/o removing all PUs due to randomness
		if = {
			limit = {
				NOT = {
					AND = {
						check_variable = { PU_civilian_factories = 0 }
						check_variable = { PU_military_factories = 0 }
						check_variable = { PU_consumer_goods = 0 }
					}
				}
			}
			random_list = {
				33 = {
					modifier = {
						factor = 0
						check_variable = { PU_civilian_factories = 0 }
					}
					subtract_from_variable = { PU_civilian_factories = 1 }
				}
				33 = {
					modifier = {
						factor = 0
						check_variable = { PU_military_factories = 0 }
					}
					subtract_from_variable = { PU_military_factories = 1 }
				}
				33 = {
					modifier = {
						factor = 0
						check_variable = { PU_consumer_goods = 0 }
					}
					subtract_from_variable = { PU_consumer_goods = 1 }
				}
			}
		}
		subtract_from_temp_variable = { to_remove = 1 }
	}

	set_variable = { production_units_used = PU_civilian_factories }
	add_to_variable = { production_units_used = PU_military_factories }
	add_to_variable = { production_units_used = PU_consumer_goods }
	set_variable = { production_units_free = production_units }
	subtract_from_variable = { production_units_free = production_units_used }

	set_temp_variable = { mils_temp = PU_military_factories }
	multiply_temp_variable = { mils_temp = mils_mult }

	add_offsite_building = { type = industrial_complex level = PU_civilian_factories }
	add_offsite_building = { type = arms_factory level = mils_temp }

	set_temp_variable = { temp_fo = modifier@industrial_capacity_factory }
	subtract_from_temp_variable = { temp_fo = TNO_econ_mult_factory_output_penalty }
	add_to_temp_variable = { temp_fo = 1 }
	set_variable = { TNO_econ_mult_factory_output_penalty = temp_fo }
	divide_temp_variable = { temp_fo = mils_mult }
	subtract_from_variable = { TNO_econ_mult_factory_output_penalty = temp_fo }
	multiply_variable = { TNO_econ_mult_factory_output_penalty = -1 }

	set_variable = { PU_civ_steel_consumption = PU_civilian_factories }
	multiply_variable = { PU_civ_steel_consumption = modifier@steel_cost_civilian_factories }
	add_to_variable = { PU_civ_steel_consumption = PU_civilian_factories }

	set_temp_variable = { consumer_goods_production_modifier = 1 }
	add_to_temp_variable = { consumer_goods_production_modifier = modifier@consumer_goods_production_factor }

	clamp_variable = {
		var = consumer_goods_production_modifier
		min = 0
	}

	set_variable = { PU_base_consumer_goods_produced = PU_consumer_goods } #Just for tooltip's sake
	multiply_variable = { PU_base_consumer_goods_produced = 10 }

	set_variable = { PU_consumer_goods_production = PU_consumer_goods }
	multiply_variable = { PU_consumer_goods_production = consumer_goods_production_modifier }
	multiply_variable = { PU_consumer_goods_production = -10 }

	set_variable = { TNO_consumer_goods_resource_demand = PU_consumer_goods_production }
	set_variable = { TNO_consumer_goods_chromium_demand = TNO_consumer_goods_resource_demand }
	set_variable = { TNO_consumer_goods_tungsten_demand = TNO_consumer_goods_resource_demand }
	set_variable = { TNO_consumer_goods_steel_demand = TNO_consumer_goods_resource_demand }
	set_variable = { TNO_consumer_goods_rubber_demand = TNO_consumer_goods_resource_demand }
	set_variable = { TNO_consumer_goods_aluminium_demand = TNO_consumer_goods_resource_demand }

	divide_variable = { TNO_consumer_goods_chromium_demand = -10 }

	divide_variable = { TNO_consumer_goods_tungsten_demand = -10 }

	divide_variable = { TNO_consumer_goods_steel_demand = -10 }

	divide_variable = { TNO_consumer_goods_rubber_demand = -10 }

	divide_variable = { TNO_consumer_goods_aluminium_demand = -10 }

	if = {
		limit = { is_ai = no }
		update_economy_tab = yes
		add_to_variable = { TNO_production_gui_dirty = 1 }
	}
}

calculate_fuel_consumption = {
	set_variable = {
		economy_fuel_cost = gdp
	}
	set_temp_variable = {
		poverty_rate_decimal = poverty_rate
	}
	divide_temp_variable = {
		poverty_rate_decimal = 100
	}
	set_temp_variable = {
		fuel_cost_poverty_rate_factor = 1.5
	}
	subtract_from_temp_variable = {
		fuel_cost_poverty_rate_factor = poverty_rate_decimal
	}
	multiply_variable = {
		economy_fuel_cost = fuel_cost_poverty_rate_factor
	}
	calculate_industrial_equipment_fuel_cost_factor = yes
	calculate_agricultural_methods_fuel_cost_factor = yes

	multiply_variable = {
		economy_fuel_cost = industrial_equipment_fuel_cost_factor
	}
	multiply_variable = {
		economy_fuel_cost = agricultural_methods_fuel_cost_factor
	}
	### fuel consumption is calculated hourly, 24 hours in a day
	round_variable = economy_fuel_cost
}

calculate_industrial_equipment_fuel_cost_factor = {
	if = {
		limit = {
			has_idea = tno_industrial_equipment_hand_tools
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 0 }
	}
	else_if = {
		limit = {
			has_idea = tno_industrial_equipment_power_tools
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 0.25 }
	}
	else_if = {
		limit = {
			has_idea = tno_industrial_equipment_manufacturing_lines
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 0.75 }
	}
	else_if = {
		limit = {
			has_idea = tno_industrial_equipment_factory_complexes
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 1.0 }
	}
	else_if = {
		limit = {
			has_idea = tno_industrial_equipment_modern
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 1.25 }
	}
	else_if = {
		limit = {
			has_idea = tno_industrial_equipment_cutting_edge
		}
		set_variable = { industrial_equipment_fuel_cost_factor = 1.5 }
	}
}

calculate_agricultural_methods_fuel_cost_factor = {
	if = {
		limit = {
			has_idea = tno_agriculture_subsistence
		}
		set_variable = { agricultural_methods_fuel_cost_factor = 0 }
	}
	else_if = {
		limit = {
			has_idea = tno_agriculture_centralized
		}
		set_variable = { agricultural_methods_fuel_cost_factor = 0.25 }
	}
	else_if = {
		limit = {
			has_idea = tno_agriculture_basic_mechanized
		}
		set_variable = { agricultural_methods_fuel_cost_factor = 0.75 }
	}
	else_if = {
		limit = {
			has_idea = tno_agriculture_mass_mechanized
		}
		set_variable = { agricultural_methods_fuel_cost_factor = 1 }
	}
	else_if = {
		limit = {
			has_idea = tno_agriculture_modern
		}
		set_variable = { agricultural_methods_fuel_cost_factor = 1.25 }
	}
}


###################################################################
###################################################################
## BUDGET - Trade Code, I use this to traverse VSC ################
###################################################################
###################################################################


calculate_total_income = {
	set_variable = { total_pop_m = 0 }
	set_variable = { total_core_pop_m = 0 }
	every_owned_state = {
		set_temp_variable = { spm = state_population_k }
		divide_temp_variable = { spm = 1000 }
		add_to_variable = { PREV.total_pop_m = spm }
		if = {
			limit = { is_core_of = OWNER }
			add_to_variable = { PREV.total_core_pop_m = spm }
		}
	}
	set_variable = { total_ncore_pop_m = total_pop_m }
	subtract_from_variable = { total_ncore_pop_m = total_core_pop_m }

	### Income Taxes
	calculate_taxable_population = yes
	set_variable = { non_poor_income_tax_revenue = non_poor_taxable_population }
	set_variable = { poor_income_tax_revenue = poverty_rate_taxable_population }

	set_variable = { income_tax_factor = income_tax_rate }
	add_to_variable = { income_tax_factor = modifier@income_tax_rate_modifier_factor }
	clamp_variable = { var = income_tax_factor min = 0 max = 1 }

	set_variable = { poverty_income_tax_factor = income_tax_factor }
	multiply_variable = { poverty_income_tax_factor = 0.5 }
	multiply_variable = { poverty_income_tax_factor = modifier@poverty_taxation_rate_modifier }

	multiply_variable = { non_poor_income_tax_revenue = income_tax_factor }
	multiply_variable = { non_poor_income_tax_revenue = gdp }
	multiply_variable = { poor_income_tax_revenue = poverty_income_tax_factor }
	multiply_variable = { poor_income_tax_revenue = gdp }

	set_variable = { income_tax_revenue = non_poor_income_tax_revenue }
	add_to_variable = { income_tax_revenue = poor_income_tax_revenue }

	### Business Taxes
	calculate_industrial_contribution = yes
	set_variable = { business_tax_display = business_tax_rate_total }
	multiply_variable = { business_tax_display = 100 }

	### Misc Income
	set_variable = { misc_income_true = modifier@misc_income_modifier }

	set_variable = { misc_income_percent_of_GDP = modifier@misc_income_percent_of_GDP_modifier }
	multiply_variable = { misc_income_percent_of_GDP = GDP }
	add_to_variable = { misc_income_true = misc_income_percent_of_GDP }

	### Excise Tax calculation

	set_temp_variable = { sales_tax = modifier@sales_tax_rate_modifier }
	add_to_temp_variable = { sales_tax = sales_tax_rate }
	clamp_temp_variable = { var = sales_tax min = 0 max = 1 }
	set_variable = { sales_tax_display = sales_tax }
	multiply_temp_variable = { sales_tax = GDP }
	set_variable = { sales_tax_total_income = sales_tax }

	set_temp_variable = { tariff_tax = modifier@tariff_tax_rate_modifier }
	set_variable = { tariff_tax_display = tariff_tax }
	multiply_temp_variable = { tariff_tax = imports_value }
	set_variable = { tariff_tax_total_income = tariff_tax }

	# War taxes, which are implemented as excise taxes
	set_temp_variable = { budget_calc = income_tax_revenue }
	add_to_temp_variable = { budget_calc = industrial_contribution }
	add_to_temp_variable = { budget_calc = sales_tax }
	add_to_temp_variable = { budget_calc = tariff_tax }
	add_to_temp_variable = { budget_calc = misc_income_true }
	divide_temp_variable = { budget_calc = gdp }

	set_temp_variable = { war_tax = 0.4 }
	add_to_temp_variable = { war_tax = budget_calc }
	divide_temp_variable = { war_tax = 2 }
	subtract_from_temp_variable = { war_tax = budget_calc }
	multiply_temp_variable = { war_tax = GDP }
	multiply_temp_variable = { war_tax = war_tax_enabled }
	clamp_temp_variable = { var = war_tax min = 0 }
	set_variable = { war_tax_total_income = war_tax }

	set_variable = { excise_income_true = sales_tax }
	add_to_variable = { excise_income_true = tariff_tax }
	add_to_variable = { excise_income_true = war_tax }

	### Total income calc
	set_temp_variable = { budget_calc = income_tax_revenue }
	add_to_temp_variable = { budget_calc = industrial_contribution }
	add_to_temp_variable = { budget_calc = excise_income_true }
	add_to_temp_variable = { budget_calc = misc_income_true }

	set_variable = { income_revenue_percent = income_tax_revenue }
	set_variable = { business_revenue_percent = industrial_contribution }
	set_variable = { excise_revenue_percent = excise_income_true }
	set_variable = { other_revenue_percent = misc_income_true }

	divide_variable = { income_revenue_percent = budget_calc }
	divide_variable = { business_revenue_percent = budget_calc }
	divide_variable = { excise_revenue_percent = budget_calc }
	divide_variable = { other_revenue_percent = budget_calc }

	multiply_variable = { income_revenue_percent = 100 }
	multiply_variable = { business_revenue_percent = 100 }
	multiply_variable = { excise_revenue_percent = 100 }
	multiply_variable = { other_revenue_percent = 100 }

	round_variable = income_revenue_percent
	round_variable = business_revenue_percent
	round_variable = excise_revenue_percent
	round_variable = other_revenue_percent

	set_temp_variable = { income_validator = income_revenue_percent }
	add_to_temp_variable = { income_validator = business_revenue_percent }
	add_to_temp_variable = { income_validator = excise_revenue_percent }
	add_to_temp_variable = { income_validator = other_revenue_percent }

	if = {
		limit = {
			NOT = {
				check_variable = { income_validator = 100 }
			}
		}
		subtract_from_temp_variable = { income_validator = 100 }
		subtract_from_variable = { income_revenue_percent = income_validator }
	}

	# subtract_from_temp_variable = { budget_calc = debt_calc }

	set_variable = { total_income = budget_calc }
	#log ="[THIS.GetTag] total income is [?total_income]"
}

calculate_debt_to_GDP_ratio = {
	# simple function to calculate debt to GDP ratio
	set_temp_variable = { temp_debt_to_GDP_ratio = national_debt }
	if = {
		limit = {
			NOT = {
				check_variable = { national_debt = 0 }
			}
		}
		divide_temp_variable = { temp_debt_to_GDP_ratio = GDP }
		set_variable = { debt_to_GDP_ratio = temp_debt_to_GDP_ratio }
	}
	else = {
		set_variable = { debt_to_GDP_ratio = 0 }
	}
	#For Guangdong
	if = {
		limit = {
			tag = GNG
		}
		GNG_calculate_fiscal_health = yes
	}
	# this returns debt as a % of GDP if debt exists. If debt does not exist, returns 0.
}

calculate_debt_effect_on_GDP_growth = {

	#uses \frac{\left(x-80\right)^{2}}{180}


	set_temp_variable = { temp_debt_effect = debt_to_GDP_ratio }
	multiply_temp_variable = { temp_debt_effect = 100 }

	subtract_from_temp_variable = { temp_debt_effect = 80 }

	set_temp_variable = { temp_debt_effect_squarer = temp_debt_effect }

	multiply_temp_variable = { temp_debt_effect = temp_debt_effect_squarer }
	divide_temp_variable = { temp_debt_effect = 180 }

	multiply_temp_variable = { temp_debt_effect = -1 } #convert to negative!
	if = {
		limit = {
			check_variable = { debt_to_GDP_ratio < 0.8 }
		}
		set_temp_variable = { temp_debt_effect = 0 }
	}
	clamp_temp_variable = { var = temp_debt_effect min = -800 max = 0 } # -8x modifier on GDP growth at worst
	divide_temp_variable = { temp_debt_effect = 100 }
	set_variable = { debt_effect_base_display = temp_debt_effect }

	set_variable = { debt_GDP_effect_multiplier = credit_rating_effect_on_debt_GDP_effect }
	add_to_variable = { debt_GDP_effect_multiplier = modifier@debt_effect_on_GDP_growth_modifier }
	add_to_variable = { debt_GDP_effect_multiplier = 1 }
	multiply_temp_variable = { temp_debt_effect = debt_GDP_effect_multiplier }

	set_variable = { debt_effect_on_nominal_growth = temp_debt_effect }
}

calculate_deficit_to_GDP_ratio = {
	# simple function to calculate deficit to GDP ratio
	set_temp_variable = { temp_deficit_to_GDP_ratio = deficit }
	multiply_temp_variable = { temp_deficit_to_GDP_ratio = 100 }
	if = {
		limit = {
			NOT = {
				check_variable = { deficit = 0 }
			}
		}

		divide_temp_variable = { temp_deficit_to_GDP_ratio = GDP }
	}
	multiply_temp_variable = { temp_deficit_to_GDP_ratio = -1 }

	set_variable = { deficit_to_GDP_ratio = temp_deficit_to_GDP_ratio }

	set_temp_variable = { temp_GDP_growth_inverted = GDP_growth_real }
	multiply_temp_variable = { temp_GDP_growth_inverted = -1 }
	set_variable = { GDP_growth_inverted = temp_GDP_growth_inverted }
}

calculate_deficit_effects_display = {

	#do the sqrt shit
	set_variable = { sr_arg_number = deficit_to_GDP_ratio }
	if = {
		limit = {
			check_variable = { sr_arg_number < 0 }
		}
		multiply_variable = { sr_arg_number = -1 }
	}
	square_root_babylonian = yes
	set_variable = { deficit_GDP_growth_effect = sr_ret_number }
	if = {
		limit = {
			check_variable = { deficit_to_GDP_ratio > 0 }
		}
		multiply_variable = { deficit_GDP_growth_effect = -1 }
	}

	multiply_variable = { deficit_GDP_growth_effect = 0.667 }

	set_temp_variable = { deficit_GDP_growth_multiplier = modifier@deficit_GDP_growth_modifier }
	add_to_temp_variable = { deficit_GDP_growth_multiplier = 1 }

	multiply_variable = { deficit_GDP_growth_effect = deficit_GDP_growth_multiplier }
	clamp_variable = { var = deficit_GDP_growth_effect min = 0 }


	set_variable = { deficit_PP_cost_display = deficit_to_GDP_ratio }

	set_temp_variable = { deficit_PP_cost_multiplier = modifier@deficit_pp_cost_modifier }
	add_to_temp_variable = { deficit_PP_cost_multiplier = 1 }

	multiply_variable = { deficit_PP_cost_display = deficit_PP_cost_multiplier }

	add_to_variable = { deficit_PP_cost_display = -1.5 }

	set_temp_variable = { deficit_PP_cost_display_cuber = deficit_PP_cost_display }
	multiply_variable = { deficit_PP_cost_display = deficit_PP_cost_display_cuber } #square it
	multiply_variable = { deficit_PP_cost_display = deficit_PP_cost_display_cuber } #cube it


	if = {
		limit = {
			check_variable = { deficit_pp_cost_display < 0 }
		}
		multiply_variable = { deficit_pp_cost_display = -1 }
	}

	set_temp_variable = { deficit_pp_cost_display_denominator = deficit_PP_cost_display }
	add_to_temp_variable = { deficit_pp_cost_display_denominator = 3000 }

	multiply_temp_variable = { deficit_pp_cost_display_denominator = deficit_pp_cost_multiplier }

	divide_variable = { deficit_PP_cost_display = deficit_PP_cost_display_denominator }

	multiply_variable = { deficit_PP_cost_display = 0.65 }

	if = {
		limit = {
			check_variable = { deficit_to_GDP_ratio > 0 }
		}
		multiply_variable = { deficit_PP_cost_display = -2 }
	}

	set_temp_variable = { deficit_cost_multiplicative_effect = 1 }
	add_to_temp_variable = { deficit_cost_multiplicative_effect = modifier@deficit_political_power_cost_modifier }
	clamp_temp_variable = { var = deficit_cost_multiplicative_effect min = 0 }
	multiply_variable = { deficit_PP_cost_display = deficit_cost_multiplicative_effect }
	clamp_variable = { var = deficit_PP_cost_display min = -0.1 }
}

apply_deficit_effects_monthly = {
	set_variable = { TNO_deficit_PP_cost = deficit_PP_cost_display }
}

calculate_deficit_to_debt_ratio = {
	set_temp_variable = { temp_deficit_to_debt_ratio = deficit }
	if = {
		limit = {
			NOT = {
				check_variable = { deficit = 0 }
			}
		}

		divide_temp_variable = { temp_deficit_to_debt_ratio = national_debt }
	}
	multiply_temp_variable = { temp_deficit_to_debt_ratio = -1 }
	set_variable = { deficit_to_debt_ratio = temp_deficit_to_debt_ratio }
	set_variable = { deficit_to_debt_ratio_in_hundred = deficit_to_debt_ratio }
	multiply_variable = { deficit_to_debt_ratio_in_hundred = 100 }
}

calculate_industrial_contribution = {

	set_variable = { industrial_contribution = CG_production_value }
	multiply_variable = { industrial_contribution = 0.9 }

	set_variable = { business_tax_rate_total = business_tax_rate }
	add_to_variable = { business_tax_rate_total = modifier@business_tax_rate_modifier }

	clamp_variable = { var = business_tax_rate_total min = 0 max = 1 }

	multiply_variable = { industrial_contribution = business_tax_rate_total }
	clamp_variable = { var = industrial_contribution min = 0 }
}

war_taxes_check = {
	if = {
		limit = { has_country_flag = war_taxes_enabled }
		set_variable = { war_tax_enabled = 1 }
		add_to_variable = { tno_draft_exemptions_effectiveness = -10 }
		#add_to_variable = { GDP_growth_nominal = -1.5 }
		add_war_support = -0.075
	}
	else_if = {
		limit = { NOT = { has_country_flag = war_taxes_enabled } }
		set_variable = { war_tax_enabled = 0 }
		add_to_variable = { tno_draft_exemptions_effectiveness = 10 }
		#add_to_variable = { GDP_growth_nominal = 1.5 }
		add_war_support = 0.075
	}
	TNO_update_policy_effectiveness = yes
	update_economy_tab = yes
}

calculate_taxable_population = {

	set_temp_variable = { poverty_rate_percent = poverty_rate }
	divide_temp_variable = { poverty_rate_percent = 100 } # a useful number thank god
	set_temp_variable = { inverse_poverty_rate_percent = 1 }
	subtract_from_temp_variable = { inverse_poverty_rate_percent = poverty_rate_percent }

	set_variable = { taxable_population = 0.60 } # set taxable population to 60%
	add_to_variable = { taxable_population = modifier@taxable_population_modifier } # How much of the population we can tax (additive) from social policies
	multiply_variable = { taxable_population = modifier@taxable_population_factor } # How much of the population we can tax administratively (multiplicative)

	set_variable = { poverty_rate_taxable_population = poverty_rate_percent }
	multiply_variable = { poverty_rate_taxable_population = taxable_population } # how much of the poor are eligible to be taxed with current tax laws

	set_variable = { non_poor_taxable_population = inverse_poverty_rate_percent }
	multiply_variable = { non_poor_taxable_population = taxable_population } # how much of the rich are eligible to be taxed with current tax laws
}

#Budget and expenditures are calculated as if they were ticked annually (and for display purposes), but are recalculated monthly with temp variables for the purposes of actual calculations

calculate_civilian_expenditures = { #Note = in billions
	calculate_social_expenditures = yes
	calculate_admin_expenditures = yes
	calculate_research_expenditures = yes

	set_variable = { civilian_expenditures = admin_costs }
	add_to_variable = { civilian_expenditures = research_costs }
	add_to_variable = { civilian_expenditures = total_sp_costs }

	calculate_civilian_misc_costs = yes
	add_to_variable = { civilian_expenditures = civilian_misc_costs_total }
	# Adds any extra fixed cost, uses a variable to store expenses coming from non-modifier sources
	multiply_variable = { civilian_expenditures = modifier@civilian_expenditures_factor } # Used by Civ Boost/Austerity ideas, applied on top of total civ spending
}

calculate_civilian_misc_costs = {
	set_variable = { civilian_misc_costs_total = modifier@civilian_annual_cost } # Adds any extra fixed cost stemming from odifiers (ideas, decisions etc etc)
	clamp_variable = { var = civilian_misc_costs_total min = 0 }
}

##Social

calculate_social_expenditures = {
	set_variable = { total_sp_costs = 0 }

	calculate_health_care_expenditures = yes
	calculate_education_expenditures = yes
	calculate_pensions_expenditures = yes
	calculate_unemployment_expenditures = yes
	calculate_social_costs_misc = yes

	set_variable = { other_program_cost_modified = modifier@tno_other_program_proportional_pop_cost }
	multiply_variable = { other_program_cost_modified = modifier@social_program_cost_factor }
	multiply_variable = { other_program_cost_modified = total_pop_m }

	set_variable = { sp_cost_slider_effect = econ_social_expenditures_slider_pct }
	multiply_variable = { sp_cost_slider_effect = 0.95 }
	add_to_variable = { sp_cost_slider_effect = 5 }
	divide_variable = { sp_cost_slider_effect = 100 }

	multiply_variable = { other_program_cost_modified = sp_cost_slider_effect }
	multiply_variable = { total_sp_costs = sp_cost_slider_effect }

	add_to_variable = { total_sp_costs = social_healthcare_costs }
	add_to_variable = { total_sp_costs = social_education_costs }
	add_to_variable = { total_sp_costs = social_pensions_costs }
	add_to_variable = { total_sp_costs = social_unemployment_costs }
	add_to_variable = { total_sp_costs = social_costs_misc_total }
	add_to_variable = { total_sp_costs = other_program_cost_modified }

	set_variable = { total_sp_costs_base = total_sp_costs }

}

calculate_social_costs_misc = {
	set_variable = { social_costs_misc_total = modifier@social_costs_misc } # Adds any extra fixed cost stemming from odifiers (ideas, decisions etc etc)
	clamp_variable = { var = social_costs_misc_total min = 0 }
}

calculate_health_care_expenditures = {
	set_variable = { social_healthcare_costs = tno_health_care_proportional_pop_cost }
	multiply_variable = { social_healthcare_costs = modifier@social_program_cost_factor }
	multiply_variable = { social_healthcare_costs = total_core_pop_m }

	set_variable = { healthcare_cost_slider_effect = econ_social_healthcare_slider_pct }
	multiply_variable = { healthcare_cost_slider_effect = 0.95 }
	add_to_variable = { healthcare_cost_slider_effect = 5 }
	divide_variable = { healthcare_cost_slider_effect = 100 }

	multiply_variable = { social_healthcare_costs = healthcare_cost_slider_effect }
}

calculate_education_expenditures = {
	set_variable = { social_education_costs = tno_education_proportional_pop_cost }
	multiply_variable = { social_education_costs = modifier@social_program_cost_factor }
	multiply_variable = { social_education_costs = total_core_pop_m }

	set_variable = { education_cost_slider_effect = econ_social_education_slider_pct }
	multiply_variable = { education_cost_slider_effect = 0.95 }
	add_to_variable = { education_cost_slider_effect = 5 }
	divide_variable = { education_cost_slider_effect = 100 }

	multiply_variable = { social_education_costs = education_cost_slider_effect }
}

calculate_pensions_expenditures = {
	set_variable = { social_pensions_costs = tno_pensions_proportional_pop_cost }
	multiply_variable = { social_pensions_costs = modifier@social_program_cost_factor }
	multiply_variable = { social_pensions_costs = total_core_pop_m }

	set_variable = { pensions_cost_slider_effect = econ_social_pensions_slider_pct }
	multiply_variable = { pensions_cost_slider_effect = 0.95 }
	add_to_variable = { pensions_cost_slider_effect = 5 }
	divide_variable = { pensions_cost_slider_effect = 100 }

	multiply_variable = { social_pensions_costs = pensions_cost_slider_effect }
}

calculate_unemployment_expenditures = {
	set_variable = { social_unemployment_costs = tno_unemployment_proportional_pop_cost }
	multiply_variable = { social_unemployment_costs = modifier@social_program_cost_factor }
	multiply_variable = { social_unemployment_costs = total_core_pop_m }

	set_variable = { unemployment_cost_slider_effect = econ_social_unemployment_slider_pct }
	multiply_variable = { unemployment_cost_slider_effect = 0.95 }
	add_to_variable = { unemployment_cost_slider_effect = 5 }
	divide_variable = { unemployment_cost_slider_effect = 100 }

	multiply_variable = { social_unemployment_costs = unemployment_cost_slider_effect }
}

##Admin

calculate_admin_expenditures = {
	set_variable = { basic_admin_costs = modifier@tno_admin_proportional_pop_cost }
	multiply_variable = { basic_admin_costs = modifier@admin_program_cost_factor }

	set_variable = { total_ap_costs = 0 }

	calculate_regulations_expenditures = yes
	calculate_security_expenditures = yes
	calculate_bureaucracy_expenditures = yes
	calculate_admin_costs_misc = yes

	set_variable = { adm_cost_slider_effect = econ_admin_expenditures_slider_pct }
	multiply_variable = { adm_cost_slider_effect = 0.8 }
	add_to_variable = { adm_cost_slider_effect = 20 }
	divide_variable = { adm_cost_slider_effect = 100 }

	multiply_variable = { basic_admin_costs = adm_cost_slider_effect }

	add_to_variable = { total_ap_costs = admin_regulations_costs }
	add_to_variable = { total_ap_costs = admin_pollution_costs }
	add_to_variable = { total_ap_costs = admin_security_costs }
	add_to_variable = { total_ap_costs = admin_bureaucracy_costs }
	add_to_variable = { total_ap_costs = admin_costs_misc_total }
	add_to_variable = { total_ap_costs = basic_admin_costs }

	set_variable = { admin_bureaucracy_costs_display = admin_bureaucracy_costs }
	add_to_variable = { admin_bureaucracy_costs_display = basic_admin_costs }

	set_variable = { admin_costs = total_ap_costs }
}

calculate_admin_costs_misc = {
	set_variable = { admin_costs_misc_total = modifier@admin_costs_misc } # Adds any extra fixed cost stemming from odifiers (ideas, decisions etc etc)
	clamp_variable = { var = admin_costs_misc_total min = 0 }
}

calculate_bureaucracy_expenditures = {
	set_variable = { admin_bureaucracy_costs = GDP }
	divide_variable = { admin_bureaucracy_costs = 100000 }
	multiply_variable = { admin_bureaucracy_costs = total_pop_m }

	set_variable = { bureaucracy_cost_slider_effect = econ_admin_bureaucracy_slider_pct }
	multiply_variable = { bureaucracy_cost_slider_effect = 0.8 }
	add_to_variable = { bureaucracy_cost_slider_effect = 20 }
	divide_variable = { bureaucracy_cost_slider_effect = 100 }

	multiply_variable = { admin_bureaucracy_costs = bureaucracy_cost_slider_effect }
}

calculate_security_expenditures = {
	set_variable = { admin_security_costs = tno_security_proportional_pop_cost }
	multiply_variable = { admin_security_costs = modifier@admin_program_cost_factor }
	multiply_variable = { admin_security_costs = total_pop_m }

	set_variable = { security_cost_slider_effect = econ_admin_security_slider_pct }
	multiply_variable = { security_cost_slider_effect = 0.8 }
	add_to_variable = { security_cost_slider_effect = 20 }
	divide_variable = { security_cost_slider_effect = 100 }

	multiply_variable = { admin_security_costs = security_cost_slider_effect }
}

calculate_regulations_expenditures = {
	set_variable = { admin_regulations_costs = tno_regulations_policy_cost }
	multiply_variable = { admin_regulations_costs = GDP }
	divide_variable = { admin_regulations_costs = 100 } # So that we never go out of limits

	set_variable = { regulations_cost_slider_effect = econ_admin_regulations_slider_pct }
	multiply_variable = { regulations_cost_slider_effect = 0.8 }
	add_to_variable = { regulations_cost_slider_effect = 20 }
	divide_variable = { regulations_cost_slider_effect = 100 }

	multiply_variable = { admin_regulations_costs = regulations_cost_slider_effect }
}

##Research

calculate_research_expenditures = {
	calculate_research_science_expenditures = yes
	calculate_research_facilities_expenditures = yes

	set_variable = { research_costs = research_science_costs }
	add_to_variable = { research_costs = research_facilities_costs }
}

calculate_research_science_expenditures = {
	set_variable = { research_science_costs = GDP }
	multiply_variable = { research_science_costs = 0.005 }

	multiply_variable = { research_science_costs = econ_research_science_slider_pct }
	divide_variable = { research_science_costs = 100 }

	multiply_variable = { research_science_costs = amount_research_slots }

	set_temp_variable = { research_cost_modifier_calc = 1 }
	add_to_temp_variable = { research_cost_modifier_calc = modifier@research_cost_modifier }
	multiply_variable = { research_science_costs = research_cost_modifier_calc }
}

calculate_research_facilities_expenditures = {
	set_variable = { research_facilities_costs = GDP }
	multiply_variable = { research_facilities_costs = 0.002 }

	multiply_variable = { research_facilities_costs = amount_research_slots }

	multiply_variable = { research_facilities_costs = econ_research_facilities_slider_pct }
	divide_variable = { research_facilities_costs = 100 }
}
calculate_funding_effects = {
	calculate_army_funding_effects = yes
	calculate_naval_funding_effects = yes
	calculate_social_funding_effects = yes
	calculate_research_funding_effects = yes
	calculate_admin_funding_effects = yes
	calculate_nuclear_funding_effects = yes
}

calculate_funding_effects_display = {
	calculate_army_funding_effects_display = yes
	calculate_naval_funding_effects_display = yes
	calculate_social_funding_effects_display = yes
	calculate_research_funding_effects_display = yes
	calculate_admin_funding_effects_display = yes
}

calculate_army_funding_effects_display = {
	calculate_army_maintenance_funding_effects_display = yes
	calculate_army_training_funding_effects_display = yes
	calculate_army_r_d_funding_effects_display = yes
	calculate_army_procurement_effects_display = yes
}

calculate_army_maintenance_funding_effects_display = {
	set_variable = { TNO_army_funding_policy_effect_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_policy_effect_display = 100 }

	set_variable = { TNO_army_funding_army_org_factor_display = 0 }
	add_to_variable = { TNO_army_funding_army_org_factor_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_army_org_factor_display = 325 }

	set_variable = { TNO_army_funding_army_morale_factor_display = 0 }
	add_to_variable = { TNO_army_funding_army_morale_factor_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_army_morale_factor_display = 250 }

	set_variable = { TNO_army_funding_war_support_factor_display = 0 }
	add_to_variable = { TNO_army_funding_war_support_factor_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_war_support_factor_display = 400 }

	set_variable = { TNO_army_funding_stability_factor_display = 0 }
	add_to_variable = { TNO_army_funding_stability_factor_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_stability_factor_display = 400 }

	set_variable = { TNO_army_funding_army_professionalism_change_display = 0 }
	add_to_variable = { TNO_army_funding_army_professionalism_change_display = econ_army_maintenance_slider_pct }
	divide_variable = { TNO_army_funding_army_professionalism_change_display = 500 }

	set_variable = { TNO_army_training_policy_effectiveness_effect_display = tno_training_effectiveness }
	multiply_variable = { TNO_army_training_policy_effectiveness_effect_display = TNO_army_funding_policy_effect_display }
	#subtract_from_variable = { TNO_army_training_policy_effectiveness_effect_display = tno_training_effectiveness }
	divide_variable = { TNO_army_training_policy_effectiveness_effect_display = 100 } # for display purposes.
}

calculate_army_training_funding_effects_display = {
	set_variable = { TNO_army_training_funding_terrain_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_terrain_effect_display = 500 }

	set_variable = { TNO_army_training_funding_upkeep_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_upkeep_effect_display = -500 }

	set_variable = { TNO_army_training_funding_supply_grace_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_supply_grace_effect_display = 5 }

	set_variable = { TNO_army_training_funding_supply_use_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_supply_use_effect_display = -500 }

	set_variable = { TNO_army_training_funding_org_loss_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_org_loss_effect_display = -500 }

	set_variable = { TNO_army_training_funding_air_range_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_air_range_effect_display = 500 }

	set_variable = { TNO_army_training_funding_no_supply_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_no_supply_effect_display = 500 }
	multiply_variable = { TNO_army_training_funding_no_supply_effect_display = -1 }

	set_variable = { TNO_army_training_funding_encircled_effect_display = econ_army_logistics_slider_pct }
	divide_variable = { TNO_army_training_funding_encircled_effect_display = 500 }
	multiply_variable = { TNO_army_training_funding_encircled_effect_display = -1 }
}

calculate_army_r_d_funding_effects_display = {
	set_variable = { army_idea_number = econ_army_r_d_slider_pct }
	round_variable = army_idea_number

	set_variable = { army_research_bonus_number_display = army_idea_number }
	divide_variable = { army_research_bonus_number_display = 5 }
	divide_variable = { army_research_bonus_number_display = 100 }

	set_variable = { TNO_army_funding_army_xp_display = 0 }
	add_to_variable = { TNO_army_funding_army_xp_display = econ_army_r_d_slider_pct }
	divide_variable = { TNO_army_funding_army_xp_display = 500 }

	set_variable = { TNO_army_funding_air_xp_display = 0 }
	add_to_variable = { TNO_army_funding_air_xp_display = econ_army_r_d_slider_pct }
	divide_variable = { TNO_army_funding_air_xp_display = 500 }

}

calculate_army_procurement_effects_display = {
	set_variable = { TNO_army_procurement_funding_effect_display = econ_army_procurement_slider_pct }
	subtract_from_variable = { TNO_army_procurement_funding_effect_display = 50 }
	divide_variable = { TNO_army_procurement_funding_effect_display = 100 }
}

calculate_naval_funding_effects_display = {

	set_variable = { naval_funding_effects_display = econ_naval_expenditures_slider_pct }
	divide_variable = { naval_funding_effects_display = 100 }

	set_variable = { naval_funding_other_effects_display = 0 }
	add_to_variable = { naval_funding_other_effects_display = econ_naval_expenditures_slider_pct }
	divide_variable = { naval_funding_other_effects_display = 500 }

	set_variable = { TNO_naval_funding_navy_xp_display = 0 }
	add_to_variable = { TNO_naval_funding_navy_xp_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_navy_xp_display = 500 }

	set_variable = { TNO_naval_funding_industrial_capacity_dockyard_display = 0 }
	add_to_variable = { TNO_naval_funding_industrial_capacity_dockyard_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_industrial_capacity_dockyard_display = 650 }

	set_variable = { TNO_naval_funding_naval_coordination_display = 0 }
	add_to_variable = { TNO_naval_funding_naval_coordination_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_naval_coordination_display = 500 }

	set_variable = { TNO_naval_funding_naval_speed_factor_display = 0 }
	add_to_variable = { TNO_naval_funding_naval_speed_factor_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_naval_speed_factor_display = 650 }

	set_variable = { TNO_naval_funding_navy_max_range_factor_display = 0 }
	add_to_variable = { TNO_naval_funding_navy_max_range_factor_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_navy_max_range_factor_display = 500 }

	set_variable = { TNO_naval_funding_spotting_chance_display = 0 }
	add_to_variable = { TNO_naval_funding_spotting_chance_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_spotting_chance_display = 650 }

	set_variable = { TNO_naval_funding_war_support_factor_display = 0 }
	add_to_variable = { TNO_naval_funding_war_support_factor_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_war_support_factor_display = 800 }

	set_variable = { TNO_naval_funding_stability_factor_display = 0 }
	add_to_variable = { TNO_naval_funding_stability_factor_display = econ_naval_expenditures_slider_pct }
	divide_variable = { TNO_naval_funding_stability_factor_display = 800 }
}

calculate_social_funding_effects_display = {

	set_variable = { TNO_social_funding_policy_effect_display = econ_social_expenditures_slider_pct }
	divide_variable = { TNO_social_funding_policy_effect_display = 100 }

	calculate_social_healthcare_funding_effects_display = yes

	calculate_social_education_funding_effects_display = yes

	calculate_social_pensions_funding_effects_display = yes

	calculate_social_unemployment_funding_effects_display = yes
}

calculate_social_healthcare_funding_effects_display = {
	set_variable = { TNO_health_care_funding_effect_display = econ_social_healthcare_slider_pct }
	divide_variable = { TNO_health_care_funding_effect_display = 100 }

	set_variable = { TNO_health_care_funding_effectiveness_display = tno_health_care_effectiveness }
	multiply_variable = { TNO_health_care_funding_effectiveness_display = TNO_health_care_funding_effect_display }
	divide_variable = { TNO_health_care_funding_effectiveness_display = 100 }
}

calculate_social_education_funding_effects_display = {
	set_variable = { TNO_education_funding_effect_display = econ_social_education_slider_pct }
	divide_variable = { TNO_education_funding_effect_display = 100 }

	set_variable = { TNO_education_funding_effectiveness_display = tno_education_effectiveness }
	multiply_variable = { TNO_education_funding_effectiveness_display = TNO_education_funding_effect_display }
	divide_variable = { TNO_education_funding_effectiveness_display = 100 }
}

calculate_social_pensions_funding_effects_display = {
	set_variable = { TNO_pensions_funding_effect_display = econ_social_pensions_slider_pct }
	divide_variable = { TNO_pensions_funding_effect_display = 100 }

	set_variable = { TNO_pensions_funding_effectiveness_display = tno_pensions_effectiveness }
	multiply_variable = { TNO_pensions_funding_effectiveness_display = TNO_pensions_funding_effect_display }
	divide_variable = { TNO_pensions_funding_effectiveness_display = 100 }
}

calculate_social_unemployment_funding_effects_display = {
	set_variable = { TNO_unemployment_funding_effect_display = econ_social_unemployment_slider_pct }
	divide_variable = { TNO_unemployment_funding_effect_display = 100 }
	clamp_variable = { var = TNO_unemployment_funding_effect_display min = 0 max = 1 }

	set_variable = { TNO_unemployment_funding_effectiveness_display = tno_unemployment_effectiveness }
	multiply_variable = { TNO_unemployment_funding_effectiveness_display = TNO_unemployment_funding_effect_display }
	divide_variable = { TNO_unemployment_funding_effectiveness_display = 100 }
}

calculate_admin_funding_effects_display = {

	set_variable = { TNO_admin_funding_policy_effect_display = econ_admin_expenditures_slider_pct }
	divide_variable = { TNO_admin_funding_policy_effect_display = 100 }

	calculate_admin_bureaucracy_funding_effects_display = yes

	calculate_admin_security_funding_effects_display = yes

	calculate_admin_regulations_funding_effects_display = yes

}

calculate_admin_security_funding_effects_display = {
	set_variable = { TNO_security_funding_effect_display = econ_admin_security_slider_pct }
	divide_variable = { TNO_security_funding_effect_display = 100 }

	set_variable = { TNO_security_funding_effectiveness_display = tno_security_effectiveness }
	multiply_variable = { TNO_security_funding_effectiveness_display = TNO_security_funding_effect_display }
	divide_variable = { TNO_security_funding_effectiveness_display = 100 }
}

calculate_admin_regulations_funding_effects_display = {
	set_variable = { TNO_regulations_funding_effect_display = econ_admin_regulations_slider_pct }
	divide_variable = { TNO_regulations_funding_effect_display = 100 }

	set_variable = { TNO_regulations_funding_effectiveness_display = tno_regulations_effectiveness }
	multiply_variable = { TNO_regulations_funding_effectiveness_display = TNO_regulations_funding_effect_display }
	divide_variable = { TNO_regulations_funding_effectiveness_display = 100 }
}

calculate_admin_bureaucracy_funding_effects_display = {
	set_variable = { TNO_admin_funding_bureaucracy_effect = econ_admin_bureaucracy_slider_pct }
	divide_variable = { TNO_admin_funding_bureaucracy_effect = 100 }

	set_variable = { TNO_admin_funding_taxable_population_factor_display = 0 }
	add_to_variable = { TNO_admin_funding_taxable_population_factor_display = econ_admin_bureaucracy_slider_pct }
	divide_variable = { TNO_admin_funding_taxable_population_factor_display = 600 }

	set_variable = { TNO_admin_funding_stability_factor_display = 0 }
	add_to_variable = { TNO_admin_funding_stability_factor_display = econ_admin_bureaucracy_slider_pct }
	divide_variable = { TNO_admin_funding_stability_factor_display = 400 }

}

calculate_research_funding_effects_display = {
	calculate_research_science_funding_effects_display = yes
	calculate_research_facilities_funding_effects_display = yes
}

calculate_research_science_funding_effects_display = {
	set_variable = { TNO_research_funding_research_speed_factor_display = econ_research_science_slider_pct }
	divide_variable = { TNO_research_funding_research_speed_factor_display = 500 }
}

calculate_research_facilities_funding_effects_display = {
	set_variable = { TNO_research_funding_facilities_effect_display = econ_research_facilities_slider_pct }
	divide_variable = { TNO_research_funding_facilities_effect_display = 33.333 }
}

# Actual initialization of these is done in on_startup_actions
reset_econ_sliders = {
	set_variable = { econ_army_expenditures_slider_pct = 50 }
	set_variable = { econ_naval_expenditures_slider_pct = 50 }
	set_variable = { econ_research_expenditures_slider_pct = 50 }
	set_variable = { econ_social_expenditures_slider_pct = 50 }
	set_variable = { econ_admin_expenditures_slider_pct = 50 }
	set_variable = { econ_nuclear_expenditures_slider_pct = 50 }

	set_variable = { econ_army_expenditures_minimal_pct = 25 }
	set_variable = { econ_army_expenditures_maximal_pct = 75 }

	set_variable = { econ_naval_expenditures_minimal_pct = 25 }
	set_variable = { econ_naval_expenditures_maximal_pct = 75 }

	set_variable = { econ_nuclear_expenditures_minimal_pct = 25 }
	set_variable = { econ_nuclear_expenditures_maximal_pct = 75 }

	set_variable = { econ_research_expenditures_minimal_pct = 25 }
	set_variable = { econ_research_expenditures_maximal_pct = 75 }

	set_variable = { econ_social_expenditures_minimal_pct = 25 }
	set_variable = { econ_social_expenditures_maximal_pct = 75 }

	set_variable = { econ_admin_expenditures_minimal_pct = 25 }
	set_variable = { econ_admin_expenditures_maximal_pct = 75 }

	set_variable = { econ_deficit_monetization_minimal_pct = 0 }
	set_variable = { econ_deficit_monetization_maximal_pct = 100 }
	set_variable = { econ_deficit_monetization_slider_pct = 0 }

	update_economy_tab = yes
}

update_econ_sliders = {

	# Deficit Monetization
	clamp_variable = { var = econ_deficit_monetization_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_deficit_monetization_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_deficit_monetization_slider_pct min = econ_deficit_monetization_minimal_pct max = econ_deficit_monetization_maximal_pct }

	set_variable = { econ_deficit_monetization_slider_dot_x = econ_deficit_monetization_slider_pct }
	multiply_variable = { econ_deficit_monetization_slider_dot_x = 1.88 }
	add_to_variable = { econ_deficit_monetization_slider_dot_x = 45 }
	set_variable = { econ_deficit_monetization_minimal_x = econ_deficit_monetization_minimal_pct }
	multiply_variable = { econ_deficit_monetization_minimal_x = 1.88 }
	add_to_variable = { econ_deficit_monetization_minimal_x = 45 }
	set_variable = { econ_deficit_monetization_maximal_x = econ_deficit_monetization_maximal_pct }
	multiply_variable = { econ_deficit_monetization_maximal_x = 1.88 }
	add_to_variable = { econ_deficit_monetization_maximal_x = 42 }



	clamp_variable = { var = econ_army_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_expenditures_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_naval_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_naval_expenditures_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_nuclear_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_nuclear_expenditures_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_expenditures_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_research_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_research_expenditures_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_expenditures_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_expenditures_maximal_pct min = 0 max = 100 }


	clamp_variable = { var = econ_army_maintenance_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_R_D_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_logistics_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_procurement_minimal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_social_healthcare_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_pensions_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_education_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_unemployment_minimal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_admin_security_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_regulations_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_pollution_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_bureaucracy_minimal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_research_science_minimal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_research_facilities_minimal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_army_maintenance_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_R_D_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_logistics_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_army_procurement_maximal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_social_healthcare_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_pensions_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_education_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_social_unemployment_maximal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_admin_security_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_regulations_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_pollution_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_admin_bureaucracy_maximal_pct min = 0 max = 100 }

	clamp_variable = { var = econ_research_science_maximal_pct min = 0 max = 100 }
	clamp_variable = { var = econ_research_facilities_maximal_pct min = 0 max = 100 }

	# Army
	clamp_variable = { var = econ_army_expenditures_slider_pct min = econ_army_expenditures_minimal_pct max = econ_army_expenditures_maximal_pct }

	set_variable = { econ_army_expenditures_slider_dot_x = econ_army_expenditures_slider_pct }
	multiply_variable = { econ_army_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_army_expenditures_slider_dot_x = 45 }
	set_variable = { econ_army_expenditures_minimal_x = econ_army_expenditures_minimal_pct }
	multiply_variable = { econ_army_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_army_expenditures_minimal_x = 45 }
	set_variable = { econ_army_expenditures_maximal_x = econ_army_expenditures_maximal_pct }
	multiply_variable = { econ_army_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_army_expenditures_maximal_x = 42 }

	set_variable = { econ_army_expenditures_slider_value = econ_army_expenditures_slider_pct }
	divide_variable = { econ_army_expenditures_slider_value = 5 }

	# Naval
	clamp_variable = { var = econ_naval_expenditures_slider_pct min = econ_naval_expenditures_minimal_pct max = econ_naval_expenditures_maximal_pct }

	set_variable = { econ_naval_expenditures_slider_dot_x = econ_naval_expenditures_slider_pct }
	multiply_variable = { econ_naval_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_naval_expenditures_slider_dot_x = 45 }
	set_variable = { econ_naval_expenditures_minimal_x = econ_naval_expenditures_minimal_pct }
	multiply_variable = { econ_naval_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_naval_expenditures_minimal_x = 45 }
	set_variable = { econ_naval_expenditures_maximal_x = econ_naval_expenditures_maximal_pct }
	multiply_variable = { econ_naval_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_naval_expenditures_maximal_x = 42 }

	set_variable = { econ_naval_expenditures_slider_value = econ_naval_expenditures_slider_pct }
	divide_variable = { econ_naval_expenditures_slider_value = 5 }

	# Nuclear (econ_nuclear_expenditures_slider_value ranges from -10 to 10 instead of 0 to 20, why I have no idea)
	clamp_variable = { var = econ_nuclear_expenditures_slider_pct min = econ_nuclear_expenditures_minimal_pct max = econ_nuclear_expenditures_maximal_pct }

	set_variable = { econ_nuclear_expenditures_slider_dot_x = econ_nuclear_expenditures_slider_pct }
	multiply_variable = { econ_nuclear_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_nuclear_expenditures_slider_dot_x = 45 }
	set_variable = { econ_nuclear_expenditures_minimal_x = econ_nuclear_expenditures_minimal_pct }
	multiply_variable = { econ_nuclear_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_nuclear_expenditures_minimal_x = 45 }
	set_variable = { econ_nuclear_expenditures_maximal_x = econ_nuclear_expenditures_maximal_pct }
	multiply_variable = { econ_nuclear_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_nuclear_expenditures_maximal_x = 42 }

	set_variable = { econ_nuclear_expenditures_slider_value = econ_nuclear_expenditures_slider_pct }
	divide_variable = { econ_nuclear_expenditures_slider_value = 5 }
	subtract_from_variable = { econ_nuclear_expenditures_slider_value = 10 }


	# Social
	clamp_variable = { var = econ_social_expenditures_slider_pct min = econ_social_expenditures_minimal_pct max = econ_social_expenditures_maximal_pct }

	set_variable = { econ_social_expenditures_slider_dot_x = econ_social_expenditures_slider_pct }
	multiply_variable = { econ_social_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_social_expenditures_slider_dot_x = 45 }
	set_variable = { econ_social_expenditures_minimal_x = econ_social_expenditures_minimal_pct }
	multiply_variable = { econ_social_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_social_expenditures_minimal_x = 45 }
	set_variable = { econ_social_expenditures_maximal_x = econ_social_expenditures_maximal_pct }
	multiply_variable = { econ_social_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_social_expenditures_maximal_x = 42 }

	set_variable = { econ_social_expenditures_slider_value = econ_social_expenditures_slider_pct }
	divide_variable = { econ_social_expenditures_slider_value = 5 }

	# Admin
	clamp_variable = { var = econ_admin_expenditures_slider_pct min = econ_admin_expenditures_minimal_pct max = econ_admin_expenditures_maximal_pct }

	set_variable = { econ_admin_expenditures_slider_dot_x = econ_admin_expenditures_slider_pct }
	multiply_variable = { econ_admin_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_admin_expenditures_slider_dot_x = 45 }
	set_variable = { econ_admin_expenditures_minimal_x = econ_admin_expenditures_minimal_pct }
	multiply_variable = { econ_admin_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_admin_expenditures_minimal_x = 45 }
	set_variable = { econ_admin_expenditures_maximal_x = econ_admin_expenditures_maximal_pct }
	multiply_variable = { econ_admin_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_admin_expenditures_maximal_x = 42 }

	# Research
	clamp_variable = { var = econ_research_expenditures_slider_pct min = econ_research_expenditures_minimal_pct max = econ_research_expenditures_maximal_pct }

	set_variable = { econ_research_expenditures_slider_dot_x = econ_research_expenditures_slider_pct }
	multiply_variable = { econ_research_expenditures_slider_dot_x = 1.88 }
	add_to_variable = { econ_research_expenditures_slider_dot_x = 45 }
	set_variable = { econ_research_expenditures_minimal_x = econ_research_expenditures_minimal_pct }
	multiply_variable = { econ_research_expenditures_minimal_x = 1.88 }
	add_to_variable = { econ_research_expenditures_minimal_x = 45 }
	set_variable = { econ_research_expenditures_maximal_x = econ_research_expenditures_maximal_pct }
	multiply_variable = { econ_research_expenditures_maximal_x = 1.88 }
	add_to_variable = { econ_research_expenditures_maximal_x = 42 }


	########## Army maintenance (uses base values from army funding)
	set_variable = { econ_army_maintenance_minimal_pct = econ_army_expenditures_minimal_pct }
	set_variable = { econ_army_maintenance_maximal_pct = econ_army_expenditures_maximal_pct }

	clamp_variable = { var = econ_army_maintenance_slider_pct min = econ_army_maintenance_minimal_pct max = econ_army_maintenance_maximal_pct }

	set_variable = { econ_army_maintenance_slider_dot_x = econ_army_maintenance_slider_pct }
	multiply_variable = { econ_army_maintenance_slider_dot_x = 1.88 }
	add_to_variable = { econ_army_maintenance_slider_dot_x = 45 }
	set_variable = { econ_army_maintenance_minimal_x = econ_army_maintenance_minimal_pct }
	multiply_variable = { econ_army_maintenance_minimal_x = 1.88 }
	add_to_variable = { econ_army_maintenance_minimal_x = 45 }
	set_variable = { econ_army_maintenance_maximal_x = econ_army_maintenance_maximal_pct }
	multiply_variable = { econ_army_maintenance_maximal_x = 1.88 }
	add_to_variable = { econ_army_maintenance_maximal_x = 42 }

	set_variable = { econ_army_maintenance_slider_value = econ_army_maintenance_slider_pct }
	divide_variable = { econ_army_maintenance_slider_value = 5 }


	########## Army R&D (uses base minmax from army funding)

	set_variable = { econ_army_R_D_minimal_pct = econ_army_expenditures_minimal_pct }
	set_variable = { econ_army_R_D_maximal_pct = econ_army_expenditures_maximal_pct }

	clamp_variable = { var = econ_army_R_D_slider_pct min = econ_army_R_D_minimal_pct max = econ_army_R_D_maximal_pct }

	set_variable = { econ_army_R_D_slider_dot_x = econ_army_R_D_slider_pct }
	multiply_variable = { econ_army_R_D_slider_dot_x = 1.88 }
	add_to_variable = { econ_army_R_D_slider_dot_x = 45 }
	set_variable = { econ_army_R_D_minimal_x = econ_army_R_D_minimal_pct }
	multiply_variable = { econ_army_R_D_minimal_x = 1.88 }
	add_to_variable = { econ_army_R_D_minimal_x = 45 }
	set_variable = { econ_army_R_D_maximal_x = econ_army_R_D_maximal_pct }
	multiply_variable = { econ_army_R_D_maximal_x = 1.88 }
	add_to_variable = { econ_army_R_D_maximal_x = 42 }

	set_variable = { econ_army_R_D_slider_value = econ_army_R_D_slider_pct }
	divide_variable = { econ_army_R_D_slider_value = 5 }


	########## Army training (uses base minmax from army funding

	set_variable = { econ_army_logistics_minimal_pct = econ_army_expenditures_minimal_pct }
	set_variable = { econ_army_logistics_maximal_pct = econ_army_expenditures_maximal_pct }

	clamp_variable = { var = econ_army_logistics_slider_pct min = econ_army_logistics_minimal_pct max = econ_army_logistics_maximal_pct }

	set_variable = { econ_army_logistics_slider_dot_x = econ_army_logistics_slider_pct }
	multiply_variable = { econ_army_logistics_slider_dot_x = 1.88 }
	add_to_variable = { econ_army_logistics_slider_dot_x = 45 }
	set_variable = { econ_army_logistics_minimal_x = econ_army_logistics_minimal_pct }
	multiply_variable = { econ_army_logistics_minimal_x = 1.88 }
	add_to_variable = { econ_army_logistics_minimal_x = 45 }
	set_variable = { econ_army_logistics_maximal_x = econ_army_logistics_maximal_pct }
	multiply_variable = { econ_army_logistics_maximal_x = 1.88 }
	add_to_variable = { econ_army_logistics_maximal_x = 42 }

	set_variable = { econ_army_logistics_slider_value = econ_army_logistics_slider_pct }
	divide_variable = { econ_army_logistics_slider_value = 5 }


	########## Supervision (actually Procurement)

	set_variable = { econ_army_procurement_minimal_pct = econ_army_expenditures_minimal_pct }
	set_variable = { econ_army_procurement_maximal_pct = econ_army_expenditures_maximal_pct }

	clamp_variable = { var = econ_army_procurement_slider_pct min = econ_army_procurement_minimal_pct max = econ_army_procurement_maximal_pct }

	set_variable = { econ_army_procurement_slider_dot_x = econ_army_procurement_slider_pct }
	multiply_variable = { econ_army_procurement_slider_dot_x = 1.88 }
	add_to_variable = { econ_army_procurement_slider_dot_x = 45 }
	set_variable = { econ_army_procurement_minimal_x = econ_army_procurement_minimal_pct }
	multiply_variable = { econ_army_procurement_minimal_x = 1.88 }
	add_to_variable = { econ_army_procurement_minimal_x = 45 }
	set_variable = { econ_army_procurement_maximal_x = econ_army_procurement_maximal_pct }
	multiply_variable = { econ_army_procurement_maximal_x = 1.88 }
	add_to_variable = { econ_army_procurement_maximal_x = 42 }

	set_variable = { econ_army_procurement_slider_value = econ_army_procurement_slider_pct }
	divide_variable = { econ_army_procurement_slider_value = 5 }


	########## Healthcare crap

	set_variable = { econ_social_healthcare_minimal_pct = econ_social_expenditures_minimal_pct }
	set_variable = { econ_social_healthcare_maximal_pct = econ_social_expenditures_maximal_pct }

	clamp_variable = { var = econ_social_healthcare_slider_pct min = econ_social_healthcare_minimal_pct max = econ_social_healthcare_maximal_pct }

	set_variable = { econ_social_healthcare_slider_dot_x = econ_social_healthcare_slider_pct }
	multiply_variable = { econ_social_healthcare_slider_dot_x = 1.88 }
	add_to_variable = { econ_social_healthcare_slider_dot_x = 45 }
	set_variable = { econ_social_healthcare_minimal_x = econ_social_healthcare_minimal_pct }
	multiply_variable = { econ_social_healthcare_minimal_x = 1.88 }
	add_to_variable = { econ_social_healthcare_minimal_x = 45 }
	set_variable = { econ_social_healthcare_maximal_x = econ_social_healthcare_maximal_pct }
	multiply_variable = { econ_social_healthcare_maximal_x = 1.88 }
	add_to_variable = { econ_social_healthcare_maximal_x = 42 }

	set_variable = { econ_social_healthcare_slider_value = econ_social_healthcare_slider_pct }
	divide_variable = { econ_social_healthcare_slider_value = 5 }


	########## Pensions crap
	set_variable = { econ_social_pensions_minimal_pct = econ_social_expenditures_minimal_pct }
	set_variable = { econ_social_pensions_maximal_pct = econ_social_expenditures_maximal_pct }

	clamp_variable = { var = econ_social_pensions_slider_pct min = econ_social_pensions_minimal_pct max = econ_social_pensions_maximal_pct }

	set_variable = { econ_social_pensions_slider_dot_x = econ_social_pensions_slider_pct }
	multiply_variable = { econ_social_pensions_slider_dot_x = 1.88 }
	add_to_variable = { econ_social_pensions_slider_dot_x = 45 }
	set_variable = { econ_social_pensions_minimal_x = econ_social_pensions_minimal_pct }
	multiply_variable = { econ_social_pensions_minimal_x = 1.88 }
	add_to_variable = { econ_social_pensions_minimal_x = 45 }
	set_variable = { econ_social_pensions_maximal_x = econ_social_pensions_maximal_pct }
	multiply_variable = { econ_social_pensions_maximal_x = 1.88 }
	add_to_variable = { econ_social_pensions_maximal_x = 42 }

	set_variable = { econ_social_pensions_slider_value = econ_social_pensions_slider_pct }
	divide_variable = { econ_social_pensions_slider_value = 5 }
	########## Education crap
	set_variable = { econ_social_education_minimal_pct = econ_social_expenditures_minimal_pct }
	set_variable = { econ_social_education_maximal_pct = econ_social_expenditures_maximal_pct }

	clamp_variable = { var = econ_social_education_slider_pct min = econ_social_education_minimal_pct max = econ_social_education_maximal_pct }

	set_variable = { econ_social_education_slider_dot_x = econ_social_education_slider_pct }
	multiply_variable = { econ_social_education_slider_dot_x = 1.88 }
	add_to_variable = { econ_social_education_slider_dot_x = 45 }
	set_variable = { econ_social_education_minimal_x = econ_social_education_minimal_pct }
	multiply_variable = { econ_social_education_minimal_x = 1.88 }
	add_to_variable = { econ_social_education_minimal_x = 45 }
	set_variable = { econ_social_education_maximal_x = econ_social_education_maximal_pct }
	multiply_variable = { econ_social_education_maximal_x = 1.88 }
	add_to_variable = { econ_social_education_maximal_x = 42 }

	set_variable = { econ_social_education_slider_value = econ_social_education_slider_pct }
	divide_variable = { econ_social_education_slider_value = 5 }
	########## Unemployment crap
	set_variable = { econ_social_unemployment_minimal_pct = econ_social_expenditures_minimal_pct }
	set_variable = { econ_social_unemployment_maximal_pct = econ_social_expenditures_maximal_pct }

	clamp_variable = { var = econ_social_unemployment_slider_pct min = econ_social_unemployment_minimal_pct max = econ_social_unemployment_maximal_pct }

	set_variable = { econ_social_unemployment_slider_dot_x = econ_social_unemployment_slider_pct }
	multiply_variable = { econ_social_unemployment_slider_dot_x = 1.88 }
	add_to_variable = { econ_social_unemployment_slider_dot_x = 45 }
	set_variable = { econ_social_unemployment_minimal_x = econ_social_unemployment_minimal_pct }
	multiply_variable = { econ_social_unemployment_minimal_x = 1.88 }
	add_to_variable = { econ_social_unemployment_minimal_x = 45 }
	set_variable = { econ_social_unemployment_maximal_x = econ_social_unemployment_maximal_pct }
	multiply_variable = { econ_social_unemployment_maximal_x = 1.88 }
	add_to_variable = { econ_social_unemployment_maximal_x = 42 }

	set_variable = { econ_social_unemployment_slider_value = econ_social_unemployment_slider_pct }
	divide_variable = { econ_social_unemployment_slider_value = 5 }

	########## Security crap
	set_variable = { econ_admin_security_minimal_pct = econ_admin_expenditures_minimal_pct }
	set_variable = { econ_admin_security_maximal_pct = econ_admin_expenditures_maximal_pct }
	set_temp_variable = { econ_admin_security_maximal_pct_multiplier = 1 }
	add_to_temp_variable = { econ_admin_security_maximal_pct_multiplier = modifier@econ_admin_security_maximal_pct_modifier }
	multiply_variable = { econ_admin_security_maximal_pct = econ_admin_security_maximal_pct_multiplier }
	clamp_variable = { var = econ_admin_security_maximal_pct min = econ_admin_security_minimal_pct max = 100 }

	clamp_variable = { var = econ_admin_security_slider_pct min = econ_admin_security_minimal_pct max = econ_admin_security_maximal_pct }

	set_variable = { econ_admin_security_slider_dot_x = econ_admin_security_slider_pct }
	multiply_variable = { econ_admin_security_slider_dot_x = 1.88 }
	add_to_variable = { econ_admin_security_slider_dot_x = 45 }
	set_variable = { econ_admin_security_minimal_x = econ_admin_security_minimal_pct }
	multiply_variable = { econ_admin_security_minimal_x = 1.88 }
	add_to_variable = { econ_admin_security_minimal_x = 45 }
	set_variable = { econ_admin_security_maximal_x = econ_admin_security_maximal_pct }
	multiply_variable = { econ_admin_security_maximal_x = 1.88 }
	add_to_variable = { econ_admin_security_maximal_x = 42 }

	set_variable = { econ_admin_security_slider_value = econ_admin_security_slider_pct }
	divide_variable = { econ_admin_security_slider_value = 5 }
	########## Safety crap
	set_variable = { econ_admin_regulations_minimal_pct = econ_admin_expenditures_minimal_pct }
	set_variable = { econ_admin_regulations_maximal_pct = econ_admin_expenditures_maximal_pct }
	set_temp_variable = { econ_admin_regulations_maximal_pct_multiplier = 1 }
	add_to_temp_variable = { econ_admin_regulations_maximal_pct_multiplier = modifier@econ_admin_regulations_maximal_pct_modifier }
	multiply_variable = { econ_admin_regulations_maximal_pct = econ_admin_regulations_maximal_pct_multiplier }
	clamp_variable = { var = econ_admin_regulations_maximal_pct min = econ_admin_regulations_minimal_pct max = 100 }

	clamp_variable = { var = econ_admin_regulations_slider_pct min = econ_admin_regulations_minimal_pct max = econ_admin_regulations_maximal_pct }

	set_variable = { econ_admin_regulations_slider_dot_x = econ_admin_regulations_slider_pct }
	multiply_variable = { econ_admin_regulations_slider_dot_x = 1.88 }
	add_to_variable = { econ_admin_regulations_slider_dot_x = 45 }
	set_variable = { econ_admin_regulations_minimal_x = econ_admin_regulations_minimal_pct }
	multiply_variable = { econ_admin_regulations_minimal_x = 1.88 }
	add_to_variable = { econ_admin_regulations_minimal_x = 45 }
	set_variable = { econ_admin_regulations_maximal_x = econ_admin_regulations_maximal_pct }
	multiply_variable = { econ_admin_regulations_maximal_x = 1.88 }
	add_to_variable = { econ_admin_regulations_maximal_x = 42 }

	set_variable = { econ_admin_regulations_slider_value = econ_admin_regulations_slider_pct }
	divide_variable = { econ_admin_regulations_slider_value = 5 }

	########## Bureau crap
	set_variable = { econ_admin_bureaucracy_minimal_pct = econ_admin_expenditures_minimal_pct }
	set_variable = { econ_admin_bureaucracy_maximal_pct = econ_admin_expenditures_maximal_pct }

	clamp_variable = { var = econ_admin_bureaucracy_slider_pct min = econ_admin_bureaucracy_minimal_pct max = econ_admin_bureaucracy_maximal_pct }

	set_variable = { econ_admin_bureaucracy_slider_dot_x = econ_admin_bureaucracy_slider_pct }
	multiply_variable = { econ_admin_bureaucracy_slider_dot_x = 1.88 }
	add_to_variable = { econ_admin_bureaucracy_slider_dot_x = 45 }
	set_variable = { econ_admin_bureaucracy_minimal_x = econ_admin_bureaucracy_minimal_pct }
	multiply_variable = { econ_admin_bureaucracy_minimal_x = 1.88 }
	add_to_variable = { econ_admin_bureaucracy_minimal_x = 45 }
	set_variable = { econ_admin_bureaucracy_maximal_x = econ_admin_bureaucracy_maximal_pct }
	multiply_variable = { econ_admin_bureaucracy_maximal_x = 1.88 }
	add_to_variable = { econ_admin_bureaucracy_maximal_x = 42 }

	set_variable = { econ_admin_bureaucracy_slider_value = econ_admin_bureaucracy_slider_pct }
	divide_variable = { econ_admin_bureaucracy_slider_value = 5 }

	########## Research crap
	set_variable = { econ_research_science_minimal_pct = econ_research_expenditures_minimal_pct }
	set_variable = { econ_research_science_maximal_pct = econ_research_expenditures_maximal_pct }

	clamp_variable = { var = econ_research_science_slider_pct min = econ_research_science_minimal_pct max = econ_research_science_maximal_pct }

	set_variable = { econ_research_science_slider_dot_x = econ_research_science_slider_pct }
	multiply_variable = { econ_research_science_slider_dot_x = 1.88 }
	add_to_variable = { econ_research_science_slider_dot_x = 45 }
	set_variable = { econ_research_science_minimal_x = econ_research_science_minimal_pct }
	multiply_variable = { econ_research_science_minimal_x = 1.88 }
	add_to_variable = { econ_research_science_minimal_x = 45 }
	set_variable = { econ_research_science_maximal_x = econ_research_science_maximal_pct }
	multiply_variable = { econ_research_science_maximal_x = 1.88 }
	add_to_variable = { econ_research_science_maximal_x = 42 }

	set_variable = { econ_research_science_slider_value = econ_research_science_slider_pct }
	divide_variable = { econ_research_science_slider_value = 5 }
	########## Facilities crap
	set_variable = { econ_research_facilities_minimal_pct = econ_research_expenditures_minimal_pct }
	set_variable = { econ_research_facilities_maximal_pct = econ_research_expenditures_maximal_pct }

	clamp_variable = { var = econ_research_facilities_slider_pct min = econ_research_facilities_minimal_pct max = econ_research_facilities_maximal_pct }

	set_variable = { econ_research_facilities_slider_dot_x = econ_research_facilities_slider_pct }
	multiply_variable = { econ_research_facilities_slider_dot_x = 1.88 }
	add_to_variable = { econ_research_facilities_slider_dot_x = 45 }
	set_variable = { econ_research_facilities_minimal_x = econ_research_facilities_minimal_pct }
	multiply_variable = { econ_research_facilities_minimal_x = 1.88 }
	add_to_variable = { econ_research_facilities_minimal_x = 45 }
	set_variable = { econ_research_facilities_maximal_x = econ_research_facilities_maximal_pct }
	multiply_variable = { econ_research_facilities_maximal_x = 1.88 }
	add_to_variable = { econ_research_facilities_maximal_x = 42 }

	set_variable = { econ_research_facilities_slider_value = econ_research_facilities_slider_pct }
	divide_variable = { econ_research_facilities_slider_value = 5 }

}

update_army_subsliders = {
	set_variable = { econ_army_maintenance_slider_pct = econ_army_expenditures_slider_pct }
	set_variable = { econ_army_R_D_slider_pct = econ_army_expenditures_slider_pct }
	set_variable = { econ_army_logistics_slider_pct = econ_army_expenditures_slider_pct }
	set_variable = { econ_army_procurement_slider_pct = econ_army_expenditures_slider_pct }
}

update_army_mainslider = {

	clamp_variable = { var = econ_army_maintenance_slider_pct min = econ_army_expenditures_minimal_pct max = econ_army_expenditures_maximal_pct }
	clamp_variable = { var = econ_army_R_D_slider_pct min = econ_army_expenditures_minimal_pct max = econ_army_expenditures_maximal_pct }
	clamp_variable = { var = econ_army_logistics_slider_pct min = econ_army_expenditures_minimal_pct max = econ_army_expenditures_maximal_pct }
	clamp_variable = { var = econ_army_procurement_slider_pct min = econ_army_expenditures_minimal_pct max = econ_army_expenditures_maximal_pct }

	set_temp_variable = { econ_army_average_spending = econ_army_maintenance_slider_pct }
	add_to_temp_variable = { econ_army_average_spending = econ_army_R_D_slider_pct }
	add_to_temp_variable = { econ_army_average_spending = econ_army_logistics_slider_pct }
	add_to_temp_variable = { econ_army_average_spending = econ_army_procurement_slider_pct }
	divide_temp_variable = { econ_army_average_spending = 4 }
	round_temp_variable = econ_army_average_spending

	set_variable = { econ_army_expenditures_slider_pct = econ_army_average_spending }
}

update_social_subsliders = {
	set_variable = { econ_social_healthcare_slider_pct = econ_social_expenditures_slider_pct }
	set_variable = { econ_social_pensions_slider_pct = econ_social_expenditures_slider_pct }
	set_variable = { econ_social_education_slider_pct = econ_social_expenditures_slider_pct }
	set_variable = { econ_social_unemployment_slider_pct = econ_social_expenditures_slider_pct }
}

update_social_mainslider = {

	clamp_variable = { var = econ_social_healthcare_slider_pct min = econ_social_expenditures_minimal_pct max = econ_social_expenditures_maximal_pct }
	clamp_variable = { var = econ_social_pensions_slider_pct min = econ_social_expenditures_minimal_pct max = econ_social_expenditures_maximal_pct }
	clamp_variable = { var = econ_social_education_slider_pct min = econ_social_expenditures_minimal_pct max = econ_social_expenditures_maximal_pct }
	clamp_variable = { var = econ_social_unemployment_slider_pct min = econ_social_expenditures_minimal_pct max = econ_social_expenditures_maximal_pct }


	set_temp_variable = { econ_social_average_spending = econ_social_healthcare_slider_pct }
	add_to_temp_variable = { econ_social_average_spending = econ_social_pensions_slider_pct }
	add_to_temp_variable = { econ_social_average_spending = econ_social_education_slider_pct }
	add_to_temp_variable = { econ_social_average_spending = econ_social_unemployment_slider_pct }

	divide_temp_variable = { econ_social_average_spending = 4 }
	round_temp_variable = econ_social_average_spending

	set_variable = { econ_social_expenditures_slider_pct = econ_social_average_spending }
}

update_admin_subsliders = {
	set_variable = { econ_admin_security_slider_pct = econ_admin_expenditures_slider_pct }
	set_variable = { econ_admin_regulations_slider_pct = econ_admin_expenditures_slider_pct }
	set_variable = { econ_admin_bureaucracy_slider_pct = econ_admin_expenditures_slider_pct }
}

update_admin_mainslider = {

	clamp_variable = { var = econ_admin_security_slider_pct min = econ_admin_expenditures_minimal_pct max = econ_admin_security_maximal_pct }
	clamp_variable = { var = econ_admin_regulations_slider_pct min = econ_admin_expenditures_minimal_pct max = econ_admin_regulations_maximal_pct }
	clamp_variable = { var = econ_admin_bureaucracy_slider_pct min = econ_admin_expenditures_minimal_pct max = econ_admin_expenditures_maximal_pct }


	set_temp_variable = { econ_admin_average_spending = econ_admin_security_slider_pct }
	add_to_temp_variable = { econ_admin_average_spending = econ_admin_regulations_slider_pct }
	add_to_temp_variable = { econ_admin_average_spending = econ_admin_bureaucracy_slider_pct }

	divide_temp_variable = { econ_admin_average_spending = 3 }
	round_temp_variable = econ_admin_average_spending

	clamp_variable = { var = econ_admin_average_spending min = econ_admin_expenditures_minimal_pct max = econ_admin_expenditures_maximal_pct }

	set_variable = { econ_admin_expenditures_slider_pct = econ_admin_average_spending }
}

update_research_subsliders = {
	set_variable = { econ_research_science_slider_pct = econ_research_expenditures_slider_pct }
	set_variable = { econ_research_facilities_slider_pct = econ_research_expenditures_slider_pct }
}

update_research_mainslider = {
	clamp_variable = { var = econ_research_science_slider_pct min = econ_research_expenditures_minimal_pct max = econ_research_expenditures_maximal_pct }
	clamp_variable = { var = econ_research_facilities_slider_pct min = econ_research_expenditures_minimal_pct max = econ_research_expenditures_maximal_pct }

	set_temp_variable = { econ_research_average_spending = econ_research_science_slider_pct }
	add_to_temp_variable = { econ_research_average_spending = econ_research_facilities_slider_pct }

	divide_temp_variable = { econ_research_average_spending = 2 }
	round_variable = econ_research_average_spending

	set_variable = { econ_research_expenditures_slider_pct = econ_research_average_spending }
}


calculate_army_funding_effects = {
	calculate_army_maintenance_funding_effects = yes
	calculate_army_training_funding_effects = yes
	calculate_army_r_d_funding_effects = yes
	calculate_army_procurment_funding_effects = yes
}

calculate_army_maintenance_funding_effects = {
	set_variable = { TNO_army_funding_policy_effect = TNO_army_funding_policy_effect_display }
	set_variable = { TNO_army_funding_army_org_factor = TNO_army_funding_army_org_factor_display }
	set_variable = { TNO_army_funding_army_morale_factor = TNO_army_funding_army_morale_factor_display }
	set_variable = { TNO_army_funding_war_support_factor = TNO_army_funding_war_support_factor_display }
	set_variable = { TNO_army_funding_stability_factor = TNO_army_funding_stability_factor_display }
	set_variable = { TNO_army_funding_army_professionalism_change = TNO_army_funding_army_professionalism_change_display }
}

calculate_army_training_funding_effects = {
	set_variable = { TNO_army_training_funding_terrain_effect = TNO_army_training_funding_terrain_effect_display }
	set_variable = { TNO_army_training_funding_upkeep_effect = TNO_army_training_funding_upkeep_effect_display }
	set_variable = { TNO_army_training_funding_supply_grace_effect = TNO_army_training_funding_supply_grace_effect_display }
	set_variable = { TNO_army_training_funding_supply_use_effect = TNO_army_training_funding_supply_use_effect_display }
	set_variable = { TNO_army_training_funding_org_loss_effect = TNO_army_training_funding_org_loss_effect_display }
	set_variable = { TNO_army_training_funding_air_range_effect = TNO_army_training_funding_air_range_effect_display }
	set_variable = { TNO_army_training_funding_no_supply_effect = TNO_army_training_funding_no_supply_effect_display }
	set_variable = { TNO_army_training_funding_encircled_effect = TNO_army_training_funding_encircled_effect_display }
}

calculate_army_r_d_funding_effects = {
	if = {
		limit = { NOT = { check_variable = { army_idea_number = army_idea_number_set } } }

		meta_effect = {
			text = {
				add_ideas = TNO_ECON_ARMY_IDEA_SPAM_[IDEA_NUMBER]
			}
			IDEA_NUMBER = "[?army_idea_number|.0]"
		}
		set_variable = { army_idea_number_set = army_idea_number }
	}
	set_variable = { TNO_army_funding_air_xp_effect = TNO_army_funding_air_xp_display }
	set_variable = { TNO_army_funding_army_xp_effect = TNO_army_funding_army_xp_display }

}

calculate_army_procurment_funding_effects = {
	set_variable = { TNO_army_procurement_funding_effect = TNO_army_procurement_funding_effect_display }
}

calculate_naval_funding_effects = {
	if = {
		limit = {
			num_of_naval_factories < 1
			check_variable = { num_ships = 0 }
		}
		set_variable = { econ_naval_expenditures_slider_value = 0 }
		set_variable = { econ_naval_expenditures_slider_pct = 0 }
		set_variable = { econ_naval_expenditures_minimal_pct = 0 }
		set_variable = { econ_naval_expenditures_maximal_pct = 0 }
	}
	else_if = {
		limit = {
			OR = {
				AND = {
					num_of_naval_factories > 0
					check_variable = { num_ships = 0 }
				}
				check_variable = { num_ships > 0 }
			}
			check_variable = { navy_check = 0 }
		}
		set_variable = { econ_naval_expenditures_slider_value = 10 }
		set_variable = { econ_naval_expenditures_slider_pct = 50 }
		set_variable = { econ_naval_expenditures_minimal_pct = 25 }
		set_variable = { econ_naval_expenditures_maximal_pct = 75 }
		set_variable = { navy_check = 1 }
	}
	set_variable = { TNO_naval_funding_navy_xp_effect = TNO_naval_funding_navy_xp_display }
	set_variable = { TNO_naval_funding_industrial_capacity_dockyard = TNO_naval_funding_industrial_capacity_dockyard_display }
	set_variable = { TNO_naval_funding_naval_coordination = TNO_naval_funding_naval_coordination_display }
	set_variable = { TNO_naval_funding_naval_speed_factor = TNO_naval_funding_naval_speed_factor_display }
	set_variable = { TNO_naval_funding_navy_max_range_factor = TNO_naval_funding_navy_max_range_factor_display }
	set_variable = { TNO_naval_funding_spotting_chance = TNO_naval_funding_spotting_chance_display }
	set_variable = { TNO_naval_funding_war_support_factor = TNO_naval_funding_war_support_factor_display }
	set_variable = { TNO_naval_funding_stability_factor = TNO_naval_funding_stability_factor_display }

	calculate_naval_idea_spam = yes
}

calculate_naval_idea_spam = {
	set_variable = { naval_idea_number = econ_naval_expenditures_slider_value }
	round_variable = naval_idea_number
	if = {
		limit = {
			check_variable = { naval_idea_number_set = naval_idea_number }
		}
		#log ="no need to change naval idea for [THIS.GETNAME]"
	}
	else = {
		if = {
			limit = {
				check_variable = { naval_idea_number = 0 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_0
			set_variable = { naval_idea_number_set = 0 }
			set_variable = { naval_bonus_number = 0.2 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 1 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_1
			set_variable = { naval_idea_number_set = 1 }
			set_variable = { naval_bonus_number = 0.18 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 2 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_2
			set_variable = { naval_idea_number_set = 2 }
			set_variable = { naval_bonus_number = 0.16 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 3 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_3
			set_variable = { naval_idea_number_set = 3 }
			set_variable = { naval_bonus_number = 0.14 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 4 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_4
			set_variable = { naval_idea_number_set = 4 }
			set_variable = { naval_bonus_number = 0.12 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 5 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_5
			set_variable = { naval_idea_number_set = 5 }
			set_variable = { naval_bonus_number = 0.1 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 6 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_6
			set_variable = { naval_idea_number_set = 6 }
			set_variable = { naval_bonus_number = 0.08 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 7 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_7
			set_variable = { naval_idea_number_set = 7 }
			set_variable = { naval_bonus_number = 0.06 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 8 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_8
			set_variable = { naval_idea_number_set = 8 }
			set_variable = { naval_bonus_number = 0.04 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 9 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_9
			set_variable = { naval_idea_number_set = 9 }
			set_variable = { naval_bonus_number = 0.02 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 10 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_10
			set_variable = { naval_idea_number_set = 10 }
			set_variable = { naval_bonus_number = 0 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 11 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_11
			set_variable = { naval_idea_number_set = 11 }
			set_variable = { naval_bonus_number = -0.02 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 12 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_12
			set_variable = { naval_idea_number_set = 12 }
			set_variable = { naval_bonus_number = -0.04 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 13 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_13
			set_variable = { naval_idea_number_set = 13 }
			set_variable = { naval_bonus_number = -0.06 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 14 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_14
			set_variable = { naval_idea_number_set = 14 }
			set_variable = { naval_bonus_number = -0.08 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 15 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_15
			set_variable = { naval_idea_number_set = 15 }
			set_variable = { naval_bonus_number = -0.10 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 16 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_16
			set_variable = { naval_idea_number_set = 16 }
			set_variable = { naval_bonus_number = -0.12 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 17 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_17
			set_variable = { naval_idea_number_set = 17 }
			set_variable = { naval_bonus_number = -0.14 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 18 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_18
			set_variable = { naval_idea_number_set = 18 }
			set_variable = { naval_bonus_number = -0.16 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 19 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_19
			set_variable = { naval_idea_number_set = 19 }
			set_variable = { naval_bonus_number = -0.18 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
		else_if = {
			limit = {
				check_variable = { naval_idea_number = 20 }
			}
			add_ideas = TNO_ECON_NAVAL_IDEA_SPAM_20
			set_variable = { naval_idea_number_set = 20 }
			set_variable = { naval_bonus_number = -0.2 }
			set_variable = { naval_bonus_number_inverted = naval_bonus_number }
			multiply_variable = { naval_bonus_number_inverted = -1 }
		}
	}
}
calculate_research_funding_effects = {
	set_variable = { TNO_research_funding_research_speed_factor = TNO_research_funding_research_speed_factor_display }
	set_variable = { TNO_research_funding_facilities_effect = TNO_research_funding_facilities_effect_display }
}

calculate_social_funding_effects = { #It's just that simple! damn I wish it was tho
	set_variable = { TNO_social_funding_policy_effect = TNO_social_funding_policy_effect_display }

	set_variable = { TNO_social_funding_healthcare_effect = TNO_health_care_funding_effect_display }
	set_variable = { TNO_social_funding_education_effect = TNO_education_funding_effect_display }
	set_variable = { TNO_social_funding_pensions_effect = TNO_pensions_funding_effect_display }
	set_variable = { TNO_social_funding_unemployment_effect = TNO_unemployment_funding_effect_display }

}
calculate_admin_funding_effects = {
	set_variable = { TNO_admin_funding_taxable_population_factor = TNO_admin_funding_taxable_population_factor_display }

	set_variable = { TNO_admin_funding_stability_factor = TNO_admin_funding_stability_factor_display }

	set_variable = { TNO_admin_funding_security_effect = TNO_security_funding_effect_display }

	set_variable = { TNO_admin_funding_regulations_effect = TNO_regulations_funding_effect_display }

	set_variable = { TNO_admin_funding_pollution_effect = TNO_pollution_funding_effect_display }

}

calculate_nuclear_funding_effects = {
	if = {
		limit = { has_nuclear_arsenal = no }
		set_variable = { econ_nuclear_expenditures_slider_value = -10 }
		set_variable = { econ_nuclear_expenditures_slider_pct = 0 }
		set_variable = { econ_nuclear_expenditures_minimal_pct = 0 }
		set_variable = { econ_nuclear_expenditures_maximal_pct = 0 }
	}
	else_if = {
		limit = {
			has_nuclear_arsenal = yes
			check_variable = { nuke_check = 0 }
		}
		set_variable = { econ_nuclear_expenditures_slider_value = 0 }
		set_variable = { econ_nuclear_expenditures_slider_pct = 50 }
		set_variable = { econ_nuclear_expenditures_minimal_pct = 25 }
		set_variable = { econ_nuclear_expenditures_maximal_pct = 75 }
		set_variable = { nuke_check = 1 }
	}
}

calculate_military_expenditures = {
	calculate_fielded_manpower = yes # calculates fielded manpower AND costs for army, airforce, and navy
	calculate_army_expenditures = yes # calculates army expenses including tonk and helicopter as well as army aviation
	calculate_naval_expenditures = yes
	calculate_misc_expenditures = yes
	if = {
		limit = { has_nuclear_arsenal = yes }
		calculate_nuclear_expenditures = yes
	}

	set_variable = { military_expenditures = army_costs }
	add_to_variable = { military_expenditures = naval_costs }
	add_to_variable = { military_expenditures = nuclear_costs }
	add_to_variable = { military_expenditures = military_costs_misc }

	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { military_expenditures = 0 }
	}
}



calculate_misc_expenditures = {
	set_variable = { military_costs_misc = modifier@military_costs_misc }
	clamp_variable = {
		var = military_costs_misc
		min = 0
	}
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { military_costs_misc = 0 }
	}
}

calculate_army_expenditures = {

	calculate_army_maintenance_expenditures = yes
	calculate_army_R_D_expenditures = yes
	calculate_army_logistics_expenditures = yes #used for logistics. lol.
	calculate_army_procurement_expenditures = yes #actually used for procurement. lol

	set_variable = { army_costs = army_maintenance_costs }
	add_to_variable = { army_costs = army_logistics_costs }
	add_to_variable = { army_costs = army_industry_costs }
	add_to_variable = { army_costs = army_r_d_costs }
	set_variable = { army_costs_base = army_costs }
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { army_costs = 0 }
	}
}

calculate_army_maintenance_expenditures = {

	set_variable = { army_maintenance_costs = 0 }

	set_variable = { MBT_costs = num_equipment_in_armies@MBT_chassis } #Both NSB + non-NSB MBTs count as chassis
	set_variable = { IFV_costs = num_equipment_in_armies@IFV_chassis } #Same goes for all armor types
	set_variable = { APC_costs = num_equipment_in_armies@APC_chassis }
	set_variable = { anti_air_costs = num_equipment_in_armies@anti_air_equipment }
	set_variable = { laser_anti_air_costs = num_equipment_in_armies@laser_aa_equipment }
	set_variable = { IFV_artillery_equipment_costs = num_equipment_in_armies@IFV_artillery_equipment }
	set_variable = { IFV_aa_equipment_costs = num_equipment_in_armies@IFV_aa_equipment }
	set_variable = { artillery_equipment_costs = num_equipment_in_armies@artillery_equipment }
	set_variable = { attack_helicopter_equipment_costs = num_equipment_in_armies@attack_helicopter_equipment }
	set_variable = { kugelpanzer_equipment_costs = num_equipment_in_armies@kugelpanzer_equipment }
	set_variable = { MBT_artillery_equipment_costs = num_equipment_in_armies@MBT_artillery_equipment }
	set_variable = { MBT_aa_equipment_costs = num_equipment_in_armies@MBT_aa_equipment }
	set_variable = { MBT_Maus_equipment_costs = num_equipment_in_armies@MBT_Maus_equipment }
	set_variable = { MBT_Maus_aa_equipment_costs = num_equipment_in_armies@MBT_Maus_aa_equipment }
	set_variable = { motorized_equipment_costs = num_equipment_in_armies@motorized_equipment }
	set_variable = { scout_helicopter_equipment_costs = num_equipment_in_armies@scout_helicopter_equipment }
	set_variable = { transport_helicopter_equipment_costs = num_equipment_in_armies@transport_helicopter_equipment }


	divide_variable = { MBT_costs = 1000 }
	divide_variable = { IFV_costs = 1000 }
	divide_variable = { APC_costs = 1000 }
	divide_variable = { anti_air_costs = 1000 }
	divide_variable = { laser_anti_air_costs = 1000 }
	divide_variable = { IFV_artillery_equipment_costs = 1000 }
	divide_variable = { IFV_aa_equipment_costs = 1000 }
	divide_variable = { artillery_equipment_costs = 1000 }
	divide_variable = { attack_helicopter_equipment_costs = 1000 }
	divide_variable = { kugelpanzer_equipment_costs = 1000 }
	divide_variable = { MBT_artillery_equipment_costs = 1000 }
	divide_variable = { MBT_aa_equipment_costs = 1000 }
	divide_variable = { MBT_Maus_equipment_costs = 1000 }
	divide_variable = { MBT_Maus_aa_equipment_costs = 1000 }
	divide_variable = { motorized_equipment_costs = 1000 }
	divide_variable = { scout_helicopter_equipment_costs = 1000 }
	divide_variable = { transport_helicopter_equipment_costs = 1000 }

	#balancing numbers go here.

	multiply_variable = { MBT_costs = 0.030 } # cost of 1 MBT is approximately 83,000 in 1960 dollars
	multiply_variable = { IFV_costs = 0.018 } # cost of 1 IFV is approximately 52,000 in 1960 dollars
	multiply_variable = { APC_costs = 0.015 } # cost of 1 APC is approximately 43,000 in 1960 dollars
	multiply_variable = { anti_air_costs = 0.008 } # cost of anti-air system is approximately 120,000 in 1960 dollars I guess
	multiply_variable = { laser_anti_air_costs = 0.100 } # way more expensive, probably
	multiply_variable = { IFV_artillery_equipment_costs = 0.022 } # I am literally making up these numbers
	multiply_variable = { IFV_aa_equipment_costs = 0.025 } # balans
	multiply_variable = { artillery_equipment_costs = 0.006 } # artillery do be cheap
	multiply_variable = { attack_helicopter_costs = 0.100 } # attack heli do be fucking expensive
	multiply_variable = { kugelpanzer_equipment_costs = 0.020 } # i dont remember what kugelpanzer is supposed to be but this is probably it
	multiply_variable = { MBT_artillery_equipment_costs = 0.035 } # a bit more expensive than a simple tank for reasons
	multiply_variable = { MBT_aa_equipment_costs = 0.045 } # radar ain't cheap
	multiply_variable = { MBT_Maus_equipment_costs = 0.210 } #Maus was a useless boondoggle cmv
	multiply_variable = { MBT_Maus_aa_equipment_costs = 0.340 } #the funni big tank but with radar
	multiply_variable = { motorized_equipment_costs = 0.004 } #mmm yess cheap
	multiply_variable = { scout_helicopter_equipment_costs = 0.085 } #Scout helicopters do be an oof
	multiply_variable = { transport_helicopter_equipment_costs = 0.250 } #helis ooof ouch owie

	set_variable = { army_equipment_costs = MBT_costs }
	add_to_variable = { army_equipment_costs = IFV_costs }
	add_to_variable = { army_equipment_costs = APC_costs }
	add_to_variable = { army_equipment_costs = anti_air_costs }
	add_to_variable = { army_equipment_costs = laser_anti_air_costs }
	add_to_variable = { army_equipment_costs = IFV_artillery_equipment_costs }
	add_to_variable = { army_equipment_costs = IFV_aa_equipment_costs }
	add_to_variable = { army_equipment_costs = artillery_equipment_costs }
	add_to_variable = { army_equipment_costs = attack_helicopter_equipment_costs }
	add_to_variable = { army_equipment_costs = kugelpanzer_equipment_costs }
	add_to_variable = { army_equipment_costs = MBT_artillery_equipment_costs }
	add_to_variable = { army_equipment_costs = MBT_aa_equipment_costs }
	add_to_variable = { army_equipment_costs = MBT_Maus_equipment_costs }
	add_to_variable = { army_equipment_costs = MBT_Maus_aa_equipment_costs }
	add_to_variable = { army_equipment_costs = motorized_equipment_costs }
	add_to_variable = { army_equipment_costs = scout_helicopter_equipment_costs }
	add_to_variable = { army_equipment_costs = transport_helicopter_equipment_costs }


	# a little airforce trolling

	### LAM NOTE: the num_deployed_planes_with_type vars here seem to be CTDing the game on 1.15. very weird

	# set_variable = { num_gunships = num_deployed_planes_with_type@gunship_equipment }
	# set_variable = { num_strat_bombers = num_deployed_planes_with_type@strat_bomber_equipment }
	# set_variable = { num_tac_bombers = num_deployed_planes_with_type@tac_bomber_equipment }
	# set_variable = { num_CASs = num_deployed_planes_with_type@CAS_equipment }
	# set_variable = { num_cv_CASs = num_deployed_planes_with_type@cv_CAS_equipment }
	# set_variable = { num_interceptors = num_deployed_planes_with_type@interceptor_equipment }
	# set_variable = { num_fighters = num_deployed_planes_with_type@fighter_equipment }
	# set_variable = { num_cv_fighters = num_deployed_planes_with_type@cv_fighter_equipment }
	# set_variable = { num_light_stealth_aircraft = num_deployed_planes_with_type@light_stealth_equipment }
	# set_variable = { num_mca = num_deployed_planes_with_type@mca_equipment }
	# set_variable = { num_cv_mca = num_deployed_planes_with_type@cv_mca_equipment }
	# set_variable = { num_asw_helicopters = num_deployed_planes_with_type@asw_helicopter_equipment }
	# set_variable = { num_nav_bombers = num_deployed_planes_with_type@nav_bomber_equipment }
	# set_variable = { num_cv_nav_bombers = num_deployed_planes_with_type@cv_nav_bomber_equipment }
	# set_variable = { num_scout_planes = num_deployed_planes_with_type@scout_plane_equipment }
	# set_variable = { num_tac_stealth_aircraft = num_deployed_planes_with_type@tac_stealth_equipment }
	# set_variable = { num_strat_stealth_aircraft = num_deployed_planes_with_type@strat_stealth_equipment }
	# set_variable = { num_transport_planes = num_deployed_planes_with_type@transport_plane_equipment }

	set_variable = { gunship_costs = num_gunships } # we could fix this but I'm too lazy to do it tbh
	set_variable = { strat_bomber_costs = num_strat_bombers }
	set_variable = { tac_bomber_costs = num_tac_bombers }
	set_variable = { CAS_costs = num_CASs }
	set_variable = { interceptor_costs = num_interceptors }
	set_variable = { fighter_costs = num_fighters }
	set_variable = { cv_CAS_costs = num_cv_CASs }
	set_variable = { cv_fighter_costs = num_cv_fighters }
	set_variable = { light_stealth_aircraft_costs = num_light_stealth_aircraft }
	set_variable = { mca_costs = num_mca }
	set_variable = { cv_mca_costs = num_cv_mca }
	set_variable = { asw_helicopter_costs = num_asw_helicopters }
	set_variable = { nav_bomber_costs = num_nav_bombers }
	set_variable = { cv_nav_bomber_costs = num_cv_nav_bombers }
	set_variable = { scout_plane_costs = num_scout_planes }
	set_variable = { tac_stealth_aircraft_costs = num_tac_stealth_aircraft }
	set_variable = { strat_stealth_aircraft_costs = num_cv_fighters }
	set_variable = { transport_plane_costs = num_transport_planes }

	divide_variable = { gunship_costs = 1000 } # we could fix this but I'm too lazy to do it tbh
	divide_variable = { strat_bomber_costs = 1000 }
	divide_variable = { tac_bomber_costs = 1000 }
	divide_variable = { CAS_costs = 1000 }
	divide_variable = { interceptor_costs = 1000 }
	divide_variable = { fighter_costs = 1000 }
	divide_variable = { cv_CAS_costs = 1000 }
	divide_variable = { cv_fighter_costs = 100 }
	divide_variable = { light_stealth_aircraft_costs = 1000 }
	divide_variable = { mca_costs = 1000 }
	divide_variable = { cv_mca_costs = 1000 }
	divide_variable = { asw_helicopter_costs = 1000 }
	divide_variable = { nav_bomber_costs = 1000 }
	divide_variable = { cv_nav_bomber_costs = 1000 }
	divide_variable = { scout_plane_costs = 1000 }
	divide_variable = { tac_stealth_aircraft_costs = 1000 }
	divide_variable = { strat_stealth_aircraft_costs = 1000 }
	divide_variable = { transport_plane_costs = 1000 } # we could do a little balancing here idk


	multiply_variable = { gunship_costs = 0.090 }
	multiply_variable = { strat_bomber_costs = 0.100 }
	multiply_variable = { tac_bomber_costs = 0.085 }
	multiply_variable = { CAS_costs = 0.045 }
	multiply_variable = { interceptor_costs = 0.050 }
	multiply_variable = { fighter_costs = 0.045 }

	set_variable = { army_air_costs = gunship_costs }
	add_to_variable = { army_air_costs = strat_bomber_costs }
	add_to_variable = { army_air_costs = tac_bomber_costs }
	add_to_variable = { army_air_costs = CAS_costs }
	add_to_variable = { army_air_costs = interceptor_costs }
	add_to_variable = { army_air_costs = fighter_costs }
	add_to_variable = { army_air_costs = light_stealth_aircraft_costs }
	add_to_variable = { army_air_costs = mca_costs }
	#add_to_variable = { army_air_costs = cv_mca_costs }
	#add_to_variable = { army_air_costs = asw_helicopter_costs }
	#add_to_variable = { army_air_costs = nav_bomber_costs }
	#add_to_variable = { army_air_costs = cv_nav_bomber_costs }
	add_to_variable = { army_air_costs = scout_plane_costs }
	add_to_variable = { army_air_costs = tac_stealth_aircraft_costs }
	add_to_variable = { army_air_costs = strat_stealth_aircraft_costs }
	add_to_variable = { army_air_costs = transport_plane_costs }

	set_variable = { naval_aviation_costs = cv_CAS_costs }
	add_to_variable = { naval_aviation_costs = cv_fighter_costs }
	add_to_variable = { naval_aviation_costs = cv_mca_costs }
	add_to_variable = { naval_aviation_costs = asw_helicopter_costs }
	add_to_variable = { naval_aviation_costs = nav_bomber_costs }
	add_to_variable = { naval_aviation_costs = cv_nav_bomber_costs }


	if = {
		limit = {
			check_variable = { num_ships_with_type@carrier > 0 }
		}
		add_to_variable = { army_air_costs = naval_aviation_costs }
	}

	add_to_variable = { army_air_costs = airforce_manpower_costs }
	multiply_variable = { army_air_costs = modifier@airforce_cost_modifier }

	add_to_variable = { army_maintenance_costs = manpower_costs }
	add_to_variable = { army_maintenance_costs = army_equipment_costs }
	multiply_variable = { army_maintenance_costs = modifier@army_cost_modifier }

	add_to_variable = { army_maintenance_costs = army_air_costs }

	set_variable = { army_maintenance_costs_base = army_maintenance_costs }

	set_variable = { army_maintenance_slider_effect = econ_army_maintenance_slider_pct }

	multiply_variable = { army_maintenance_slider_effect = 0.8 }
	add_to_variable = { army_maintenance_slider_effect = 20 }
	divide_variable = { army_maintenance_slider_effect = 100 }

	## All of this exists to boost the cost to match the display
	#Boosts/Austerity
	multiply_variable = { army_costs = modifier@military_expenditures_factor }
	multiply_variable = { manpower_costs = modifier@military_expenditures_factor }
	multiply_variable = { military_factory_costs = modifier@military_expenditures_factor }
	multiply_variable = { army_air_costs = modifier@military_expenditures_factor }
	multiply_variable = { army_equipment_costs = modifier@military_expenditures_factor }
	multiply_variable = { army_industry_costs = modifier@military_expenditures_factor }
	multiply_variable = { army_logistics_costs = modifier@military_expenditures_factor }
	multiply_variable = { army_R_D_costs = modifier@military_expenditures_factor }

	multiply_variable = { manpower_costs = modifier@army_cost_modifier }
	multiply_variable = { army_equipment_costs = modifier@army_cost_modifier }
	multiply_variable = { army_industry_costs = modifier@army_cost_modifier }
	multiply_variable = { army_logistics_costs = modifier@army_cost_modifier }
	multiply_variable = { army_R_D_costs = modifier@army_cost_modifier }

	multiply_variable = { army_maintenance_costs = army_maintenance_slider_effect }
	multiply_variable = { manpower_costs = army_maintenance_slider_effect }
	multiply_variable = { military_factory_costs = army_maintenance_slider_effect }
	multiply_variable = { army_air_costs = army_maintenance_slider_effect }
	multiply_variable = { army_equipment_costs = army_maintenance_slider_effect }
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { army_maintenance_costs = 0 }
	}
}

calculate_army_R_D_expenditures = {

	set_variable = { army_R_D_costs = gdpc }

	divide_variable = { army_R_D_costs = 4 } #max is $2500 for every soldier in the field (maybe IDK). seems to be good tho
	multiply_variable = { army_R_D_costs = amount_research_slots } #tie it to num slots

	multiply_variable = { army_R_D_costs = modifier@military_R_D_expenditures_factor }
	set_variable = { army_R_D_slider_effect = econ_army_R_D_slider_pct }
	divide_variable = { army_R_D_slider_effect = 100 }
	multiply_variable = { army_R_D_costs = army_R_D_slider_effect }


	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { army_R_D_costs = 0 }
	}
}

calculate_army_logistics_expenditures = { #actually done for logistics hehehehehe!!
	set_variable = { army_logistics_costs = army_maintenance_costs_base }
	multiply_variable = { army_logistics_costs = 0.90 }

	set_variable = { army_training_slider_effect = econ_army_logistics_slider_pct }
	multiply_variable = { army_training_slider_effect = 0.01 }
	multiply_variable = { army_logistics_costs = army_training_slider_effect }
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { army_logistics_costs = 0 }
	}
}

calculate_army_procurement_expenditures = {
	set_temp_variable = { num_mil_facs = num_of_military_factories }
	set_temp_variable = { num_available_mil_facs = num_of_available_military_factories }

	set_variable = { used_mil_facs = num_mil_facs }
	subtract_from_variable = { used_mil_facs = num_available_mil_facs }
	divide_variable = { used_mil_facs = mils_mult }

	set_variable = { army_industry_costs = used_mil_facs }
	multiply_variable = { army_industry_costs = econ_army_procurement_slider_pct }
	divide_variable = { army_industry_costs = 400 }

	divide_variable = { army_industry_costs = pu_to_gdp_ratio }
	multiply_variable = { army_industry_costs = modifier@military_industry_cost_expertise_modifier }
	multiply_variable = { army_industry_costs = modifier@military_industry_cost_equipment_modifier }
	multiply_variable = { army_industry_costs = modifier@military_industry_cost_modifier }
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { army_industry_costs = 0 }
	}
}

calculate_naval_expenditures = {

	set_temp_variable = { num_naval_facs = num_of_naval_factories }
	set_temp_variable = { num_available_naval_facs = num_of_available_naval_factories }

	set_variable = { used_naval_facs = num_naval_facs }
	subtract_from_variable = { used_naval_facs = num_available_naval_facs }

	set_variable = { naval_industry_costs = used_naval_facs }
	multiply_variable = { naval_industry_costs = 0.10 }
	multiply_variable = { naval_industry_costs = modifier@naval_industry_cost_modifier }

	set_temp_variable = { temp_clamped_num_ships = num_ships }
	clamp_temp_variable = {
		var = temp_clamped_num_ships
		max = 1
	}

	multiply_variable = { naval_industry_costs = temp_clamped_num_ships }

	set_variable = { naval_costs = 0 }

	set_variable = { num_carriers = num_ships_with_type@carrier }
	set_variable = { num_battleships = num_ships_with_type@battleship }
	set_variable = { num_cruisers = num_ships_with_type@cruiser }
	add_to_variable = { num_cruisers = num_ships_with_type@light_cruiser }
	add_to_variable = { num_cruisers = num_ships_with_type@heavy_cruiser }
	set_variable = { num_destroyers = num_ships_with_type@destroyer }
	set_variable = { num_frigate = num_ships_with_type@frigate }
	set_variable = { num_corvette = num_ships_with_type@corvette }
	set_variable = { num_submarine = num_ships_with_type@submarine }

	set_variable = { carrier_costs = num_carriers }
	set_variable = { battleship_costs = num_battleships }
	set_variable = { cruiser_costs = num_cruisers }
	set_variable = { destroyer_costs = num_destroyers }
	set_variable = { frigate_costs = num_frigate }
	set_variable = { corvette_costs = num_corvette }
	set_variable = { submarine_costs = num_submarine }

	multiply_variable = { carrier_costs = 0.041 }
	multiply_variable = { battleship_costs = 0.030 }
	multiply_variable = { cruiser_costs = 0.010 }
	multiply_variable = { destroyer_costs = 0.007 }
	multiply_variable = { frigate_costs = 0.005 }
	multiply_variable = { corvette_costs = 0.004 }
	multiply_variable = { submarine_costs = 0.002 }

	set_variable = { fleet_costs = carrier_costs }
	add_to_variable = { fleet_costs = battleship_costs }
	add_to_variable = { fleet_costs = cruiser_costs }
	add_to_variable = { fleet_costs = destroyer_costs }
	add_to_variable = { fleet_costs = frigate_costs }
	add_to_variable = { fleet_costs = corvette_costs }
	add_to_variable = { fleet_costs = submarine_costs }

	add_to_variable = { fleet_costs = naval_manpower_costs }

	add_to_variable = { naval_costs = fleet_costs }
	add_to_variable = { naval_costs = naval_industry_costs }
	multiply_variable = { naval_costs = modifier@naval_cost_modifier }

	#Boosts/Austerity
	set_variable = { naval_cost_slider_effect = econ_naval_expenditures_slider_pct }
	divide_variable = { naval_cost_slider_effect = 100 } # convert to 100%

	multiply_variable = { naval_cost_slider_effect = 0.8 }
	add_to_variable = { naval_cost_slider_effect = 0.2 }

	set_variable = { naval_costs_base = naval_costs }
	multiply_variable = { naval_industry_costs = naval_cost_slider_effect }
	multiply_variable = { naval_costs = naval_cost_slider_effect }
	multiply_variable = { naval_manpower_costs = naval_cost_slider_effect }
	multiply_variable = { naval_factory_costs = naval_cost_slider_effect }
	multiply_variable = { fleet_costs = naval_cost_slider_effect }

	multiply_variable = { naval_industry_costs = modifier@military_expenditures_factor }
	multiply_variable = { naval_costs = modifier@military_expenditures_factor }
	multiply_variable = { naval_manpower_costs = modifier@military_expenditures_factor }
	multiply_variable = { naval_factory_costs = modifier@military_expenditures_factor }
	multiply_variable = { fleet_costs = modifier@military_expenditures_factor }
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { naval_costs = 0 }
	}
}

calculate_nuclear_expenditures = {
	# Costs per stockpiled warhead
	set_variable = { stockpile_costs = nuclear_stockpile }
	divide_variable = { stockpile_costs = 2500 }

	# Costs per active enrichment plant
	get_number_of_enrichment_plants = yes
	set_variable = { enrichment_plant_costs = num_of_enrichment_plants }
	multiply_variable = { enrichment_plant_costs = 0.05 }

	# Costs per active silo
	get_number_of_silos = yes
	set_variable = { silo_costs = num_of_silos }
	multiply_variable = { silo_costs = 0.025 }

	# Sliver value modifier
	set_variable = { nuclear_costs_slider_effect = econ_nuclear_expenditures_slider_value }
	divide_variable = { nuclear_costs_slider_effect = 40 }
	add_to_variable = { nuclear_costs_slider_effect = 0.75 }
	set_variable = { nuclear_costs_base = nuclear_costs }

	# Calculating new monthly warhead production based on the slider value
	if = {
		limit = { NOT = { has_country_flag = nuclear_decommissioning_active } }
		if = {
			limit = { check_variable = { TNO_stockpile^7 > 0 } } # Uranium stockpile
			set_variable = { nuclear_stockpile_change = num_of_enrichment_plants }
			multiply_variable = { nuclear_stockpile_change = 20 }
			multiply_variable = { nuclear_stockpile_change = nuclear_costs_slider_effect }
			set_temp_variable = { nuclear_prod_modifier = 1 }
			add_to_temp_variable = { nuclear_prod_modifier = modifier@nuclear_production_factor }
			multiply_variable = { nuclear_stockpile_change = nuclear_prod_modifier }
		}
		else = { set_variable = { nuclear_stockpile_change = 0 } } # No uranium, no production
	}

	multiply_variable = { stockpile_costs = nuclear_costs_slider_effect }
	multiply_variable = { enrichment_plant_costs = nuclear_costs_slider_effect }
	multiply_variable = { silo_costs = nuclear_costs_slider_effect }

	multiply_variable = { stockpile_costs = modifier@military_expenditures_factor }
	multiply_variable = { enrichment_plant_costs = modifier@military_expenditures_factor }
	multiply_variable = { silo_costs = modifier@military_expenditures_factor }

	# Adding it all up
	set_variable = { nuclear_costs = stockpile_costs }
	add_to_variable = { nuclear_costs = enrichment_plant_costs }
	add_to_variable = { nuclear_costs = silo_costs }
}

calculate_debt_expenditures = { # calculate how much we need to spend to service our debt this month
	set_variable = { interest_rates = base_interest_rates }
	add_to_variable = { interest_rates = interest_rate_from_credit_rating }
	add_to_variable = { interest_rates = modifier@interest_rate_modifier }
	set_temp_variable = { interest_rates_multiplier = 1 }
	add_to_temp_variable = { interest_rates_multiplier = modifier@interest_rate_factor_modifier }
	multiply_variable = { interest_rates = interest_rates_multiplier }


	#update some display variables
	set_variable = { interest_rate_display = interest_rates }
	set_variable = { monthly_interest_rate_display = interest_rate_display }
	divide_variable = { monthly_interest_rate_display = 12 }

	set_variable = { interest_rates_from_debt = national_debt } # a little math for debt levels to affect interest rates
	# log = "[?interest_rates_from_debt] interest rates from debt"
	divide_variable = { interest_rates_from_debt = GDP }
	divide_variable = { interest_rates_from_debt = 10 }
	set_temp_variable = { temp_credit_rating_interest_rate_effect = 1 }
	add_to_temp_variable = { temp_credit_rating_interest_rate_effect = credit_rating_interest_rates_from_debt }
	multiply_variable = { interest_rates_from_debt = temp_credit_rating_interest_rate_effect }

	add_to_variable = { interest_rates = interest_rates_from_debt }

	set_variable = { debt_servicing_expenditures = national_debt }
	multiply_variable = { debt_servicing_expenditures = interest_rates }
	divide_variable = { debt_servicing_expenditures = 100 }
	#log ="interest due this year is [?debt_servicing_expenditures]"
}

calculate_total_expenditures = {
	#add_country_specific_idea_costs = yes
	set_variable = { total_expenditures = civilian_expenditures }
	add_to_variable = { total_expenditures = military_expenditures }
	add_to_variable = { total_expenditures = debt_servicing_expenditures }
	#add_to_variable = { total_expenditures = misc_costs }
	#add_to_variable = { total_expenditures = modifier@misc_costs_modifier }

	set_variable = { misc_costs_flat = modifier@misc_costs_modifier }


	# do a little trolling with misc costs as a percent of GDP
	#set_variable = { misc_costs_relative = misc_costs_percent_of_GDP }
	set_variable = { misc_costs_relative = modifier@misc_costs_percent_of_GDP_modifier }
	multiply_variable = { misc_costs_relative = GDP }

	set_variable = { misc_costs_true = misc_costs_flat }
	add_to_variable = { misc_costs_true = misc_costs_relative }

	add_to_variable = { total_expenditures = misc_costs_true }


	set_variable = { military_expenditures_percent = military_expenditures }
	set_variable = { civilian_expenditures_percent = civilian_expenditures }
	set_variable = { debt_servicing_expenditures_percent = debt_servicing_expenditures }
	set_variable = { misc_expenditures_percent = misc_costs_true }

	divide_variable = { military_expenditures_percent = total_expenditures }
	divide_variable = { civilian_expenditures_percent = total_expenditures }
	divide_variable = { debt_servicing_expenditures_percent = total_expenditures }
	divide_variable = { misc_expenditures_percent = total_expenditures }

	multiply_variable = { military_expenditures_percent = 100 }
	multiply_variable = { civilian_expenditures_percent = 100 }
	multiply_variable = { debt_servicing_expenditures_percent = 100 }
	multiply_variable = { misc_expenditures_percent = 100 }

	round_variable = military_expenditures_percent
	round_variable = civilian_expenditures_percent
	round_variable = debt_servicing_expenditures_percent
	round_variable = misc_expenditures_percent

	set_temp_variable = { expenditures_validator = military_expenditures_percent }
	add_to_temp_variable = { expenditures_validator = civilian_expenditures_percent }
	add_to_temp_variable = { expenditures_validator = misc_expenditures_percent }
	add_to_temp_variable = { expenditures_validator = debt_servicing_expenditures_percent }
	#log ="[?expenditures_validator] expenditures validator"

	if = {
		limit = {
			NOT = {
				check_variable = { expenditures_validator = 100 }
			}
		}
		subtract_from_temp_variable = { expenditures_validator = 100 }
		subtract_from_variable = { civilian_expenditures_percent = expenditures_validator }
	}
	if = {
		limit = {
			has_country_flag = TNO_eliminate_military_spending
		}
		set_variable = { total_expenditures = 0 }
	}
}

calculate_total_expenditures_factor = {
	set_variable = { total_expenditures_factor = total_expenditures }
	divide_variable = { total_expenditures_factor = total_budget }
}

calculate_total_budget = {
	set_variable = { total_budget = total_expenditures }
	subtract_from_variable = { total_budget = total_income }
	# add_country_specific_idea_costs = yes
	#log ="Total spending for [THIS.GetTag] is [?total_expenditures]"
	#log ="Balance for [THIS.GetTag] is -[?total_budget]"

	#determine if there is a deficit or not lmao
	set_variable = { deficit = total_budget }
	#log ="[THIS.GetTag] has deficit of [?deficit]"
	# resolve_negative_cases = yes

	# apply effects of deficit monetization
	if = {
		limit = {
			check_variable = { deficit > -0.001 }
		}
		set_temp_variable = { deficit_monetization_inverse = 1 }
		set_variable = { deficit_monetization_pct = econ_deficit_monetization_slider_pct }
		divide_variable = { deficit_monetization_pct = 100 }
		subtract_from_temp_variable = { deficit_monetization_inverse = deficit_monetization_pct } # gets % of deficit that's actually being monetized

		set_variable = { deficit_monetization_as_percent_of_GDP = deficit }
		multiply_variable = { deficit = deficit_monetization_inverse } # multiplies total expenditures by % of deficit being monetized

		subtract_from_variable = { deficit_monetization_as_percent_of_GDP = deficit } # get amount of deficit that is being monetized
		multiply_variable = { deficit_monetization_as_percent_of_GDP = 100 }

		divide_variable = { deficit_monetization_as_percent_of_GDP = GDP } # get % of GDP that is being monetized as 100

		set_variable = { deficit_monetization_inflation_effect = deficit_monetization_as_percent_of_GDP }
		# we need some math here to make monetization suck oof ouch owie
	}
	else = { # monetizing more than the deficit is not allowed
		set_variable = { econ_deficit_monetization_slider_pct = 0 }
		set_variable = { econ_deficit_monetization_slider_dot_x = econ_deficit_monetization_minimal_pct } # Saves having to call update_econ_sliders again
		multiply_variable = { econ_deficit_monetization_slider_dot_x = 1.88 }
		add_to_variable = { econ_deficit_monetization_slider_dot_x = 45 }
		set_variable = { deficit_monetization_inflation_effect = 0 }
	}
}

calculate_nominal_GDP_growth = {
	#calculate nominal GDP growth (annual)
	set_variable = { GDP_growth_nominal_precursor = GDP_growth }
	add_to_variable = { GDP_growth_nominal_precursor = modifier@gdp_growth_modifier }
	add_to_variable = { GDP_growth_nominal_precursor = deficit_GDP_growth_effect }
	calculate_reserves_effect_on_GDP_growth = yes
	add_to_variable = { GDP_growth_nominal_precursor = reserves_effect_on_GDP_growth }
	#Guangdong Exclusive
	add_to_variable = { GDP_growth_nominal_precursor = GNG_rGDP_debuff }

	set_variable = { GDP_growth_multiplier = modifier@annual_gdp_growth_factor }

	calculate_infrastructure_nominal_gdp_effect = yes
	calculate_power_plant_nominal_gdp_effect = yes
	add_to_variable = { GDP_growth_multiplier = total_state_infrastructure_effect }
	add_to_variable = { GDP_growth_multiplier = total_state_power_plant_effect }
	add_to_variable = { GDP_growth_multiplier = total_state_damaged_infrastructure_effect }
	add_to_variable = { GDP_growth_multiplier = debt_effect_on_nominal_growth }
	calculate_population_growth_effect = yes
	add_to_variable = { GDP_growth_multiplier = population_growth_effect }
	calculate_tax_effect_on_nominal_growth = yes
	add_to_variable = { GDP_growth_multiplier = total_taxes_effect }
	calculate_trade_effect = yes
	add_to_variable = { GDP_growth_multiplier = trade_effect }

	if = {
		limit = {
			check_variable = { GDP_growth_nominal_precursor < 0 }
		}
		multiply_variable = { GDP_growth_multiplier = -1 }
	}
	add_to_variable = { GDP_growth_multiplier = 1 }
	set_variable = { GDP_growth_nominal_display_tt = GDP_growth_nominal_precursor }
	multiply_variable = { GDP_growth_nominal_precursor = GDP_growth_multiplier }
	set_variable = { GDP_growth_nominal = GDP_growth_nominal_precursor }
}

calculate_reserves_effect_on_GDP_growth = {
	set_temp_variable = { temp_reserves_effect = money_reserves }
	divide_temp_variable = { temp_reserves_effect = GDP }
	multiply_variable = { temp_reserves_effect = 100 }


	set_variable = { reserves_as_GDP_percent = temp_reserves_effect }

	set_temp_variable = { temp_reserves_effect_squarer = temp_reserves_effect }

	multiply_temp_variable = { temp_reserves_effect = temp_reserves_effect_squarer }
	multiply_temp_variable = { temp_reserves_effect = -25 }
	clamp_temp_variable = { var = temp_reserves_effect min = -15 }

	set_variable = { reserves_effect_on_GDP_growth = temp_reserves_effect }
}

calculate_trade_effect = {
	set_variable = { trade_effect_precursor = total_trade_value }
	if = {
		limit = {
			check_variable = { total_trade_value < 0 }
		}
		multiply_variable = { trade_effect_precursor = -1 }
	}
	divide_variable = { trade_effect_precursor = GDP }
	add_to_variable = { trade_effect_precursor = 2 }

	set_variable = { trade_effect = -1.5 }

	divide_variable = { trade_effect = trade_effect_precursor }
	add_to_variable = { trade_effect = 0.75 }
	if = {
		limit = {
			check_variable = { total_trade_value < 0 }
		}
		multiply_variable = { trade_effect = -1 }
	}
}

calculate_tax_effect_on_nominal_growth = {

	set_variable = { business_taxes_effect = business_tax_rate_total }
	multiply_variable = { business_taxes_effect = -0.4 } #balancing value!

	set_variable = { income_taxes_effect = income_tax_factor }
	multiply_variable = { income_taxes_effect = -0.35 } #balancing value!

	set_variable = { sales_taxes_effect = sales_tax_display }
	multiply_variable = { sales_taxes_effect = -0.25 } #balancing value!

	set_variable = { total_taxes_effect = business_taxes_effect }
	add_to_variable = { total_taxes_effect = income_taxes_effect }
	add_to_variable = { total_taxes_effect = sales_taxes_effect }
}

calculate_population_growth_effect = {
	set_variable = { population_growth_effect = modifier@monthly_population }
	add_to_variable = { population_growth_effect = 1 }
	multiply_variable = { population_growth_effect = 100 } # represent as 100 lel
	multiply_variable = { population_growth_effect = 1.5 } # this is how much the population will increase this year in percent
	clamp_variable = { var = population_growth_effect max = 0 }

	multiply_variable = { population_growth_effect = 0.005 }
}

calculate_infrastructure_nominal_gdp_effect = {
	set_variable = { total_state_infrastructure_effect = 0 }
	set_variable = { total_state_damaged_infrastructure_effect = 0 }
	set_temp_variable = { total_possible_infrastructure = 0 }
	set_temp_variable = { total_built_infrastructure = 0 }
	every_owned_state = {
		limit = {
			is_core_of = PREV
		}
		set_variable = { single_state_infrastructure_effect = non_damaged_building_level@infrastructure }
		multiply_variable = { single_state_infrastructure_effect = state_population_k }
		divide_variable = { single_state_infrastructure_effect = 10000 }
		add_to_variable = { PREV.total_state_infrastructure_effect = single_state_infrastructure_effect }

		add_to_temp_variable = { total_built_infrastructure = non_damaged_building_level@infrastructure }

		add_to_temp_variable = { total_possible_infrastructure = 10 }

		set_variable = { single_state_damaged_infrastructure_effect = damaged_building_level@infrastructure }
		multiply_variable = { single_state_damaged_infrastructure_effect = state_population_k }
		divide_variable = { single_state_damaged_infrastructure_effect = 10000 }
		add_to_variable = { PREV.total_state_damaged_infrastructure_effect = single_state_damaged_infrastructure_effect }

	}
	divide_variable = { total_state_infrastructure_effect = total_core_pop_m }

	divide_variable = { total_state_damaged_infrastructure_effect = total_core_pop_m }

	multiply_variable = { total_state_damaged_infrastructure_effect = -0.25 }

	set_variable = { total_infrastructure_built_in_core_state = total_built_infrastructure }

	set_variable = { total_possible_infrastructure_display_tt = total_possible_infrastructure }


	multiply_variable = { total_state_infrastructure_effect = 0.2 }
}

calculate_power_plant_nominal_gdp_effect = {
	set_variable = { total_state_power_plant_effect = 0 }
	set_variable = { total_powered_states = 0 }
	every_owned_state = {
		if = {
			limit = {
					check_variable = { non_damaged_building_level@thermoelectric_plant > 0 }
			}
			add_to_variable = { PREV.total_state_power_plant_effect = 1 }
			add_to_variable = { PREV.total_powered_states = 1 }
		}
		else_if = {
			limit = {
					check_variable = { non_damaged_building_level@nuclear_reactor > 0 }
			}
			add_to_variable = { PREV.total_state_power_plant_effect = 1 }
			add_to_variable = { PREV.total_powered_states = 1 }
		}
	}
	divide_variable = { total_state_power_plant_effect = num_owned_states }
	multiply_variable = { total_state_power_plant_effect = 0.025 }
}

calculate_total_inflation = {
	#calculate clamped inflation rate
	set_variable = { clamped_inflation_rate = 0 }
	add_to_variable = { clamped_inflation_rate = modifier@inflation_rate_modifier }
	add_to_variable = { clamped_inflation_rate = base_inflation_rate }
	add_to_variable = { clamped_inflation_rate = rubberband_inflation_rate }
	add_to_variable = { clamped_inflation_rate = deficit_monetization_inflation_effect }

	set_variable = { inflation_cycling_effect_adjusted = inflation_cycling_effect }

	add_to_variable = { clamped_inflation_rate = inflation_cycling_effect_adjusted }
	clamp_variable = {
		var = clamped_inflation_rate
		min = 0
	}
}

calculate_inflation_effect = {

	# \left(\frac{\left(x+10\right)^{3}}{1000+0.02\left(x+10\right)^{3}}\right)-1 <- inflation calc, roughly.

	set_temp_variable = { inflation_effect_calculation_cube_denominator = clamped_inflation_rate }

	add_to_temp_variable = { inflation_effect_calculation_cube_denominator = 10 }
	set_temp_variable = { inflation_effect_calculation_cube_denominator_cuber = inflation_effect_calculation_cube_denominator }

	multiply_temp_variable = { inflation_effect_calculation_cube_denominator = inflation_effect_calculation_cube_denominator_cuber }
	clamp_temp_variable = { var = inflation_effect_calculation_cube_denominator max = 1460 } # needed to avoid overflows
	multiply_temp_variable = { inflation_effect_calculation_cube_denominator = inflation_effect_calculation_cube_denominator_cuber }

	set_temp_variable = { inflation_effect_calculation_cube_numerator = inflation_effect_calculation_cube_denominator }


	multiply_temp_variable = { inflation_effect_calculation_cube_denominator = 0.02 }
	add_to_temp_variable = { inflation_effect_calculation_cube_denominator = 1000 }

	divide_temp_variable = { inflation_effect_calculation_cube_numerator = inflation_effect_calculation_cube_denominator }
	subtract_from_temp_variable = { inflation_effect_calculation_cube_numerator = 1 }

	divide_temp_variable = { inflation_effect_calculation_cube_numerator = -100 } #convert to % format

	set_variable = { TNO_econ_inflation_factory_output_penalty_display = inflation_effect_calculation_cube_numerator }
	set_variable = { TNO_econ_inflation_construction_speed_penalty_display = inflation_effect_calculation_cube_numerator }
	set_variable = { TNO_econ_inflation_consumer_goods_production_penalty_display = inflation_effect_calculation_cube_numerator }
}

GDP_rubberbanding_check = { #Reduce the effects of bonker growth by adding inflation and reducing growth
	if = {
		limit = {
			check_variable = { GDP_growth_real > 15 }
		}
		add_to_variable = { gdp_growth = -0.1 }
		if = {
			limit = { check_variable = { GDP > 50 } }
			add_to_variable = { gdp_growth = -0.2 }
		}
		if = {
			limit = { check_variable = { GDP > 150 } }
			add_to_variable = { gdp_growth = -0.3 }
		}
		if = {
			limit = { check_variable = { GDP > 250 } }
			add_to_variable = { gdp_growth = -0.5 }
		}
	}
	if = {
		limit = {
			check_variable = { GDP_growth_real > 12 }
		}
		set_temp_variable = { rand_growth_capper = random }
		multiply_temp_variable = { rand_growth_capper = 0.2 }
		add_to_variable = { rubberband_inflation_rate = rand_growth_capper }
		if = {
			limit = { check_variable = { GDP > 50 } }
			set_temp_variable = { rand_growth_capper = random }
			multiply_temp_variable = { rand_growth_capper = 0.3 }
			add_to_variable = { rubberband_inflation_rate = rand_growth_capper }
		}
		if = {
			limit = { check_variable = { GDP > 150 } }
			set_temp_variable = { rand_growth_capper = random }
			multiply_temp_variable = { rand_growth_capper = -0.15 }
			add_to_variable = { gdp_growth = rand_growth_capper }
		}
		if = {
			limit = { check_variable = { GDP > 250 } }
			set_temp_variable = { rand_growth_capper = random }
			multiply_temp_variable = { rand_growth_capper = -0.3 }
			add_to_variable = { gdp_growth = rand_growth_capper }
		}
	}

	set_temp_variable = { rand_growth_capper = random }
	multiply_temp_variable = { rand_growth_capper = 0.05 }
	add_to_variable = { rubberband_inflation_rate = rand_growth_capper }
	if = {
		limit = { check_variable = { GDP > 50 } }
		set_temp_variable = { rand_growth_capper = random }
		multiply_temp_variable = { rand_growth_capper = 0.08 }
		add_to_variable = { rubberband_inflation_rate = rand_growth_capper }
	}
	if = {
		limit = { check_variable = { GDP > 150 } }
		set_temp_variable = { rand_growth_capper = random }
		multiply_temp_variable = { rand_growth_capper = -0.05 }
		add_to_variable = { gdp_growth = rand_growth_capper }
	}
	if = {
		limit = { check_variable = { GDP > 250 } }
		set_temp_variable = { rand_growth_capper = random }
		multiply_temp_variable = { rand_growth_capper = -0.05 }
		add_to_variable = { gdp_growth = rand_growth_capper }
	}
}

apply_inflation_effect_month = {
	if = {
		limit = {
			has_variable = TNO_econ_inflation_effects_multiplier #Defaults to 1 if no value is set
		}
		multiply_variable = {
			TNO_econ_inflation_factory_output_penalty_display = ROOT.TNO_econ_inflation_effects_multiplier?1
		}
		multiply_variable = {
			TNO_econ_inflation_construction_speed_penalty_display = ROOT.TNO_econ_inflation_effects_multiplier?1
		}
		multiply_variable = {
			TNO_econ_inflation_consumer_goods_production_penalty_display = ROOT.TNO_econ_inflation_effects_multiplier?1
		}
	}
	set_variable = { TNO_econ_inflation_factory_output_penalty = TNO_econ_inflation_factory_output_penalty_display }
	set_variable = { TNO_econ_inflation_construction_speed_penalty = TNO_econ_inflation_construction_speed_penalty_display }
	set_variable = { TNO_econ_inflation_consumer_goods_production_penalty = TNO_econ_inflation_consumer_goods_production_penalty_display }
}

calculate_real_GDP_growth = {
	set_variable = { GDP_growth_real = GDP_growth_nominal }

	subtract_from_variable = { GDP_growth_real = clamped_inflation_rate }

	#calculate real GDP growth effect on poverty https://www.desmos.com/calculator/jkmbvkdtdh

	set_variable = { gdp_effect_on_poverty_precursor = GDP_growth_real }

	multiply_variable = { gdp_effect_on_poverty_precursor = 0.08 }
	subtract_from_variable = { gdp_effect_on_poverty_precursor = 2 }
	multiply_variable = { gdp_effect_on_poverty_precursor = 0.2 }

	set_variable = { gdp_effect_on_poverty = 1 }
	divide_variable = { gdp_effect_on_poverty = gdp_effect_on_poverty_precursor }
	add_to_variable = { gdp_effect_on_poverty = 2.55 }
	multiply_variable = { gdp_effect_on_poverty = -1 }

	set_temp_variable = { modifier_effect_on_gdp_effect_on_poverty = 1 }
	add_to_temp_variable = { modifier_effect_on_gdp_effect_on_poverty = modifier@GDP_effect_on_poverty_modifier }

	multiply_variable = { gdp_effect_on_poverty = modifier_effect_on_gdp_effect_on_poverty }

	if = {
		limit = {
			check_variable = { gdp_growth_real > 0 }
		}

		set_variable = { gdp_effect_on_poverty = 0 }
	}
}

resolve_spending = {
	# we already calculated deficit in effect calculate_total_budget - remember it is calculated as a positive value -> running a deficit for some reason

	#deficit is calculated for annual cycles, while monthly deficit is what is actually used for calculations (and is recalculated every month)

	set_temp_variable = { temp_monthly_deficit = deficit }
	divide_temp_variable = { temp_monthly_deficit = 12 }
	#log ="[?temp_monthly_deficit] is monthly deficit"
	if = { #if we're running a deficit, add the monthly deficit to the national debt

		limit = {
			has_country_flag = econ_debt_auto_payment
		}

		multiply_temp_variable = { temp_monthly_deficit = -1 } #make our surplus positive for sanity reasons
		if = {
			limit = {
				check_variable = { temp_monthly_deficit < national_debt } # if debt is larger than monthly surplus
			}
			#log ="subtracted [?temp_monthly_deficit] from national debt of [?national_debt] due to autopayment"
			subtract_from_variable = { national_debt = temp_monthly_deficit }
			#log ="subtracted [?temp_monthly_deficit] from national debt resulting in [?national_debt] due to autopayment"

		}
		else_if = {
			limit = {
				check_variable = { temp_monthly_deficit > national_debt }
			}

			subtract_from_temp_variable = { temp_monthly_deficit = national_debt }
			set_variable = { national_debt = 0 }
			add_to_variable = { money_reserves = temp_monthly_deficit }
		}
		else = {
			set_variable = { national_debt = 0 }
		}
	}

	else_if = {
		limit = {
			check_variable = { temp_monthly_deficit > 0 }
		}
		#log ="adding [?temp_monthly_deficit] deficit to national debt of [?national_debt]"
		add_to_variable = { national_debt = temp_monthly_deficit }
		#log ="added [?temp_monthly_deficit] deficit to national debt resulting in [?national_debt]
	}

	else = { # not running a deficit and not auto-paying off debt
		multiply_temp_variable = { temp_monthly_deficit = -1 }
		add_to_variable = { money_reserves = temp_monthly_deficit }
		#log ="added [?temp_monthly_deficit] to reserves due to no debt to pay off"
	}
}

resolve_negative_cases = {
	if = {
		limit = {
			check_variable = { ROOT.money_reserves < -1000.0 } #already converted to billion
		}
		set_variable = { money_reserves = 0.1 } #already converted to billion
		#log ="[GetDateText]: [THIS.GetName]: a pretty obvious overflow bug occured - money reserves reset to 100."
	}
	if = {
		limit = {
			check_variable = { ROOT.money_reserves < 0.0 } #already converted to billion
		}
		set_variable = { liquidinverter = 0 }
		subtract_from_variable = { liquidinverter = ROOT.money_reserves }
		add_to_variable = { national_debt = liquidinverter }
		set_variable = { ROOT.money_reserves = 0.0 } #already converted to billion
	}
	if = {
		limit = {
			check_variable = { ROOT.national_debt < -1000.0 } #already converted to billion
		}
		set_variable = { national_debt = 0.1 } #already converted to billion
		#log ="[GetDateText]: [THIS.GetName]: a pretty obvious overflow bug occured - national debt reset to 100."
	}
	if = {
		limit = {
			check_variable = { ROOT.national_debt < 0.0 } #already converted to billion
		}
		set_variable = { debtinverter = 0 }
		subtract_from_variable = { debtinverter = ROOT.national_debt }
		add_to_variable = { money_reserves = debtinverter }
		set_variable = { ROOT.national_debt = 0.0 } #already converted to billion
	}
	#if = {
	#	limit = {
	#		check_variable = { ROOT.GDP < 0.0 } #already converted to billion
	#	}
	#	set_variable = { GDP = 0.1 } #already converted to billion
	#}

	### Debt Ratio ### (done elsewhere)
	# set_variable = { debt_ratio = national_debt }
	# divide_variable = { debt_ratio = GDP }
}

autopay_reserves = {
	if = {

		limit = {
			has_country_flag = econ_debt_auto_payment
		}

		if = {
			limit = {
				check_variable = {
					var = money_reserves
					value = national_debt
					compare = less_than_or_equals
				}
			}
			subtract_from_variable = { national_debt = money_reserves }
			set_variable = { money_reserves = 0 }
			set_variable = { reserves_management_amount = 0 }
			else = {
				subtract_from_variable = { money_reserves = national_debt }
				set_variable = { national_debt = 0 }
				set_variable = { reserves_management_amount = 0 }
			}
		}
	}
}

calculate_minimum_army_size = {
	set_temp_variable = { twenty_percent_GDP = gdp }
	multiply_temp_variable = { twenty_percent_GDP = 0.20 }

	calculate_army_power = yes

	if = {
		limit = {
			check_variable = {
				var = army_power
				value = twenty_percent_GDP
				compare = less_than_or_equals
			}
		}
		set_variable = { army_size_percent_of_minimum = THIS.army_power }
		divide_variable = { army_size_percent_of_minimum = twenty_percent_GDP }

		set_temp_variable = { a = 20 }
		set_variable = { army_size_construction_speed_penalty = -20 }
		multiply_temp_variable = { a = army_size_percent_of_minimum }
		add_to_variable = { army_size_construction_speed_penalty = a }
		divide_variable = { army_size_construction_speed_penalty = 100 }

		set_temp_variable = { a = 0.5 }
		set_variable = { army_size_professionalism_penalty = -0.5 }
		multiply_temp_variable = { a = army_size_percent_of_minimum }
		add_to_variable = { army_size_professionalism_penalty = a }
		divide_variable = { army_size_professionalism_penalty = 100 }

		set_temp_variable = { a = 20 }
		set_variable = { army_size_fac_output_penalty = -20 }
		multiply_temp_variable = { a = army_size_percent_of_minimum }
		add_to_variable = { army_size_fac_output_penalty = a }
		divide_variable = { army_size_fac_output_penalty = 100 }
		add_dynamic_modifier = { modifier = below_minimum_army_size_dynmod }
	} else_if = {
		limit = { has_dynamic_modifier = { modifier = below_minimum_army_size_dynmod } }
		remove_dynamic_modifier = { modifier = below_minimum_army_size_dynmod }
	}
}

calculate_navy_size_effect = {
	if = {
		limit = {
			has_country_flag = HAS_ECON_SPHERE
		}

		calculate_total_sphere_trade_value = yes
		calculate_naval_power = yes

		set_temp_variable = { CorvetteRatio = 1 }
		divide_temp_variable = { CorvetteRatio = 7 }
		set_variable = { CorvetteScoreNeeded = total_trade_gross_value }
		multiply_variable = { CorvetteScoreNeeded = CorvetteRatio }

		set_variable = { CorvetteScoreFulfilledPercent = CorvetteScore }
		divide_variable = { CorvetteScoreFulfilledPercent = CorvetteScoreNeeded }
		clamp_variable = { var = CorvetteScoreFulfilledPercent min = 0 max = 1 }

		set_temp_variable = { FrigateRatio = 1 }
		divide_temp_variable = { FrigateRatio = 5 }
		set_variable = { FrigateScoreNeeded = total_trade_gross_value }
		multiply_variable = { FrigateScoreNeeded = FrigateRatio }

		set_variable = { FrigateScoreFulfilledPercent = FrigateScore }
		divide_variable = { FrigateScoreFulfilledPercent = FrigateScoreNeeded }
		clamp_variable = { var = FrigateScoreFulfilledPercent min = 0 max = 1 }

		set_temp_variable = { DestroyerRatio = 1 }
		divide_temp_variable = { DestroyerRatio = 6 }
		set_variable = { DestroyerScoreNeeded = total_trade_gross_value }
		multiply_variable = { DestroyerScoreNeeded = DestroyerRatio }

		set_variable = { DestroyerScoreFulfilledPercent = DestroyerScore }
		divide_variable = { DestroyerScoreFulfilledPercent = DestroyerScoreNeeded }
		clamp_variable = { var = DestroyerScoreFulfilledPercent min = 0 max = 1 }

		set_temp_variable = { CruiserRatio = 1 }
		divide_temp_variable = { CruiserRatio = 5 }
		set_variable = { CruiserScoreNeeded = total_trade_gross_value }
		multiply_variable = { CruiserScoreNeeded = CruiserRatio }

		set_variable = { CruiserScoreFulfilledPercent = CruiserScore }
		divide_variable = { CruiserScoreFulfilledPercent = CruiserScoreNeeded }
		clamp_variable = { var = CruiserScoreFulfilledPercent min = 0 max = 1 }

		set_temp_variable = { CarrierRatio = 1 }
		divide_temp_variable = { CarrierRatio = 8 }
		set_variable = { CarrierScoreNeeded = total_trade_gross_value }
		multiply_variable = { CarrierScoreNeeded = CarrierRatio }

		set_variable = { CarrierScoreFulfilledPercent = CarrierScore }
		divide_variable = { CarrierScoreFulfilledPercent = CarrierScoreNeeded }
		clamp_variable = { var = CarrierScoreFulfilledPercent min = 0 max = 1 }

		set_temp_variable = { BattleshipRatio = 1 }
		divide_temp_variable = { BattleshipRatio = 10 }
		set_variable = { BattleshipScoreNeeded = total_trade_gross_value }
		multiply_variable = { BattleshipScoreNeeded = BattleshipRatio }

		set_variable = { BattleshipScoreFulfilledPercent = BattleshipScore }
		divide_variable = { BattleshipScoreFulfilledPercent = BattleshipScoreNeeded }
		clamp_variable = { var = BattleshipScoreFulfilledPercent min = 0 max = 1 }

		# Effects from satisfaction of navy size
		if = {
			limit = { has_dlc = "Man the Guns" }
			set_temp_variable = { a = 0.30 }
			set_variable = { navy_size_trade_laws_effectiveness_effect = -0.15 }
			multiply_temp_variable = { a = CorvetteScoreFulfilledPercent }

			add_to_variable = { navy_size_trade_laws_effectiveness_effect = a }
			add_to_variable = { navy_size_trade_laws_effectiveness_effect = 1 }

			set_temp_variable = { a = 0.30 }
			set_variable = { navy_size_immigration_effectiveness_effect = -0.15 }
			multiply_temp_variable = { a = CorvetteScoreFulfilledPercent }
			add_to_variable = { navy_size_immigration_effectiveness_effect = a }
			add_to_variable = { navy_size_immigration_effectiveness_effect = 1 }
		}
		if = {
			limit = { NOT = { has_dlc = "Man the Guns" } }
			set_temp_variable = { a = 0.30 }
			set_variable = { navy_size_trade_laws_effectiveness_effect = -0.15 }
			multiply_temp_variable = { a = DestroyerScoreFulfilledPercent }

			add_to_variable = { navy_size_trade_laws_effectiveness_effect = a }
			add_to_variable = { navy_size_trade_laws_effectiveness_effect = 1 }

			set_temp_variable = { a = 0.30 }
			set_variable = { navy_size_immigration_effectiveness_effect = -0.15 }
			multiply_temp_variable = { a = FrigateScoreFulfilledPercent }
			add_to_variable = { navy_size_immigration_effectiveness_effect = a }
			add_to_variable = { navy_size_immigration_effectiveness_effect = 1 }
		}

		set_temp_variable = { a = 0.30 }
		set_variable = { navy_size_resources_gain = -0.1 }
		multiply_temp_variable = { a = FrigateScoreFulfilledPercent }
		add_to_variable = { navy_size_resources_gain = a }

		set_temp_variable = { a = 0.20 }
		set_variable = { navy_size_trade_opinion_factor_gain = -0.1 }
		multiply_temp_variable = { a = DestroyerScoreFulfilledPercent }
		add_to_variable = { navy_size_trade_opinion_factor_gain = a }

		set_temp_variable = { a = 0.20 }
		set_variable = { navy_size_pp_gain = -0.1 }
		multiply_temp_variable = { a = CruiserScoreFulfilledPercent }
		add_to_variable = { navy_size_pp_gain = a }

		set_temp_variable = { a = 0.15 }
		set_variable = { navy_size_air_mission_efficiency_gain = -0.05 }
		multiply_temp_variable = { a = CarrierScoreFulfilledPercent }
		add_to_variable = { navy_size_air_mission_efficiency_gain = a }

		set_temp_variable = { a = 0.10 }
		set_variable = { navy_size_party_popularity_stability_factor_gain = 0 }
		set_variable = { navy_size_war_support_factor_gain = 0 }
		multiply_temp_variable = { a = BattleshipScoreFulfilledPercent }
		add_to_variable = { navy_size_party_popularity_stability_factor_gain = a }
		add_to_variable = { navy_size_war_support_factor_gain = a }

		add_dynamic_modifier = { modifier = navy_size_dynmod }
	}
	else_if = {
		limit = { has_dynamic_modifier = { modifier = navy_size_dynmod } }
		clear_variable = navy_size_trade_laws_effectiveness_effect
		clear_variable = navy_size_immigration_effectiveness_effect
		remove_dynamic_modifier = { modifier = navy_size_dynmod }
	}
}

calculate_fielded_manpower = {
	#why can't we just have an army_manpower variable?
	#this gives you a rough estimate of how much manpower is in the field
	# this is gonna get replaced soon so be advised

	# ^ that spits out total fielded manpower including army, air, and navy!

	### LAM NOTE: the num_deployed_planes_with_type vars here seem to be CTDing the game on 1.15. very weird

	set_variable = { fighter_manpower_k = 0.02 }
	# multiply_variable = { fighter_manpower_k = num_deployed_planes_with_type@fighter_equipment }

	set_variable = { cv_fighter_manpower_k = 0.02 }
	# multiply_variable = { cv_fighter_manpower_k = num_deployed_planes_with_type@cv_fighter_equipment }

	set_variable = { light_stealth_manpower_k = 0.04 }
	# multiply_variable = { light_stealth_manpower_k = num_deployed_planes_with_type@light_stealth_equipment }

	set_variable = { cas_manpower_k = 0.02 }
	# multiply_variable = { cas_manpower_k = num_deployed_planes_with_type@CAS_equipment }

	set_variable = { cv_cas_manpower_k = 0.02 }
	# multiply_variable = { cv_cas_manpower_k = num_deployed_planes_with_type@cv_CAS_equipment }

	set_variable = { mca_manpower_k = 0.02 }
	# multiply_variable = { mca_manpower_k = num_deployed_planes_with_type@mca_equipment }

	set_variable = { cv_mca_manpower_k = 0.04 }
	# multiply_variable = { cv_mca_manpower_k = num_deployed_planes_with_type@cv_mca_equipment }

	set_variable = { interceptor_manpower_k = 0.02 }
	# multiply_variable = { interceptor_manpower_k = num_deployed_planes_with_type@interceptor_equipment }

	set_variable = { asw_helicopter_manpower_k = 0.01 }
	# multiply_variable = { asw_helicopter_manpower_k = num_deployed_planes_with_type@asw_helicopter_equipment }

	# set_variable = { nav_bomber_manpower_k = 0.02 }
	# multiply_variable = { nav_bomber_manpower_k = num_deployed_planes_with_type@nav_bomber_equipment }

	# set_variable = { cv_nav_bomber_manpower_k = 0.02 }
	# multiply_variable = { cv_nav_bomber_manpower_k = num_deployed_planes_with_type@cv_nav_bomber_equipment }

	set_variable = { scout_plane_manpower_k = 0.04 }
	# multiply_variable = { scout_plane_manpower_k = num_deployed_planes_with_type@scout_plane_equipment }

	set_variable = { tac_bomber_manpower_k = 0.04 }
	# multiply_variable = { tac_bomber_manpower_k = num_deployed_planes_with_type@tac_bomber_equipment }

	set_variable = { tac_stealth_manpower_k = 0.06 }
	# multiply_variable = { tac_stealth_manpower_k = num_deployed_planes_with_type@tac_stealth_equipment }

	set_variable = { strat_bomber_manpower_k = 0.08 }
	# multiply_variable = { strat_bomber_manpower_k = num_deployed_planes_with_type@strat_bomber_equipment }

	set_variable = { strat_stealth_manpower_k = 0.1 }
	# multiply_variable = { strat_stealth_manpower_k = num_deployed_planes_with_type@strat_stealth_equipment }

	set_variable = { transport_plane_manpower_k = 0.08 }
	# multiply_variable = { transport_plane_manpower_k = num_deployed_planes_with_type@transport_plane_equipment }

	set_variable = { gunship_manpower_k = 0.04 }
	# multiply_variable = { gunship_manpower_k = num_deployed_planes_with_type@gunship_equipment }

	set_variable = { airforce_fielded_manpower_k = 0 }

	add_to_variable = { airforce_fielded_manpower_k = fighter_manpower_k }
	#do not do cv fighters as this is navy stuff
	add_to_variable = { airforce_fielded_manpower_k = light_stealth_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = cas_manpower_k }
	# do not do CV cas as this is naval stuff
	add_to_variable = { airforce_fielded_manpower_k = mca_manpower_k }
	# do not do cv MCA as this is naval stuff
	add_to_variable = { airforce_fielded_manpower_k = interceptor_manpower_k }
	# do not do ASW helicopters, naval stuff
	# DON'T do naval bombers, navy
	# ditto ^ for CV
	add_to_variable = { airforce_fielded_manpower_k = scout_plane_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = tac_bomber_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = tac_stealth_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = strat_bomber_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = strat_stealth_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = transport_plane_manpower_k }
	add_to_variable = { airforce_fielded_manpower_k = gunship_manpower_k }

	set_variable = { naval_aviation_fielded_manpower_k = cv_fighter_manpower_k }
	add_to_variable = { naval_aviation_fielded_manpower_k = cv_cas_manpower_k }
	add_to_variable = { naval_aviation_fielded_manpower_k = cv_MCA_manpower_k }
	add_to_variable = { naval_aviation_fielded_manpower_k = asw_helicopter_manpower_k }
	add_to_variable = { naval_aviation_fielded_manpower_k = nav_bomber_manpower_k }
	add_to_variable = { naval_aviation_fielded_manpower_k = cv_nav_bomber_manpower_k }

	set_variable = { total_airforce_fielded_manpower_k = airforce_fielded_manpower_k }

	if = {
		limit = {
			check_variable = { num_ships_with_type@carrier > 0 }
		}
		add_to_variable = { total_airforce_fielded_manpower_k = naval_aviation_fielded_manpower_k }
		set_variable = { total_naval_manpower_fielded_k = 0 }
	}
	else = {
		set_variable = { total_naval_manpower_fielded_k = naval_aviation_fielded_manpower_k }
	}


	# now it's time to do the navy crap

	set_variable = { corvette_manpower_k = 0.010 }
	multiply_variable = { corvette_manpower_k = num_ships_with_type@corvette }

	set_variable = { frigate_manpower_k = 0.020 }
	multiply_variable = { frigate_manpower_k = num_ships_with_type@frigate }

	set_variable = { destroyer_manpower_k = 0.035 }
	multiply_variable = { destroyer_manpower_k = num_ships_with_type@destroyer }

	set_variable = { cruiser_manpower_k = 0.125 }
	multiply_variable = { cruiser_manpower_k = num_ships_with_type@cruiser }

	set_variable = { battleship_manpower_k = 0.800 }
	multiply_variable = { battleship_manpower_k = num_ships_with_type@battleship }

	set_variable = { carrier_manpower_k = 1.2 }
	multiply_variable = { carrier_manpower_k = num_ships_with_type@carrier }

	set_variable = { submarine_manpower_k = 0.010 }
	multiply_variable = { submarine_manpower_k = num_ships_with_type@submarine }

	add_to_variable = { total_naval_manpower_fielded_k = corvette_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = frigate_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = destroyer_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = cruiser_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = battleship_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = carrier_manpower_k }
	add_to_variable = { total_naval_manpower_fielded_k = submarine_manpower_k }

	set_variable = { army_fielded_manpower_k = 0 }

	set_variable = { anti_tank_manpower_k = 0.4 }
	multiply_variable = { anti_tank_manpower_k = num_battalions_with_type@anti_tank }
	add_to_variable = { army_fielded_manpower_k = anti_tank_manpower_k }

	set_variable = { anti_tank_brigade_manpower_k = 1 }
	multiply_variable = { anti_tank_brigade_manpower_k = num_battalions_with_type@anti_tank_brigade }
	add_to_variable = { army_fielded_manpower_k = anti_tank_brigade_manpower_k }

	set_variable = { mot_anti_tank_brigade_manpower_k = 0.5 }
	multiply_variable = { mot_anti_tank_brigade_manpower_k = num_battalions_with_type@mot_anti_tank_brigade }
	add_to_variable = { army_fielded_manpower_k = mot_anti_tank_brigade_manpower_k }

	set_variable = { anti_air_manpower_k = 0.3 }
	multiply_variable = { anti_air_manpower_k = num_battalions_with_type@anti_air }
	add_to_variable = { army_fielded_manpower_k = anti_air_manpower_k }

	set_variable = { laser_anti_air_manpower_k = 0.25 }
	multiply_variable = { laser_anti_air_manpower_k = num_battalions_with_type@laser_anti_air }
	add_to_variable = { army_fielded_manpower_k = laser_anti_air_manpower_k }

	set_variable = { APC_manpower_k = 1.2 }
	multiply_variable = { APC_manpower_k = num_battalions_with_type@APC }
	add_to_variable = { army_fielded_manpower_k = APC_manpower_k }

	set_variable = { artillery_brigade_manpower_k = 0.5 }
	multiply_variable = { artillery_brigade_manpower_k = num_battalions_with_type@artillery_brigade }
	add_to_variable = { army_fielded_manpower_k = artillery_brigade_manpower_k }

	set_variable = { mot_artillery_brigade_manpower_k = 0.5 }
	multiply_variable = { mot_artillery_brigade_manpower_k = num_battalions_with_type@mot_artillery_brigade }
	add_to_variable = { army_fielded_manpower_k = mot_artillery_brigade_manpower_k }

	set_variable = { artillery_manpower_k = 0.3 }
	multiply_variable = { artillery_manpower_k = num_battalions_with_type@artillery }
	add_to_variable = { army_fielded_manpower_k = artillery_manpower_k }

	set_variable = { cavalry_manpower_k = 0.3 }
	multiply_variable = { cavalry_manpower_k = num_battalions_with_type@cavalry }
	add_to_variable = { army_fielded_manpower_k = cavalry_manpower_k }

	set_variable = { field_hospital_manpower_k = 0.3 }
	multiply_variable = { field_hospital_manpower_k = num_battalions_with_type@field_hospital }
	add_to_variable = { army_fielded_manpower_k = field_hospital_manpower_k }


	set_variable = { garrison_manpower_k = 1 }
	multiply_variable = { garrison_manpower_k = num_battalions_with_type@garrison }
	add_to_variable = { army_fielded_manpower_k = garrison_manpower_k }

	# set_variable = { heavy_armor_manpower_k = 0.5 }
	# multiply_variable = { heavy_armor_manpower_k = num_battalions_with_type@heavy_armor }
	# add_to_variable = { army_fielded_manpower_k = heavy_armor_manpower_k }

	set_variable = { scout_helicopter_company_manpower_k = 0.3 }
	multiply_variable = { scout_helicopter_company_manpower_k = num_battalions_with_type@scout_helicopter_company }
	add_to_variable = { army_fielded_manpower_k = scout_helicopter_company_manpower_k }

	set_variable = { transport_helicopter_company_manpower_k = 0.3 }
	multiply_variable = { transport_helicopter_company_manpower_k = num_battalions_with_type@transport_helicopter_company }
	add_to_variable = { army_fielded_manpower_k = transport_helicopter_company_manpower_k }

	set_variable = { attack_helicopter_company_manpower_k = 0.6 }
	multiply_variable = { attack_helicopter_company_manpower_k = num_battalions_with_type@attack_helicopter_company }
	add_to_variable = { army_fielded_manpower_k = attack_helicopter_company_manpower_k }

	set_variable = { IFV_manpower_k = 0.5 }
	multiply_variable = { IFV_manpower_k = num_battalions_with_type@IFV }
	add_to_variable = { army_fielded_manpower_k = IFV_manpower_k }

	set_variable = { infantry_manpower_k = 1 }
	multiply_variable = { infantry_manpower_k = num_battalions_with_type@infantry }
	add_to_variable = { army_fielded_manpower_k = infantry_manpower_k }

	set_variable = { light_infantry_manpower_k = 0.8 }
	multiply_variable = { light_infantry_manpower_k = num_battalions_with_type@light_infantry }
	add_to_variable = { army_fielded_manpower_k = light_infantry_manpower_k }

	set_variable = { elite_infantry_manpower_k = 1 }
	multiply_variable = { elite_infantry_manpower_k = num_battalions_with_type@elite_infantry }
	add_to_variable = { army_fielded_manpower_k = elite_infantry_manpower_k }

	set_variable = { marine_manpower_k = 1 }
	multiply_variable = { marine_manpower_k = num_battalions_with_type@marine }
	add_to_variable = { army_fielded_manpower_k = marine_manpower_k }

	set_variable = { mountaineers_manpower_k = 1 }
	multiply_variable = { mountaineers_manpower_k = num_battalions_with_type@mountaineers }
	add_to_variable = { army_fielded_manpower_k = mountaineers_manpower_k }

	set_variable = { motorized_manpower_k = 1.2 }
	multiply_variable = { motorized_manpower_k = num_battalions_with_type@motorized }
	add_to_variable = { army_fielded_manpower_k = motorized_manpower_k }

	set_variable = { kugelpanzer_manpower_k = 0.5 }
	multiply_variable = { kugelpanzer_manpower_k = num_battalions_with_type@kugelpanzer }
	add_to_variable = { army_fielded_manpower_k = kugelpanzer_manpower_k }

	# set_variable = { light_armor_manpower_k = 0.5 }
	# multiply_variable = { light_armor_manpower_k = num_battalions_with_type@light_armor }
	# add_to_variable = { army_fielded_manpower_k = light_armor_manpower_k }

	set_variable = { logistics_company_manpower_k = 0.5 }
	multiply_variable = { logistics_company_manpower_k = num_battalions_with_type@logistics_company }
	add_to_variable = { army_fielded_manpower_k = logistics_company_manpower_k }

	set_variable = { transport_helicopter_supply_company_manpower_k = 0.5 }
	multiply_variable = { transport_helicopter_supply_company_manpower_k = num_battalions_with_type@transport_helicopter_supply_company }
	add_to_variable = { army_fielded_manpower_k = transport_helicopter_supply_company_manpower_k }

	set_variable = { maintenance_company_manpower_k = 0.5 }
	multiply_variable = { maintenance_company_manpower_k = num_battalions_with_type@maintenance_company }
	add_to_variable = { army_fielded_manpower_k = maintenance_company_manpower_k }

	set_variable = { maus_manpower_k = 0.6 }
	multiply_variable = { maus_manpower_k = num_battalions_with_type@maus }
	add_to_variable = { army_fielded_manpower_k = maus_manpower_k }

	set_variable = { flakmaus_manpower_k = 0.6 }
	multiply_variable = { flakmaus_manpower_k = num_battalions_with_type@flakmaus }
	add_to_variable = { army_fielded_manpower_k = flakmaus_manpower_k }

	set_variable = { MBT_manpower_k = 0.5 }
	multiply_variable = { MBT_manpower_k = num_battalions_with_type@MBT }
	add_to_variable = { army_fielded_manpower_k = MBT_manpower_k }

	# set_variable = { medium_armor_manpower_k = 0.5 }
	# multiply_variable = { medium_armor_manpower_k = num_battalions_with_type@medium_armor }
	# add_to_variable = { army_fielded_manpower_k = medium_armor_manpower_k }

	set_variable = { military_police_manpower_k = 0.5 }
	multiply_variable = { military_police_manpower_k = num_battalions_with_type@military_police }
	add_to_variable = { army_fielded_manpower_k = military_police_manpower_k }

	# set_variable = { modern_armor_manpower_k = 0.5 }
	# multiply_variable = { modern_armor_manpower_k = num_battalions_with_type@modern_armor }
	# add_to_variable = { army_fielded_manpower_k = modern_armor_manpower_k }

	set_variable = { engineer_manpower_k = 0.3 }
	multiply_variable = { engineer_manpower_k = num_battalions_with_type@engineer }
	add_to_variable = { army_fielded_manpower_k = engineer_manpower_k }

	set_variable = { mbt_engineer_manpower_k = 0.3 }
	multiply_variable = { mbt_engineer_manpower_k = num_battalions_with_type@mbt_engineer }
	add_to_variable = { army_fielded_manpower_k = mbt_engineer_manpower_k }

	set_variable = { air_assault_manpower_k = 0.8 }
	multiply_variable = { air_assault_manpower_k = num_battalions_with_type@air_assault }
	add_to_variable = { army_fielded_manpower_k = air_assault_manpower_k }

	set_variable = { recon_manpower_k = 0.5 }
	multiply_variable = { recon_manpower_k = num_battalions_with_type@recon }
	add_to_variable = { army_fielded_manpower_k = recon_manpower_k }

	set_variable = { mot_recon_manpower_k = 0.5 }
	multiply_variable = { mot_recon_manpower_k = num_battalions_with_type@mot_recon }
	add_to_variable = { army_fielded_manpower_k = mot_recon_manpower_k }

	set_variable = { AC_recon_manpower_k = 0.5 }
	multiply_variable = { AC_recon_manpower_k = num_battalions_with_type@AC_recon }
	add_to_variable = { army_fielded_manpower_k = AC_recon_manpower_k }

	set_variable = { IFV_recon_manpower_k = 0.5 }
	multiply_variable = { IFV_recon_manpower_k = num_battalions_with_type@IFV_recon }
	add_to_variable = { army_fielded_manpower_k = IFV_recon_manpower_k }

	set_variable = { MBT_recon_manpower_k = 0.5 }
	multiply_variable = { MBT_recon_manpower_k = num_battalions_with_type@MBT_recon }
	add_to_variable = { army_fielded_manpower_k = MBT_recon_manpower_k }

	set_variable = { signal_company_recon_manpower_k = 0.5 }
	multiply_variable = { signal_company_recon_manpower_k = num_battalions_with_type@signal_company }
	add_to_variable = { army_fielded_manpower_k = signal_company_recon_manpower_k }

	set_variable = { light_sp_anti_air_brigade_manpower_k = 0.5 }
	multiply_variable = { light_sp_anti_air_brigade_manpower_k = num_battalions_with_type@light_sp_anti_air_brigade }
	add_to_variable = { army_fielded_manpower_k = light_sp_anti_air_brigade_manpower_k }

	set_variable = { sp_anti_air_brigade_manpower_k = 0.5 }
	multiply_variable = { sp_anti_air_brigade_manpower_k = num_battalions_with_type@sp_anti_air_brigade }
	add_to_variable = { army_fielded_manpower_k = sp_anti_air_brigade_manpower_k }

	set_variable = { light_sp_artillery_brigade_manpower_k = 0.5 }
	multiply_variable = { light_sp_artillery_brigade_manpower_k = num_battalions_with_type@light_sp_artillery_brigade }
	add_to_variable = { army_fielded_manpower_k = light_sp_artillery_brigade_manpower_k }

	set_variable = { sp_artillery_brigade_manpower_k = 0.5 }
	multiply_variable = { sp_artillery_brigade_manpower_k = num_battalions_with_type@sp_artillery_brigade }
	add_to_variable = { army_fielded_manpower_k = sp_anti_air_brigade_manpower_k }

	# set_variable = { super_heavy_armor_manpower_k = 0.5 }
	# multiply_variable = { super_heavy_armor_manpower_k = num_battalions_with_type@super_heavy_armor }
	# add_to_variable = { army_fielded_manpower_k = super_heavy_armor_manpower_k }

	set_variable = { manpower_costs = army_fielded_manpower_k }
	multiply_variable = { manpower_costs = gdpc }
	multiply_variable = { manpower_costs = 0.003 }
	multiply_variable = { manpower_costs = modifier@personnel_cost_modifier }
	multiply_variable = { manpower_costs = modifier@personnel_cost_factor_modifier }

	set_variable = { airforce_manpower_costs = total_airforce_fielded_manpower_k }
	multiply_variable = { airforce_manpower_costs = gdpc }
	multiply_variable = { airforce_manpower_costs = 0.010 }
	multiply_variable = { airforce_manpower_costs = modifier@personnel_cost_modifier }
	multiply_variable = { airforce_manpower_costs = modifier@personnel_cost_factor_modifier }

	set_variable = { naval_manpower_costs = total_naval_manpower_fielded_k }
	multiply_variable = { naval_manpower_costs = gdpc }
	multiply_variable = { naval_manpower_costs = 0.008 } # a little trolling
	multiply_variable = { naval_manpower_costs = modifier@personnel_cost_modifier }
	multiply_variable = { naval_manpower_costs = modifier@personnel_cost_factor_modifier }

}


#These variables are just here to look pretty, and not have a billion places after numbers
#i.e. they're purely for display so if they overflow sometimes that's ok it's just life
calculate_display_variables = {
	set_variable = { GDP_trillion = GDP }
	set_variable = { GDP_million = GDP }
	set_variable = { total_budget_trillion = total_budget }
	set_variable = { total_budget_million = total_budget }
	set_variable = { total_expenditures_trillion = total_expenditures }
	set_variable = { total_expenditures_million = total_expenditures }
	set_variable = { civilian_expenditures_trillion = civilian_expenditures }
	set_variable = { civilian_expenditures_million = civilian_expenditures }
	set_variable = { military_expenditures_trillion = military_expenditures }
	set_variable = { military_expenditures_million = military_expenditures }
	set_variable = { money_reserves_trillion = money_reserves }
	set_variable = { money_reserves_million = money_reserves }
	set_variable = { national_debt_trillion = national_debt }
	set_variable = { national_debt_million = national_debt }
	set_variable = { deficit_trillion = deficit }
	set_variable = { deficit_million = deficit }
	set_variable = { manpower_costs_trillion = manpower_costs }
	set_variable = { manpower_costs_million = manpower_costs }
	set_variable = { military_factory_costs_trillion = military_factory_costs }
	set_variable = { military_factory_costs_million = military_factory_costs }
	set_variable = { misc_costs_trillion = misc_costs }
	add_to_variable = { misc_costs_trillion = modifier@misc_costs_modifier }
	set_variable = { misc_costs_million = misc_costs }
	add_to_variable = { misc_costs_million = modifier@misc_costs_modifier }
	set_variable = { misc_income_trillion = misc_income }
	add_to_variable = { misc_income_trillion = modifier@misc_income_modifier }
	set_variable = { misc_income_million = misc_income }
	add_to_variable = { misc_income_million = modifier@misc_income_modifier }
	set_variable = { annual_debt_payments_million = annual_debt_payments }
	set_variable = { annual_debt_payments_trillion = annual_debt_payments }

	set_variable = { COMECON_collective_defense_value_trillion = misc_costs }
	add_to_variable = { COMECON_collective_defense_value_trillion = modifier@misc_costs_modifier }
	set_variable = { COMECON_collective_defense_value_million = misc_costs }
	add_to_variable = { COMECON_collective_defense_value_million = modifier@misc_costs_modifier }
	set_variable = { COMECON_monetary_fund_value_trillion = misc_costs }
	add_to_variable = { COMECON_monetary_fund_value_trillion = modifier@misc_costs_modifier }
	set_variable = { COMECON_monetary_fund_value_million = misc_costs }
	add_to_variable = { COMECON_monetary_fund_value_million = modifier@misc_costs_modifier }

	multiply_variable = { GDP_trillion = 0.001 }
	multiply_variable = { GDP_million = 1000 }
	multiply_variable = { total_budget_trillion = 0.001 }
	multiply_variable = { total_budget_million = 1000 }
	multiply_variable = { total_expenditures_trillion = 0.001 }
	multiply_variable = { total_expenditures_million = 1000 }
	multiply_variable = { civilian_expenditures_trillion = 0.001 }
	multiply_variable = { civilian_expenditures_million = 1000 }
	multiply_variable = { military_expenditures_trillion = 0.001 }
	multiply_variable = { military_expenditures_million = 1000 }
	multiply_variable = { money_reserves_trillion = 0.001 }
	multiply_variable = { money_reserves_million = 1000 }
	multiply_variable = { national_debt_trillion = 0.001 }
	multiply_variable = { national_debt_million = 1000 }
	multiply_variable = { deficit_trillion = 0.001 }
	multiply_variable = { deficit_million = 1000 }
	multiply_variable = { manpower_costs_trillion = 0.001 }
	multiply_variable = { manpower_costs_million = 1000 }
	multiply_variable = { military_factory_costs_trillion = 0.001 }
	multiply_variable = { military_factory_costs_million = 1000 }
	multiply_variable = { misc_costs_trillion = 0.001 }
	multiply_variable = { misc_costs_million = 1000 }
	multiply_variable = { misc_income_trillion = 0.001 }
	multiply_variable = { misc_income_million = 1000 }
	multiply_variable = { annual_debt_payments_trillion = 0.001 }
	multiply_variable = { annual_debt_payments_million = 1000 }

	multiply_variable = { COMECON_collective_defense_value_trillion = 0.001 }
	multiply_variable = { COMECON_collective_defense_value_million = 1000 }
	multiply_variable = { COMECON_monetary_fund_value_trillion = 0.001 }
	multiply_variable = { COMECON_monetary_fund_value_million = 1000 }


	#calculate monthly real GDP growth for display purposes

	set_variable = { GDP_growth_real_monthly = GDP_growth_real }
	divide_variable = { GDP_growth_real_monthly = 12 }

	set_variable = { GDP_growth_real_monthly_number = GDP_growth_real_monthly }
	multiply_variable = { GDP_growth_real_monthly_number = GDP }
	divide_variable = { GDP_growth_real_monthly_number = 100 }

	#central bank policies
	if = {
		limit = { check_variable = { selected_central_bank_id = 0 } }
		set_variable = { central_bank_effectiveness_display = central_bank_effectiveness_0 }
	}
	else_if = {
		limit = { check_variable = { selected_central_bank_id = 1 } }
		set_variable = { central_bank_effectiveness_display = central_bank_effectiveness_1 }
	}
	else_if = {
		limit = { check_variable = { selected_central_bank_id = 2 } }
		set_variable = { central_bank_effectiveness_display = central_bank_effectiveness_2 }
	}
	else_if = {
		limit = { check_variable = { selected_central_bank_id = 3 } }
		set_variable = { central_bank_effectiveness_display = central_bank_effectiveness_3 }
	}

	multiply_variable = { central_bank_effectiveness_display = 100 }
	round_variable = central_bank_effectiveness_display
}

#Covert money reserves to GDP at a 1:2 ratio
invest_money_reserves = {
	set_temp_variable = { temp_money_reserves = money_reserves }
	multiply_temp_variable = { temp_money_reserves = 0.001 } #already converted to billion
	add_to_variable = { GDP = temp_money_reserves }
	set_variable = { money_reserves = 0.0 } #already converted to billion
}

#using your money reserves to pay off any debt you have
money_reserves_to_debt = {
	subtract_from_variable = { national_debt = money_reserves }
	if = {
		limit = { check_variable = { national_debt < 0.0 } } #more reserves than national debt #already converted to billion
		set_variable = { money_reserves = national_debt }
		multiply_variable = { money_reserves = -0.001 } #already converted to billion
		set_variable = { national_debt = 0.0 } #already converted to billion
	}
	else = {
		set_variable = { money_reserves = 0.0 } #already converted to billion
	}
}

# Startup econ system
TNO_startup_econ_type = {

	#economic type setting default
	if = {
		limit = { check_variable = { TNO_economy_type = 0 } }

		if = {
			limit = {
				OR = {
					has_government = socialist
					has_government = communist
					has_government = despotism
					has_government = ultranationalism
				}
			}
			set_variable = { TNO_economy_type = token:Econ_Type_Planned }
		}
		else_if = {
			limit = {
				OR = {
					has_government = fascism
					has_government = national_socialism
				}
			}
			set_variable = { TNO_economy_type = token:Econ_Type_Corporatism }
		}
		else = {
			set_variable = { TNO_economy_type = token:Econ_Type_Capitalism }
		}
	}
	if = {
		limit = {
			check_variable = { economic_centralization = 0 } #if you have an exception, put the change after
		}
		set_variable = { economic_centralization = 50 }
	}
	#dynmods
	if = {
		limit = { check_variable = { TNO_economy_type = token:Econ_Type_Planned } }
		add_dynamic_modifier = { modifier = TNO_economy_type_planned_dynamic_modifier } #Planned (nerds)
	}
	else_if = {
		limit = { check_variable = { TNO_economy_type = token:Econ_Type_Corporatism } }
		add_dynamic_modifier = { modifier = TNO_economy_type_corporatism_dynamic_modifier } #Corpos (mean)
	}
	else = {
		add_dynamic_modifier = { modifier = TNO_economy_type_capitalism_dynamic_modifier } #Crapitalists
	}
}

#determines the economy ideology bar progress (note: not actually a progressbartype)
update_econ_centralization_pos = {
	round_variable = economic_centralization
	clamp_variable = { var = economic_centralization min = 0 max = 100 }
}

#A purely visual update, for whenever you change things/open the econ tab
update_economy_tab = {
	hidden_effect = {
		update_econ_sliders = yes
		economic_centralization_calculation = yes
		calculate_funding_effects_display = yes
		calculate_total_income = yes
		calculate_civilian_expenditures = yes
		calculate_military_expenditures = yes
		calculate_debt_expenditures = yes
		calculate_total_expenditures = yes
		validate_maximal_minimal_positions = yes
		calculate_total_budget = yes #includes deficit calculation

		update_all_econ_pie_charts = yes

		econ_rerender_gdp_graph = yes
		econ_rerender_debt_graph = yes

		TNO_update_policy_effectiveness = yes #I don't think this is actually needed any more. Maybe it is. Hopefully it isn't.... # Spoilers, it's necessary because funding effects are done at the end of the month by laws and we need to update that
		calculate_deficit_to_GDP_ratio = yes
		calculate_debt_to_GDP_ratio = yes
		calculate_deficit_to_debt_ratio = yes
		calculate_deficit_effects_display = yes
		calculate_debt_ceiling = yes
		calculate_debt_effect_on_GDP_growth = yes

		calculate_nominal_GDP_growth = yes

		#calculate_central_bank_effect = yes
		calculate_total_inflation = yes
		calculate_real_gdp_growth = yes

		calculate_inflation_effect = yes
		calculate_display_variables = yes

		reload_gdpc = yes

		update_credit_rating_calculation = yes

		force_update_dynamic_modifier = yes

		update_econ_centralization_pos = yes
		calculate_poverty_dampener_effect = yes
	}
}

validate_maximal_minimal_positions = {
	if = {
		limit = {
			check_variable = { econ_army_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_army_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_army_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_army_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_naval_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_naval_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_naval_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_naval_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_nuclear_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_nuclear_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_nuclear_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_nuclear_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_research_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_research_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_research_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_research_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_social_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_social_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_social_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_social_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_expenditures_minimal_x < 34 }
		}
		set_variable = { econ_admin_expenditures_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_expenditures_maximal_x > 228 }
		}
		set_variable = { econ_admin_expenditures_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_army_maintenance_minimal_x < 34 }
		}
		set_variable = { econ_army_maintenance_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_army_R_D_minimal_x < 34 }
		}
		set_variable = { econ_army_R_D_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_army_logistics_minimal_x < 34 }
		}
		set_variable = { econ_army_logistics_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_army_procurement_minimal_x < 34 }
		}
		set_variable = { econ_army_procurement_minimal_x = 34 }
	}

	if = {
		limit = {
			check_variable = { econ_social_healthcare_minimal_x < 34 }
		}
		set_variable = { econ_social_healthcare_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_social_pensions_minimal_x < 34 }
		}
		set_variable = { econ_social_pensions_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_social_education_minimal_x < 34 }
		}
		set_variable = { econ_social_education_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_social_unemployment_minimal_x < 34 }
		}
		set_variable = { econ_social_unemployment_minimal_x = 34 }
	}

	if = {
		limit = {
			check_variable = { econ_admin_security_minimal_x < 34 }
		}
		set_variable = { econ_admin_security_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_regulations_minimal_x < 34 }
		}
		set_variable = { econ_admin_regulations_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_pollution_minimal_x < 34 }
		}
		set_variable = { econ_admin_pollution_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_bureaucracy_minimal_x < 34 }
		}
		set_variable = { econ_admin_bureaucracy_minimal_x = 34 }
	}

	if = {
		limit = {
			check_variable = { econ_research_science_minimal_x < 34 }
		}
		set_variable = { econ_research_science_minimal_x = 34 }
	}
	if = {
		limit = {
			check_variable = { econ_research_facilities_minimal_x < 34 }
		}
		set_variable = { econ_research_facilities_minimal_x = 34 }
	}

	if = {
		limit = {
			check_variable = { econ_army_maintenance_maximal_x > 228 }
		}
		set_variable = { econ_army_maintenance_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_army_R_D_maximal_x > 228 }
		}
		set_variable = { econ_army_R_D_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_army_logistics_maximal_x > 228 }
		}
		set_variable = { econ_army_logistics_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_army_procurement_maximal_x > 228 }
		}
		set_variable = { econ_army_procurement_maximal_x = 228 }
	}

	if = {
		limit = {
			check_variable = { econ_social_healthcare_maximal_x > 228 }
		}
		set_variable = { econ_social_healthcare_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_social_pensions_maximal_x > 228 }
		}
		set_variable = { econ_social_pensions_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_social_education_maximal_x > 228 }
		}
		set_variable = { econ_social_education_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_social_unemployment_maximal_x > 228 }
		}
		set_variable = { econ_social_unemployment_maximal_x = 228 }
	}

	if = {
		limit = {
			check_variable = { econ_admin_security_maximal_x > 228 }
		}
		set_variable = { econ_admin_security_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_regulations_maximal_x > 228 }
		}
		set_variable = { econ_admin_regulations_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_pollution_maximal_x > 228 }
		}
		set_variable = { econ_admin_pollution_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_admin_bureaucracy_maximal_x > 228 }
		}
		set_variable = { econ_admin_bureaucracy_maximal_x = 228 }
	}

	if = {
		limit = {
			check_variable = { econ_research_science_maximal_x > 228 }
		}
		set_variable = { econ_research_science_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_research_facilities_maximal_x > 228 }
		}
		set_variable = { econ_research_facilities_maximal_x = 228 }
	}
	if = {
		limit = {
			check_variable = { econ_army_expenditures_minimal_x > econ_army_expenditures_maximal_x }
		}
		set_variable = { econ_army_expenditures_minimal_x = econ_army_expenditures_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_naval_expenditures_minimal_x > econ_naval_expenditures_maximal_x }
		}
		set_variable = { econ_naval_expenditures_minimal_x = econ_naval_expenditures_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_nuclear_expenditures_minimal_x > econ_nuclear_expenditures_maximal_x }
		}
		set_variable = { econ_nuclear_expenditures_minimal_x = econ_nuclear_expenditures_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_research_expenditures_minimal_x > econ_research_expenditures_maximal_x }
		}
		set_variable = { econ_research_expenditures_minimal_x = econ_research_expenditures_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_social_expenditures_minimal_x > econ_social_expenditures_maximal_x }
		}
		set_variable = { econ_social_expenditures_minimal_x = econ_social_expenditures_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_admin_expenditures_minimal_x > econ_admin_expenditures_maximal_x }
		}
		set_variable = { econ_admin_expenditures_minimal_x = econ_admin_expenditures_maximal_x }
	}

	if = {
		limit = {
			check_variable = { econ_army_maintenance_minimal_x > econ_army_maintenance_maximal_x }
		}
		set_variable = { econ_army_maintenance_minimal_x = econ_army_maintenance_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_army_R_D_minimal_x > econ_army_R_D_maximal_x }
		}
		set_variable = { econ_army_R_D_minimal_x = econ_army_R_D_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_army_logistics_minimal_x > econ_army_logistics_maximal_x }
		}
		set_variable = { econ_army_logistics_minimal_x = econ_army_logistics_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_army_procurement_minimal_x > econ_army_procurement_maximal_x }
		}
		set_variable = { econ_army_procurement_minimal_x = econ_army_procurement_maximal_x }
	}

	if = {
		limit = {
			check_variable = { econ_social_healthcare_minimal_x > econ_social_healthcare_maximal_x }
		}
		set_variable = { econ_social_healthcare_minimal_x = econ_social_healthcare_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_social_pensions_minimal_x > econ_social_pensions_maximal_x }
		}
		set_variable = { econ_social_pensions_minimal_x = econ_social_pensions_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_social_education_minimal_x > econ_social_education_maximal_x }
		}
		set_variable = { econ_social_education_minimal_x = econ_social_education_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_social_unemployment_minimal_x > econ_social_unemployment_maximal_x }
		}
		set_variable = { econ_social_unemployment_minimal_x = econ_social_unemployment_maximal_x }
	}

	if = {
		limit = {
			check_variable = { econ_admin_security_minimal_x > econ_admin_security_maximal_x }
		}
		set_variable = { econ_admin_security_minimal_x = econ_admin_security_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_admin_regulations_minimal_x > econ_admin_regulations_maximal_x }
		}
		set_variable = { econ_admin_regulations_minimal_x = econ_admin_regulations_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_admin_pollution_minimal_x > econ_admin_pollution_maximal_x }
		}
		set_variable = { econ_admin_pollution_minimal_x = econ_admin_pollution_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_admin_bureaucracy_minimal_x > econ_admin_bureaucracy_maximal_x }
		}
		set_variable = { econ_admin_bureaucracy_minimal_x = econ_admin_bureaucracy_maximal_x }
	}

	if = {
		limit = {
			check_variable = { econ_research_science_minimal_x > econ_research_science_maximal_x }
		}
		set_variable = { econ_research_science_minimal_x = econ_research_science_maximal_x }
	}
	if = {
		limit = {
			check_variable = { econ_research_facilities_minimal_x > econ_research_facilities_maximal_x }
		}
		set_variable = { econ_research_facilities_minimal_x = econ_research_facilities_maximal_x }
	}
}


# Other handy effects #

#HOW TO USE:
#First enter the scope of the country the GDP is being TAKEN FROM
#Then enter the scope of the country the GDP is being transferred to

#EXAMPLE:
#
#MEX = {
#	USA = {
#		transfer_GDP = yes
#	}
#}
#This will transfer Mexico's GDP to the US

#transfer_GDP = {
#	set_temp_variable = { temp_GDP = PREV.GDP }
#	multiply_temp_variable = { temp_GDP = 0.001 } #already converted to billion

#	set_variable = { PREV.GDP = 0.0 } #already converted to billion
#	add_to_variable = { GDP = temp_GDP }
#}

generate_state_gdps = {

	set_variable = { state_value = state_population_k }
	set_variable = { state_value_factor = 1 }

	#State population block
	if = {
		limit = { owner = { check_variable = { poverty_rate > 80 } } }
		multiply_variable = { state_value = 0.1 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 50 } } }
		multiply_variable = { state_value = 0.3 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 25 } } }
		multiply_variable = { state_value = 0.7 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 15 } } }
		multiply_variable = { state_value = 1 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 10 } } }
		multiply_variable = { state_value = 1.3 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 5 } } }
		multiply_variable = { state_value = 1.5 }
	}
	else_if = {
		limit = { owner = { check_variable = { poverty_rate > 0.1 } } }
		multiply_variable = { state_value = 1.7 }
	}
	else = {
		multiply_variable = { state_value = 2 }
	}

	set_temp_variable = { sv_factor_inf = infrastructure_level }
	multiply_temp_variable = { sv_factor_inf = 0.1 }
	add_to_variable = { state_value_factor = sv_factor_inf }

	set_temp_variable = { sv_factor_nuc = building_level@nuclear_reactor }
	multiply_temp_variable = { sv_factor_nuc = 0.3 }
	add_to_variable = { state_value_factor = sv_factor_nuc }

	set_temp_variable = { sv_factor_doc = building_level@dockyard }
	multiply_temp_variable = { sv_factor_doc = 0.1 }
	add_to_variable = { state_value_factor = sv_factor_doc }

	#State category block
	if = {
		limit = { has_state_category = megalopolis }
		multiply_variable = { state_value_factor = 3 }
	}
	else_if = {
		limit = { has_state_category = metropolis }
		multiply_variable = { state_value_factor = 2 }
	}
	else_if = {
		limit = { has_state_category = large_city }
		multiply_variable = { state_value_factor = 1.5 }
	}
	else_if = {
		limit = { has_state_category = city }
		multiply_variable = { state_value_factor = 1.25 }
	}
	else_if = {
		limit = { has_state_category = large_town }
		multiply_variable = { state_value_factor = 1 }
	}
	else_if = {
		limit = { has_state_category = town }
		multiply_variable = { state_value_factor = 0.75 }
	}
	else = {
		multiply_variable = { state_value_factor = 0.5 }
	}

	#Industrial expertise
	if = {
		limit = { owner = { has_idea = tno_industrial_expertise_pre_industrial } }
		multiply_variable = { state_value_factor = 0.7 }
	}
	else_if = {
		limit = { owner = { has_idea = tno_industrial_expertise_incompetent } }
		multiply_variable = { state_value_factor = 0.8 }
	}
	else_if = {
		limit = { owner = { has_idea = tno_industrial_expertise_nascent } }
		multiply_variable = { state_value_factor = 0.90 }
	}
	else_if = {
		limit = { owner = { has_idea = tno_industrial_expertise_experienced } }
		multiply_variable = { state_value_factor = 1 }
	}
	else_if = {
		limit = { owner = { has_idea = tno_industrial_expertise_innovative } }
		multiply_variable = { state_value_factor = 1.10 }
	}
	else = {
		multiply_variable = { state_value_factor = 1 }
	}

	multiply_variable = { state_value = state_value_factor }
	divide_variable = { state_value = 10 } # state GDP now in millions
	set_variable = { gdp_growth = 1 }

	set_temp_variable = { minimum_state_value = state_population_k }
	divide_temp_variable = { minimum_state_value = 40 }
	clamp_variable = { var = state_value min = minimum_state_value }
}


calculate_total_state_gdp = {
	set_variable = { totalstateGDP = 0.0 } #already converted to billion
	THIS = {
		every_controlled_state = {
			set_variable = { state_value_B = state_value }
			divide_variable = { state_value_B = 1000 }

			set_variable = { state_GDPPC = state_value }
			divide_variable = { state_GDPPC = state_population_k }
			multiply_variable = { state_GDPPC = 1000 }

			set_temp_variable = { temp_totalstateGDP = modifier@state_GDP_contribution_to_total_state_GDP_modifier } # this is where we multiply stateGDP by the amount it is contributing (by default, 100%)
			clamp_temp_variable = { var = temp_totalstateGDP max = 0 } # no you may not contribute more than 100% of your modifier to totalGDP
			add_to_temp_variable = { temp_totalstateGDP = 1 }
			multiply_temp_variable = { temp_totalstateGDP = state_value }
			set_variable = { state_GDP_contribution = temp_totalstateGDP }

			divide_temp_variable = { temp_totalstateGDP = 1000 } #convert to B for overflow purposes
			add_to_variable = { PREV.totalstateGDP = temp_totalstateGDP }
			set_variable = { state_GDP_contribution_B = temp_totalstateGDP }
		}
	}
	set_variable = { totalstateGDP_display = totalstateGDP } # since we later do a little trolling with totalstateGDP, it's best to have a display number
	#log ="[THIS.GetName] has total state GDP of [?totalstateGDP]"
	##log ="[GetDateText]: [THIS.GetName]: ran total state GDP calculation script - GDP is $[?totalstateGDP] million. GDP growth is [?GDP_growth]%."
}

resolve_excessive_state_gdp = {
	set_variable = { neededGDP = GDP }
	divide_variable = { neededGDP = totalstateGDP }
	every_owned_state = {
		multiply_variable = { state_value = PREV.neededGDP }
	}
}

generate_russia_state_gdp = {
	hidden_effect = {
		# every_owned_state = {
		# 	generate_state_gdps = yes
		# }
		calculate_total_state_gdp = yes
		generate_country_gdp = yes
		set_variable = { GDP_growth = 5.00 }
		multiply_variable = { GDP = 1.5 } #already converted to billion
		resolve_excessive_state_gdp = yes
	}
}

econ_backfill_graphs = {
	set_temp_variable = { econ_graph_month = 8 }
	clear_array = econ_graph_months
	clear_array = gdp_numbers
	clear_array = debt_to_gdp_numbers
	clear_array = inflation_numbers

	set_temp_variable = { monthly_gdp_growth = GDP_growth }
	divide_temp_variable = { monthly_gdp_growth = 12 }
	divide_temp_variable = { monthly_gdp_growth = 100 }
	multiply_temp_variable = { monthly_gdp_growth = GDP }


	set_temp_variable = { monthly_debt_growth = deficit }
	divide_temp_variable = { monthly_debt_growth = 12 }
	#multiply_temp_variable = { monthly_debt_growth = -1 }

	set_temp_variable = { curr_GDP = GDP }
	set_temp_variable = { curr_debt = national_debt }
	set_temp_variable = { curr_inflation = clamped_inflation_rate }

	for_loop_effect = {
		start = 0
		end = 17
		value = i

		add_to_array = { econ_graph_months = econ_graph_month }
		add_to_temp_variable = { econ_graph_month = 1 }

		add_to_array = { array = gdp_numbers value = curr_GDP index = 0 }

		set_temp_variable = { debt_to_gdp = curr_debt }
		multiply_temp_variable = { debt_to_gdp = 100 }
		divide_temp_variable = { debt_to_gdp = curr_GDP }

		add_to_array = { array = debt_to_gdp_numbers value = debt_to_gdp index = 0 }
		add_to_array = { array = inflation_numbers value = curr_inflation index = 0 }

		# Process GDP
		set_temp_variable = { rand_multiplier = random }
		subtract_from_temp_variable = { rand_multiplier = 0.5 }
		add_to_temp_variable = { rand_multiplier = 1 }
		set_temp_variable = { delta = rand_multiplier }

		multiply_temp_variable = { delta = monthly_gdp_growth }


		subtract_from_temp_variable = { curr_GDP = delta }
		clamp_temp_variable = { var = curr_GDP min = 0 }


		# Process Debt
		set_temp_variable = { rand_multiplier = random }
		subtract_from_temp_variable = { rand_multiplier = 0.5 }
		add_to_temp_variable = { rand_multiplier = 1 }
		set_temp_variable = { delta = rand_multiplier }
		multiply_temp_variable = { delta = monthly_debt_growth }

		subtract_from_temp_variable = { curr_debt = delta }
		clamp_temp_variable = { var = curr_debt min = 0 }

		# Process Inflation
		set_temp_variable = { rand_multiplier = random }
		subtract_from_temp_variable = { rand_multiplier = 0.5 }
		set_temp_variable = { delta = rand_multiplier }

		add_to_temp_variable = { delta = 100 }
		multiply_temp_variable = { delta = curr_inflation }
		divide_temp_variable = { delta = 100 }
		set_temp_variable = { curr_inflation = delta }

		clamp_temp_variable = { var = curr_inflation min = 0 }
	}

	econ_rerender_gdp_graph = yes
	econ_rerender_debt_graph = yes
	econ_rerender_inflation_graph = yes
}

econ_update_graph_monthly = {

	add_to_array = { econ_graph_months = ZZZ.econ_graph_month }
	add_to_array = { gdp_numbers = gdp }

	set_temp_variable = { debt_to_gdp = national_debt }
	multiply_temp_variable = { debt_to_gdp = 100 }
	divide_temp_variable = { debt_to_gdp = gdp }
	add_to_array = { debt_to_gdp_numbers = debt_to_gdp }

	add_to_array = { inflation_numbers = clamped_inflation_rate }

	if = {
		limit = {
			check_variable = { econ_graph_months^num > 17 }
		}
		remove_from_array = { array = econ_graph_months index = 0 }
		remove_from_array = { array = gdp_numbers index = 0 }
		remove_from_array = { array = debt_to_gdp_numbers index = 0 }
		remove_from_array = { array = inflation_numbers index = 0 }
	}

	if = {
		limit = {
			is_ai = no
		}
		econ_rerender_gdp_graph = yes
		econ_rerender_debt_graph = yes
		econ_rerender_inflation_graph = yes
	}
}

econ_rerender_gdp_graph = {
	# Find the maximum and minimum GDP values for the graph
	clear_array = GDP_y_label
	set_temp_variable = { min = gdp_numbers^0 }
	set_temp_variable = { max = gdp_numbers^0 }
	for_loop_effect = {
		start = 0
		end = gdp_numbers^num
		value = i

		if = {
			limit = { check_variable = { gdp_numbers^i > max } }
			set_temp_variable = { max = gdp_numbers^i }
		}
		if = {
			limit = { check_variable = { gdp_numbers^i < min } }
			set_temp_variable = { min = gdp_numbers^i }
		}
	}

	# Simplified version of the range-finding code from Brazil
	# Feel free to move or modify
	# Our range is (min value / 1.1) - (max value * 1.1)
	multiply_temp_variable = { max = 1.1 }
	divide_temp_variable = { min = 1.1 }


	set_temp_variable = { range = max }
	subtract_from_temp_variable = { range = min }

	# Divide the range into 5 equally sized chunks
	set_temp_variable = { display_increment = range }
	divide_temp_variable = { display_increment = 4 }

	set_temp_variable = { gdp_band_display = min }
	for_loop_effect = {
		end = 5
		add_to_array = { GDP_y_label = gdp_band_display index = 0 }
		add_to_temp_variable = { gdp_band_display = display_increment }
	}

	divide_temp_variable = { range = 100 }

	# Get all segments Progress Bar values
	clear_array = gdp_graph_frames
	for_loop_effect = {
		start = 0
		end = 16
		value = i

		set_temp_variable = { j = i }
		add_to_temp_variable = { j = 1 }

		set_temp_variable = { hi = gdp_numbers^j }
		set_temp_variable = { lo = gdp_numbers^i }


		subtract_from_temp_variable = { hi = min }
		subtract_from_temp_variable = { lo = min }
		divide_temp_variable = { hi = range }
		divide_temp_variable = { lo = range }

		round_temp_variable = hi
		round_temp_variable = lo

		set_temp_variable = { endpoints = lo }
		multiply_temp_variable = { endpoints = 1000 }
		add_to_temp_variable = { endpoints = hi }
		add_to_array = { gdp_graph_frames = endpoints }
	}

	add_to_variable = { TNO_economy_GUI_dirty = 1 }
}

econ_rerender_inflation_graph = {
	clear_array = inflation_y_label
	# Find the maximum and minimum inflation values for the graph
	set_temp_variable = { min = inflation_numbers^0 }
	set_temp_variable = { max = inflation_numbers^0 }
	for_loop_effect = {
		start = 0
		end = inflation_numbers^num
		value = i

		if = {
			limit = { check_variable = { inflation_numbers^i > max } }
			set_temp_variable = { max = inflation_numbers^i }
		}
		if = {
			limit = { check_variable = { inflation_numbers^i < min } }
			set_temp_variable = { min = inflation_numbers^i }
		}
	}

	# Simplified version of the range-finding code from Brazil
	# Feel free to move or modify
	# Our range is (min value / 1.1) - (max value * 1.1)
	multiply_temp_variable = { max = 1.1 }
	divide_temp_variable = { min = 1.1 }

	if = {
		limit = { check_variable = { min = max } }
		add_to_temp_variable = { max = 0.05 }
		subtract_from_temp_variable = { min = 0.05 }
	}
	if = {
		limit = { check_variable = { min = 0 } }
		set_temp_variable = { to_sub = max }
		multiply_temp_variable = { to_sub = 0.1 }
		subtract_from_temp_variable = { min = to_sub }
	}

	set_temp_variable = { range = max }
	subtract_from_temp_variable = { range = min }

	# Divide the range into 5 equally sized chunks
	set_temp_variable = { display_increment = range }
	divide_temp_variable = { display_increment = 4 }

	set_temp_variable = { inflation_band_display = min }
	for_loop_effect = {
		end = 5
		add_to_array = { inflation_y_label = inflation_band_display index = 0 }
		add_to_temp_variable = { inflation_band_display = display_increment }
	}

	divide_temp_variable = { range = 100 }

	# Get all segments Progress Bar values
	clear_array = inflation_graph_frames
	for_loop_effect = {
		start = 0
		end = 16
		value = i

		set_temp_variable = { j = i }
		add_to_temp_variable = { j = 1 }

		set_temp_variable = { hi = inflation_numbers^j }
		set_temp_variable = { lo = inflation_numbers^i }


		subtract_from_temp_variable = { hi = min }
		subtract_from_temp_variable = { lo = min }
		divide_temp_variable = { hi = range }
		divide_temp_variable = { lo = range }

		round_temp_variable = hi
		round_temp_variable = lo

		set_temp_variable = { endpoints = lo }
		multiply_temp_variable = { endpoints = 1000 }
		add_to_temp_variable = { endpoints = hi }
		add_to_array = { inflation_graph_frames = endpoints }

	}

	add_to_variable = { TNO_economy_GUI_dirty = 1 }
}

econ_rerender_debt_graph = {
	# Find the maximum and minimum debt values for the graph
	clear_array = debt_y_label
	set_temp_variable = { min = debt_to_gdp_numbers^0 }
	set_temp_variable = { max = debt_to_gdp_numbers^0 }
	for_loop_effect = {
		start = 0
		end = debt_to_gdp_numbers^num
		value = i

		if = {
			limit = { check_variable = { debt_to_gdp_numbers^i > max } }
			set_temp_variable = { max = debt_to_gdp_numbers^i }
		}
		if = {
			limit = { check_variable = { debt_to_gdp_numbers^i < min } }
			set_temp_variable = { min = debt_to_gdp_numbers^i }
		}
	}

	# Simplified version of the range-finding code from Brazil
	# Feel free to move or modify
	# Our range is (min value / 1.1) - (max value * 1.1)
	multiply_temp_variable = { max = 1.1 }
	divide_temp_variable = { min = 1.1 }

	if = {
		limit = { check_variable = { min = max } }
		add_to_temp_variable = { max = 0.05 }
		subtract_from_temp_variable = { min = 0.05 }
	}
	if = {
		limit = { check_variable = { min = 0 } }
		set_temp_variable = { to_sub = max }
		multiply_temp_variable = { to_sub = 0.1 }
		subtract_from_temp_variable = { min = to_sub }
	}

	set_temp_variable = { range = max }
	subtract_from_temp_variable = { range = min }

	# Divide the range into 5 equally sized chunks
	set_temp_variable = { display_increment = range }
	divide_temp_variable = { display_increment = 4 }

	set_temp_variable = { debt_band_display = min }

	for_loop_effect = {
		end = 5
		add_to_array = { debt_y_label = debt_band_display index = 0 }
		add_to_temp_variable = { debt_band_display = display_increment }
	}

	divide_temp_variable = { range = 100 }

	# Get all segments Progress Bar values
	clear_array = debt_to_gdp_frames
	for_loop_effect = {
		start = 0
		end = 16
		value = i

		set_temp_variable = { j = i }
		add_to_temp_variable = { j = 1 }

		set_temp_variable = { hi = debt_to_gdp_numbers^j }
		set_temp_variable = { lo = debt_to_gdp_numbers^i }


		subtract_from_temp_variable = { hi = min }
		subtract_from_temp_variable = { lo = min }
		divide_temp_variable = { hi = range }
		divide_temp_variable = { lo = range }

		round_temp_variable = hi
		round_temp_variable = lo

		set_temp_variable = { endpoints = lo }
		multiply_temp_variable = { endpoints = 1000 }
		add_to_temp_variable = { endpoints = hi }
		add_to_array = { debt_to_gdp_frames = endpoints }

	}


	add_to_variable = { TNO_economy_GUI_dirty = 1 }
}

generate_econ_rankings = {
	ZZZ = {
		clear_array = global.econ_countries
		every_country = {
			limit = { NOT = { has_country_flag = TNO_exclude_from_econ_ranking } }
			add_to_array = { global.econ_countries = THIS }
		}

		get_sorted_scored_countries = {
			scorer = GDP_rank_scorer
			array = global.econ_countries
		}

		# Set up ranking positions
		for_each_scope_loop = {
			array = global.econ_countries
			add_to_variable = { global.econ_countries_index = 1 }
			set_variable = { econ_ranking = global.econ_countries_index }
		}
		clear_variable = global.econ_countries_index
	}
}

econ_get_world_gdp = {
	ZZZ = {
		set_variable = { total_world_gdp = 0 }
		every_country = {
			limit = { NOT = { has_country_flag = TNO_exclude_from_econ_ranking } }
			add_to_variable = { ZZZ.total_world_gdp = GDP }
		}
	}
}

econ_reload_poverty_effects = {

	# curve used https://www.desmos.com/calculator/wiesidbpai (still needs to account for bonuses??)

	set_temp_variable = { poverty_effect_temp_cuber = poverty_rate }
	multiply_temp_variable = { poverty_effect_temp_cuber = 0.01 } #convert to a real number
	add_to_temp_variable = { poverty_effect_temp_cuber = 0.1 }
	set_temp_variable = { poverty_effect_temp_calc = poverty_effect_temp_cuber }

	multiply_temp_variable = { poverty_effect_temp_cuber = poverty_effect_temp_calc }

	multiply_temp_variable = { poverty_effect_temp_cuber = poverty_effect_temp_calc } # cube that shit!


	set_temp_variable = { poverty_effect_numerator = poverty_effect_temp_cuber }
	set_temp_variable = { poverty_effect_denominator = poverty_effect_temp_cuber }

	multiply_temp_variable = { poverty_effect_numerator = 0.5 }
	subtract_from_temp_variable = { poverty_effect_numerator = 1 }

	multiply_temp_variable = { poverty_effect_denominator = 20 }
	add_to_temp_variable = { poverty_effect_denominator = 1 }

	divide_temp_variable = { poverty_effect_numerator = poverty_effect_denominator }
	set_variable = { poverty_effect_multiplier = poverty_effect_numerator }
	add_to_variable = { poverty_effect_multiplier = 1 }

	set_variable = { poverty_rate_stability_effect = poverty_effect_multiplier }
	set_variable = { poverty_rate_war_support_effect = poverty_effect_multiplier }
	set_variable = { poverty_rate_conscription_effect = poverty_effect_multiplier }
	set_variable = { poverty_rate_monthly_pop_effect = poverty_effect_multiplier }
	set_variable = { poverty_rate_research_effect = poverty_effect_multiplier }
	set_variable = { poverty_consumer_goods_effect = poverty_effect_multiplier }
	set_variable = { poverty_academic_admin_socdev_effect = poverty_effect_multiplier }
	set_variable = { poverty_agriculture_industrial_socdev_effect = poverty_effect_multiplier }
	set_variable = { poverty_manpower_cost_effect = poverty_effect_multiplier }

	multiply_variable = { poverty_rate_stability_effect = -0.3 }
	multiply_variable = { poverty_rate_war_support_effect = -0.2 }
	multiply_variable = { poverty_rate_conscription_effect = 0.2 }
	multiply_variable = { poverty_rate_monthly_pop_effect = 0.8 }
	multiply_variable = { poverty_rate_research_effect = -0.2 }
	multiply_variable = { poverty_consumer_goods_effect = -0.5 }
	multiply_variable = { poverty_academic_admin_socdev_effect = -0.5 }
	multiply_variable = { poverty_agriculture_industrial_socdev_effect = -0.8 }
	multiply_variable = { poverty_manpower_cost_effect = -0.25 }

}

reload_gdpc = {
	set_variable = { gdpc = gdp }
	divide_variable = { gdpc = total_pop_m }
	set_variable = { gdpc_display = gdpc }
	multiply_variable = { gdpc_display = 1000 }

	# calculate root GDPC (used for lots of social spending things)

	set_variable = { sr_arg_number = gdpc_display } #use gdpc_display for higher accuracy
	square_root_babylonian = yes
	set_variable = { gdpc_root_display = sr_ret_number }
	set_variable = { gdpc_root = sr_ret_number }
	divide_variable = { gdpc_root = 1000 }
}

reload_every_state_gdps = {
	every_country = {
		every_owned_state = {
			generate_state_gdps = yes
		}
	}
}

start_fiscal_crisis_alert = {
	set_country_flag = Fiscal_Crisis_Active_Timer
	set_temp_variable = { alert_id = token:Alert_FiscalCrisis }
	add_TNO_alert_unless_exists = yes
	#log ="tried to spawn fiscal crisis alert with alert id [?alert_id]"
	if = {
		limit = { #trigger it with 1 month to spare if you are more than 25% above your debt limit somehow
			set_temp_variable = { temp_debt_limit = debt_ceiling }
			set_temp_variable = { temp_debt_level = debt_to_GDP_ratio }
			subtract_from_temp_variable = { temp_debt_level = temp_debt_limit }
			check_variable = { temp_debt_level > 0.25 }
		}
		set_variable = { Months_Till_Fiscal = 1 }
	}

	else = {
		set_variable = { Months_Till_Fiscal = 6 }
	}

	add_ideas = TNO_looming_fiscal_crisis
}

end_fiscal_crisis_alert = {
	clr_country_flag = Fiscal_Crisis_Active_Timer
	clear_variable = Months_Till_Fiscal
	set_temp_variable = { alert_id = token:Alert_FiscalCrisis }
	remove_TNO_alert = yes
	remove_ideas = TNO_looming_fiscal_crisis
}

start_fiscal_crisis = {
	clr_country_flag = Fiscal_Crisis_Active_Timer
	clear_variable = Months_Till_Fiscal
	country_event = { id = fiscal_crisis.0 }
	set_temp_variable = { alert_id = token:Alert_FiscalCrisis }
	remove_TNO_alert = yes
	remove_ideas = TNO_looming_fiscal_crisis
	#log ="[GetDateText]: [THIS.GetTag]: Got absoutely fucked by a Fiscal Crisis :vonsusen:"
}

calculate_poverty_dampener_effect = {
	set_variable = { poverty_dampener_effect = 200 }
	set_temp_variable = { temp_poverty_dampener_effect = -100 }
	multiply_temp_variable = { temp_poverty_dampener_effect = poverty_rate }
	subtract_from_temp_variable = { temp_poverty_dampener_effect = 100 }
	divide_variable = { poverty_dampener_effect = temp_poverty_dampener_effect }
	add_to_variable = { poverty_dampener_effect = 1.181 } #magic number
	clamp_variable = {
		var = poverty_dampener_effect
		min = 0
		max = 1
	}
}

poverty_monthly_calculation = {
	set_temp_variable = { temp_poverty_rate_monthly = poverty_monthly_change }
	add_to_temp_variable = { temp_poverty_rate_monthly = modifier@poverty_monthly_rate }

	calculate_poverty_dampener_effect = yes
	multiply_temp_variable = { temp_poverty_rate_monthly = poverty_dampener_effect }
	subtract_from_variable = { poverty_rate = temp_poverty_rate_monthly }

	if = {
		limit = { check_variable = { poverty_rate > 40 } }
		divide_variable = { poverty_monthly_change = 1.02 }
	} else = {
		divide_variable = { poverty_monthly_change = 1.06 }
	}

	clamp_variable = {
		var = poverty_rate
		min = 0
		max = 100
	}

	econ_reload_poverty_effects = yes
}

PU_trade_integration_calculation = {

	# net PUs (used for GDP)

	set_temp_variable = { net_pus_from_trade_last_month = 0 }

	for_each_loop = {
		array = TNO_net_pu_trade
		value = v

		add_to_temp_variable = { net_pus_from_trade_last_month = v }
	}

	divide_temp_variable = { net_pus_from_trade_last_month = TNO_net_pu_trade^num }
	set_variable = { net_PUs_trade = net_pus_from_trade_last_month }
	set_variable = { total_trade_value = net_PUs_trade }
	divide_variable = { total_trade_value = pu_to_gdp_ratio }

	set_variable = { total_trade_value_display = total_trade_value }
	if = {
		limit = {
			check_variable = { total_trade_value_display < 0 }
		}
		multiply_variable = { total_trade_value_display = -1 }
	}

	clear_array = TNO_net_pu_trade

	#PUs spent on imports (used for tariffs)

	set_temp_variable = { pus_to_imports_last_month = 0 }

	for_each_loop = {
		array = TNO_pu_trade_imports
		value = v

		add_to_temp_variable = { pus_to_imports_last_month = v }
	}
	divide_temp_variable = { pus_to_imports_last_month = TNO_pu_trade_imports^num }

	set_variable = { PUs_to_imports = pus_to_imports_last_month }
	set_variable = { imports_value = PUs_to_imports }
	divide_variable = { imports_value = pu_to_gdp_ratio }

	clear_array = TNO_pu_trade_imports

	set_temp_variable = { pus_to_exports_last_month = 0 }

	for_each_loop = {
		array = TNO_pu_trade_exports
		value = v

		add_to_temp_variable = { pus_to_exports_last_month = v }
	}

	clear_array = TNO_pu_trade_exports

	set_variable = { PUs_to_exports = pus_to_exports_last_month }
	set_variable = { exports_value = PUs_to_exports }
	divide_variable = { exports_value = pu_to_gdp_ratio }

	set_temp_variable = { PUs_to_CGs_last_month = 0 }
	for_each_loop = {
		array = TNO_cg_production
		value = v

		add_to_temp_variable = { PUs_to_CGs_last_month = v }
	}
	divide_temp_variable = { PUs_to_CGs_last_month = TNO_cg_production^num }
	set_variable = { PUs_to_CGs = PUs_to_CGs_last_month }
	set_variable = { CG_production_value = PUs_to_CGs }
	divide_variable = { CG_production_value = pu_to_gdp_ratio }

	clear_array = TNO_cg_production
}

economic_centralization_calculation = {

	if = {
		limit = { check_variable = { TNO_economy_type = token:Econ_Type_Capitalism } }
		calculate_market_centralization_effect = yes
	}
	else_if = {
		limit = { check_variable = { TNO_economy_type = token:Econ_Type_Corporatism } }
		calculate_corporatism_centralization_effect = yes
	}
	else = {
		calculate_planned_centralization_effect = yes
	}
}

calculate_market_centralization_effect = {

	set_variable = { command_factory_output_centralization_effect = economic_centralization }
	set_variable = { command_resource_extraction_centralization_effect = economic_centralization }
	set_variable = { market_production_efficiency_cap_centralization_effect = economic_centralization }

	set_variable = { market_consumer_goods_centralization_effect = 100 }
	set_variable = { market_gdp_growth_centralization_effect = .10 }
	set_variable = { command_production_efficiency_start_centralization_effect = economic_centralization }
	set_variable = { command_construction_speed_centralization_effect = economic_centralization }

	subtract_from_variable = { market_consumer_goods_centralization_effect = 100 }
	#subtract_from_variable = { market_gdp_growth_centralization_effect = 100 }
	subtract_from_variable = { command_production_efficiency_start_centralization_effect = 100 }
	subtract_from_variable = { command_construction_speed_centralization_effect = 100 }

	multiply_variable = { market_consumer_goods_centralization_effect = -1 }
	#multiply_variable = { market_gdp_growth_centralization_effect = -1 }
	multiply_variable = { command_production_efficiency_start_centralization_effect = -1 }
	multiply_variable = { command_construction_speed_centralization_effect = -1 }

	divide_variable = { command_factory_output_centralization_effect = 1000 } #max is 10% factory output bonus
	divide_variable = { command_resource_extraction_centralization_effect = 1000 } #max is 10% resource bonus
	divide_variable = { command_production_efficiency_start_centralization_effect = 1000 } #max is 10% starting eff

	divide_variable = { market_consumer_goods_centralization_effect = 1000 } #max is 20% more consumer goods produced (with the added bonus)
	#divide_variable = { market_gdp_growth_centralization_effect = 500 } #max is 20% more GDP growth
	divide_variable = { market_production_efficiency_cap_centralization_effect = 1000 } #max is 10% more efficiency
	divide_variable = { command_construction_speed_centralization_effect = 1000 } #max is 10%

	set_variable = { actual_market_consumer_goods_centralization_effect = market_consumer_goods_centralization_effect }
	set_variable = { actual_command_factory_output_centralization_effect = command_factory_output_centralization_effect }
	set_variable = { actual_command_construction_speed_centralization_effect = command_construction_speed_centralization_effect }

	add_to_variable = { market_consumer_goods_centralization_effect = .10 }
	add_to_variable = { command_factory_output_centralization_effect = .05 }
	add_to_variable = { command_construction_speed_centralization_effect = .05 }
}

calculate_planned_centralization_effect = {

	set_variable = { command_resource_extraction_centralization_effect = economic_centralization }
	set_variable = { market_production_efficiency_cap_centralization_effect = economic_centralization }
	set_variable = { command_construction_speed_centralization_effect = economic_centralization }

	set_variable = { command_factory_output_centralization_effect = economic_centralization }
	set_variable = { market_consumer_goods_centralization_effect = 100 }
	#set_variable = { market_gdp_growth_centralization_effect = economic_centralization }
	set_variable = { command_production_efficiency_start_centralization_effect = economic_centralization }

	subtract_from_variable = { market_consumer_goods_centralization_effect = 100 }
	#subtract_from_variable = { market_gdp_growth_centralization_effect = 100 }
	subtract_from_variable = { command_production_efficiency_start_centralization_effect = 100 }
	subtract_from_variable = { command_factory_output_centralization_effect = 100 }

	multiply_variable = { market_consumer_goods_centralization_effect = -1 }
	#multiply_variable = { market_gdp_growth_centralization_effect = -1 }
	multiply_variable = { command_production_efficiency_start_centralization_effect = -1 }
	multiply_variable = { command_factory_output_centralization_effect = -1 }

	divide_variable = { command_resource_extraction_centralization_effect = 1000 } #max is 10% resource bonus
	divide_variable = { market_production_efficiency_cap_centralization_effect = 1000 } #max is 15% starting eff
	divide_variable = { command_construction_speed_centralization_effect = 1000 } #max is 20% construction speed

	divide_variable = { market_consumer_goods_centralization_effect = 2000 } #max is 5% more consumer goods produced
	#divide_variable = { market_gdp_growth_centralization_effect = 500 } #max is 20% more GDP growth
	divide_variable = { command_production_efficiency_start_centralization_effect = 1000 } #max is 10% more efficiency
	divide_variable = { command_factory_output_centralization_effect = 1000 } #max is 20% factory output bonus

	set_variable = { actual_command_factory_output_centralization_effect = command_factory_output_centralization_effect }
	set_variable = { actual_command_construction_speed_centralization_effect = command_construction_speed_centralization_effect }

	add_to_variable = { command_construction_speed_centralization_effect = .1 }
	add_to_variable = { command_factory_output_centralization_effect = .1 }

	# do math here with centralization value to calculate centralization effects for planned
}
calculate_corporatism_centralization_effect = {

	set_variable = { command_factory_output_centralization_effect = economic_centralization }
	set_variable = { command_resource_extraction_centralization_effect = economic_centralization }
	set_variable = { market_production_efficiency_cap_centralization_effect = economic_centralization }
	set_variable = { command_construction_speed_centralization_effect = economic_centralization }

	set_variable = { market_consumer_goods_centralization_effect = 100 }
	set_variable = { market_gdp_growth_centralization_effect = economic_centralization }
	set_variable = { command_production_efficiency_start_centralization_effect = economic_centralization }

	subtract_from_variable = { market_consumer_goods_centralization_effect = 100 }
	subtract_from_variable = { market_gdp_growth_centralization_effect = 100 }
	subtract_from_variable = { command_production_efficiency_start_centralization_effect = 100 }

	multiply_variable = { market_consumer_goods_centralization_effect = -1 }
	multiply_variable = { market_gdp_growth_centralization_effect = -1 }
	multiply_variable = { command_production_efficiency_start_centralization_effect = -1 }

	divide_variable = { command_factory_output_centralization_effect = 666.666 } #max is 15% factory output bonus
	divide_variable = { command_resource_extraction_centralization_effect = 2000 } #max is 5% resource bonus
	divide_variable = { market_production_efficiency_cap_centralization_effect = 1000 } #max is 10% starting eff
	divide_variable = { command_construction_speed_centralization_effect = 1000 } #max is 10% construction speed

	divide_variable = { market_consumer_goods_centralization_effect = 1000 } #max is 20% more consumer goods produced
	divide_variable = { market_gdp_growth_centralization_effect = 1000 } #max is 15% more GDP growth
	divide_variable = { command_production_efficiency_start_centralization_effect = 666.666 } #max is 15% more efficiency

	set_variable = { actual_market_consumer_goods_centralization_effect = market_consumer_goods_centralization_effect }
	set_variable = { actual_market_gdp_growth_centralization_effect = market_gdp_growth_centralization_effect }

	add_to_variable = { market_consumer_goods_centralization_effect = .10 }
	add_to_variable = { market_gdp_growth_centralization_effect = .05 }

	# do math here with centralization value to calculate centralization effects for corporatism
}




econ_calculations_ON_MONTHLY = {

	if = {
		limit = { is_ai = yes }
		econ_calculations_ON_MONTHLY_AI = yes #update_ai_invest_reserves = yes
	}
	else = { econ_calculations_ON_MONTHLY_Human = yes }
}


econ_calculations_ON_MONTHLY_AI = {
	update_ai_invest_reserves = yes
	economic_centralization_calculation = yes
	poverty_monthly_calculation = yes
	PU_trade_integration_calculation = yes
	build_sphere_leader_array = yes

	update_econ_sliders = yes
	calculate_funding_effects = yes
	calculate_total_income = yes
	calculate_civilian_expenditures = yes
	calculate_military_expenditures = yes
	calculate_debt_expenditures = yes
	calculate_total_expenditures = yes
	validate_maximal_minimal_positions = yes
	calculate_total_budget = yes

	calculate_deficit_to_GDP_ratio = yes
	calculate_debt_to_GDP_ratio = yes
	calculate_deficit_to_debt_ratio = yes
	apply_deficit_effects_monthly = yes
	calculate_debt_ceiling = yes
	calculate_debt_effect_on_GDP_growth = yes

	update_credit_rating_calculation = yes
	apply_credit_rating_progress_change = yes

	apply_central_bank_policy = yes

	force_update_dynamic_modifier = yes
	calculate_nominal_GDP_growth = yes

	set_temp_variable = { GDP_growth_no_rubberband_inflation_max = GDP_growth_real }
	add_to_temp_variable = { GDP_growth_no_rubberband_inflation_max = rubberband_inflation_rate }
	if = {
		limit = {
		check_variable = {
			var = GDP_growth_no_rubberband_inflation_max
			value = 10
			compare = less_than_or_equals
			}
		}
		set_variable = { rubberband_inflation_rate = 0 }
	}
	if = { limit = { check_variable = { GDP_growth_real > 10 } }
		GDP_rubberbanding_check = yes
	}
	calculate_total_inflation = yes
	calculate_inflation_effect = yes
	apply_inflation_effect_month = yes
	calculate_real_gdp_growth = yes

	resolve_spending = yes
	resolve_negative_cases = yes
	autopay_reserves = yes
	monthly_GDP_growth_state = yes

	fiscal_crisis_check = yes
	recalculate_GDP_and_PUs_on_demand = yes
	update_ai_slider_logic = yes

	# New and better - Fedacking > Lamounier
	calculate_building_variables = yes
	monthly_nuclear_production = yes
}

econ_calculations_ON_MONTHLY_Human = {
	economic_centralization_calculation = yes
	poverty_monthly_calculation = yes
	PU_trade_integration_calculation = yes
	build_sphere_leader_array = yes

	econ_update_graph_monthly = yes # this action is the ONLY action that is run every month for econstuff
	update_inflation_cycling = yes
	update_econ_sliders = yes
	calculate_funding_effects_display = yes #used by funding effects to avoid duplicating effort
	calculate_funding_effects = yes
	calculate_total_income = yes
	calculate_civilian_expenditures = yes
	calculate_military_expenditures = yes
	calculate_debt_expenditures = yes
	calculate_total_expenditures = yes
	validate_maximal_minimal_positions = yes
	calculate_total_budget = yes

	# TNO_update_policy_effectiveness = yes it is my sincere hope that this is no longer needed
	calculate_deficit_to_GDP_ratio = yes
	calculate_debt_to_GDP_ratio = yes
	calculate_deficit_to_debt_ratio = yes
	calculate_deficit_effects_display = yes
	apply_deficit_effects_monthly = yes
	calculate_debt_ceiling = yes
	calculate_debt_effect_on_GDP_growth = yes


	update_credit_rating_calculation = yes
	apply_credit_rating_progress_change = yes

	apply_central_bank_policy = yes

	if = {
		limit = { 845 = { OWNER = { check_variable = { base_conversion_rate = 5 } has_country_flag = tno_playable_country } } }
		random_list = { 67 = {} 33 = { USA_conversion_rate_loop = yes } }
	}

	force_update_dynamic_modifier = yes
	calculate_nominal_GDP_growth = yes
	set_temp_variable = { GDP_growth_no_rubberband_inflation_max = GDP_growth_real }
	add_to_temp_variable = { GDP_growth_no_rubberband_inflation_max = rubberband_inflation_rate }
	if = {
		limit = {
		check_variable = {
			var = GDP_growth_no_rubberband_inflation_max
			value = 10
			compare = less_than_or_equals
			}
		}
		set_variable = { rubberband_inflation_rate = 0 }
	}
	if = { limit = { check_variable = { GDP_growth_real > 10 } }
		GDP_rubberbanding_check = yes
	}
	calculate_total_inflation = yes
	calculate_inflation_effect = yes
	apply_inflation_effect_month = yes
	calculate_real_gdp_growth = yes
	store_old_values = yes

	resolve_spending = yes
	resolve_negative_cases = yes
	autopay_reserves = yes

	monthly_GDP_growth_state = yes

	fiscal_crisis_check = yes

	#TNO_update_policy_effectiveness = yes (done elsewhere thank god)

	recalculate_GDP_and_PUs_on_demand = yes

	# New and better - Fedacking > Lamounier
	calculate_building_variables = yes
	monthly_nuclear_production = yes
	monthly_social_data = yes
}

build_sphere_leader_array = {
	if = {
		limit = {
			has_country_flag = HAS_ECON_SPHERE
		}
		add_to_array = { GLOBAL.econ_sphere_leaders = THIS }
	}
}

fiscal_crisis_check = {
	if = { limit = { NOT = { has_country_flag = ECON_ONGOING_FISCAL_CRISIS } }
		if = { # Check for Fiscal Crisis, skip all other blocks if this is true
			limit = {
				check_variable = { debt_to_GDP_ratio < debt_ceiling }
				NOT = {
					has_country_flag = Fiscal_Crisis_Active_Timer
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { debt_to_GDP_ratio > debt_ceiling }
				NOT = {
					has_country_flag = Fiscal_Crisis_Active_Timer
				}
			}
			start_fiscal_crisis_alert = yes
		}
		else_if = {
			limit = {
				check_variable = { Months_Till_Fiscal = 0 }
			}
			start_fiscal_crisis = yes
		}
		else_if = {
			limit = {
				has_country_flag = Fiscal_Crisis_Active_Timer
				check_variable = { debt_to_GDP_ratio < debt_ceiling }
			}
			end_fiscal_crisis_alert = yes
		}
		else_if = {
			limit = {
				has_country_flag = Fiscal_Crisis_Active_Timer
			}
			add_to_variable = { Months_Till_Fiscal = -1 }
		}
	}
}

ZZZ_econ_inflation_cycling_calculation = {
#alex's inflation cycling. Calculation cheap sine curve approximaton.
#x(k+1)=x(k)+(y(k)/n), y(k+1)=y(k)(x(k+1))/n in mathematical terms, where k is the month.
#Exact curve is xk=(x0cos((2k1))+y0sin(2k))sec, yk=(y0cos((2k+1))x0sin(2k))sec where  = arcsin(1/2n)
#cycles twice just under every 18 months.
#x0 = starting value of xcycling, currently 0
#y0 = starting value of ycycling, currently 0.125, affects amplitude of curve
#n = 3, affects how quickly it cycles.
	ZZZ = {
		set_temp_variable = { xplus1 = ycycling }
		divide_temp_variable = { xplus1 = 3 }
		add_to_variable = { xcycling = xplus1 }

		set_temp_variable = { yplus1 = xcycling }
		divide_temp_variable = { yplus1 = 3 }
		subtract_from_variable = { ycycling = yplus1 }

		set_variable = { global_inflation_cyling_effect = xcycling }
	}
}

update_inflation_cycling = {
	set_variable = { inflation_cycling_effect = ZZZ.global_inflation_cyling_effect }
	multiply_variable = { inflation_cycling_effect = last_month_real_GDP_growth }
	#divide_variable = { inflation_cycling_effect = 2 }


	randomize_temp_variable = {
		var = inflation_random_element
		distribution = binomial
		min = -1
		max = 1
	}

	multiply_temp_variable = { inflation_random_element = last_month_real_GDP_growth }
	divide_temp_variable = { inflation_random_element = 10 }

	set_variable = { inflation_cycling_random_element = inflation_random_element }
	add_to_variable = { inflation_cycling_effect = inflation_cycling_random_element }
}

monthly_GDP_growth_state = {

	# get monthly real gdp growth
	set_temp_variable = { temp_real_GDP_growth = GDP_growth_real }
	set_temp_variable = { total_state_GDP_added = 0 }
	set_variable = { prev_total_state_GDP = totalstateGDP }

	THIS = {
		every_controlled_state = {
			CONTROLLER = {
				set_temp_variable = { temp_real_GDP_growth = GDP_growth_real }
			}
			add_to_temp_variable = { temp_real_gdp_growth = modifier@state_GDP_growth_modifier }
			#log = "[?temp_real_GDP_growth] is temp real gdp growth"
			set_temp_variable = { temp_infra_damaged = damaged_building_level@infrastructure }
			divide_temp_variable = { temp_infra_damaged = infrastructure_level } # spits out % of infrastructure damaged - should be 0
			#log = "[?temp_infra_damaged] is temp % of infra damaged"
			set_temp_variable = { temp_infra_damaged_factor_effect = temp_infra_damaged }
			divide_temp_variable = { temp_infra_damaged_factor_effect = 2 }

			set_temp_variable = { temp_state_GDP_growth_factor = 1 }
			add_to_temp_variable = { temp_state_GDP_growth_factor = modifier@state_GDP_growth_factor_modifier }
			subtract_from_temp_variable = { temp_state_GDP_growth_factor = temp_infra_damaged_factor_effect }


			multiply_temp_variable = { temp_real_GDP_growth = temp_state_GDP_growth_factor }
			#log = "[?temp_real_GDP_growth] is temp real GDP growth after applying infra mult and modifier"

			set_temp_variable = { temp_infra_damaged_effect = temp_infra_damaged }
			multiply_temp_variable = { temp_infra_damaged_effect = -5 }

			add_to_temp_variable = { temp_real_GDP_growth = temp_infra_damaged_effect }
			#log = "[?temp_real_GDP_growth] is temp real GDP growth after applying infra flat"

			# UNIFICATION ENDS HERE

			divide_temp_variable = { temp_real_GDP_growth = 12 }

			set_temp_variable = { temp_state_value_added = state_value }
			multiply_temp_variable = { temp_state_value_added = temp_real_GDP_growth }
			divide_temp_variable = { temp_state_value_added = 100 }

			#log = "[?temp_state_value_added] was added to [THIS.GETNAME] state value"

			add_to_variable = { state_value = temp_state_value_added }

			add_to_temp_variable = { total_state_GDP_added = temp_state_value_added }

			set_variable = { state_population_minimum_GDP = state_population_k }
			divide_variable = { state_population_minimum_GDP = 40 } # this should have the effect of making minimum GDPc $25 for populations with an appropriate size hahaha

			clamp_variable = {
				var = state_value
				min = state_population_minimum_GDP
			}

			clamp_variable = {
				var = state_value
				min = 0.001
			}
		}
	}
	# Used for showing the previous months growth
	set_variable = { GDP_growth_real_monthly_from_state = total_state_GDP_added }
	divide_variable = { GDP_growth_real_monthly_from_state = prev_total_state_GDP }
	divide_variable = { GDP_growth_real_monthly_from_state = 10 }
}

store_old_values = {
	set_variable = { last_month_real_GDP_growth = GDP_growth_real }
	set_variable = { last_month_nominal_GDP_growth = GDP_growth_nominal }
	set_variable = { last_month_clamped_inflation_rate = clamped_inflation_rate }
}

calculate_contribution_as_sphere_leader = {
	set_temp_variable = { temp_GDP_from_sphere_underlings = 0 }
	for_each_scope_loop = {
		array = econ_sphere_members

		set_temp_variable = { temp_GDP_to_sphere_leader = modifier@GDP_to_sphere_leader_modifier }
		multiply_variable = { temp_GDP_to_sphere_leader = totalstateGDP }

		subtract_from_variable = { totalstateGDP = temp_GDP_to_sphere_leader }
		set_variable = { GDP_to_sphere_leader = temp_GDP_to_sphere_leader }

		add_to_temp_variable = { PREV.temp_GDP_from_sphere_underlings = GDP_to_sphere_leader }
	}

	add_to_variable = { totalstateGDP = temp_GDP_from_sphere_underlings }
	set_variable = { totalGDP_from_underlings = temp_GDP_from_sphere_underlings } # for display purposes
}

calculate_total_sphere_trade_value = {
	set_temp_variable = { temp_total_trade_gross_value = 0 }
	for_each_scope_loop = {
		array = econ_sphere_members

		set_temp_variable = { nation_trade_gross_value = 0 }
		add_to_temp_variable = { nation_trade_gross_value = PU_imports_m }
		add_to_temp_variable = { nation_trade_gross_value = PU_exports_m }
		divide_temp_variable = { nation_trade_gross_value = pu_to_gdp_ratio }

		add_to_temp_variable = { PREV.temp_total_trade_gross_value = nation_trade_gross_value }
	}
	set_temp_variable = { nation_trade_gross_value = 0 }
	add_to_temp_variable = { nation_trade_gross_value = PU_imports_m }
	add_to_temp_variable = { nation_trade_gross_value = PU_exports_m }
	divide_temp_variable = { nation_trade_gross_value = pu_to_gdp_ratio }
	add_to_temp_variable = { temp_total_trade_gross_value = nation_trade_gross_value }


	set_variable = { total_trade_gross_value = temp_total_trade_gross_value }
	clamp_variable = { var = total_trade_gross_value min = 0 }
}

generate_country_gdp = {
	set_variable = { GDP = totalstateGDP }

	#add_to_variable = { GDP = total_trade_value } # This was causing a lot of funni

	set_temp_variable = { GDP_minimum = total_pop_m }
	multiply_temp_variable = { GDP_minimum = 0.025 }
	clamp_variable = { var = GDP min = GDP_minimum }
}





recalculate_GDP_and_PUs_on_demand = {
	hidden_effect = {
		calculate_total_state_gdp = yes
		calculate_sphere_effects = yes
		update_prod_units_amnt = yes
		update_prod_units_display = yes
		generate_country_gdp = yes
		force_update_dynamic_modifier = yes

		update_economy_tab = yes
	}

}

recalculate_PUs_on_demand = {
	hidden_effect = {
		update_prod_units_amnt = yes
		update_prod_units_display = yes
		generate_country_gdp = yes
		force_update_dynamic_modifier = yes
	}
}

calculate_sphere_effects = {
	if = {
		limit = {
			has_country_flag = HAS_ECON_SPHERE
		} # this effect is run for sphere leaders only
		calculate_contribution_as_sphere_leader = yes
	}
}


apply_credit_rating_progress_change = {

	add_to_variable = { credit_rating_progress = credit_rating_change_aggregate }

	if = {
		limit = { #Optimisation to skip the further steps since the vast majority of the time, you will be within 0-100
			AND = {
				check_variable = { credit_rating_progress > -0.01 }
				check_variable = { credit_rating_progress < 100.01 }
			}
		}
	}
	else_if = {
		limit = {
			check_variable = { credit_rating_progress < 0 }
		}

		econ_lower_credit_rating = yes
	}
	else_if = {
		limit = {
			check_variable = { credit_rating_progress > 100 }
		}
		econ_raise_credit_rating = yes


	}
	#can't be arsed to finish doing the socdev indices tbh

	clamp_variable = {
		var = credit_rating?1
		min = credit_rating_min?1
		max = credit_rating_max?10
	}

}

add_credit_rating_progress = {

	add_to_variable = { credit_rating_progress = credit_rating_progress_temp }

	if = {
		limit = {
			check_variable = { credit_rating_progress_temp < 0 }
		}
		multiply_temp_variable = { credit_rating_progress_temp = -1 }
		custom_effect_tooltip = econ_credit_progress_decrease_tt
	}
	else = {
		custom_effect_tooltip = econ_credit_progress_increase_tt
	}

	if = {
		limit = {
			check_variable = { credit_rating_progress < 0 }
		}

		econ_lower_credit_rating = yes
	}
	else_if = {
		limit = {
			check_variable = { credit_rating_progress > 100 }
		}
		econ_raise_credit_rating = yes

	}
	#can't be arsed to finish doing the socdev indices tbh

	clamp_variable = {
		var = credit_rating
		min = credit_rating_min?1
		max = credit_rating_max?10
	}

}

update_credit_rating_calculation = {
	if = {
		limit = {
			OR = {
				check_variable = { deficit_to_GDP_ratio > GDP_growth_inverted }
				check_variable = { deficit_to_GDP_ratio = 0 }
			}
		}
		set_variable = { credit_rating_change_aggregate = 2 }
	}
	else = {
		set_variable = { credit_rating_change_aggregate = -2 }
	}
	if = {
		limit = {
			set_temp_variable = { temp_debt_ceiling_adjusted = debt_ceiling }
			multiply_temp_variable = { temp_debt_ceiling_adjusted = .75 }
			check_variable = { debt_to_GDP_ratio > temp_debt_ceiling_adjusted }
		}
		add_to_variable = { credit_rating_change_aggregate = -2 }
		if = {
			limit = {
				NOT = {
					has_variable = debt_ceiling
				}
			}
			log = "[THIS.GETNAME] doesn't have debt ceiling defined"
		}
	}
	else = {
		add_to_variable = { credit_rating_change_aggregate = 2 }
	}
	if = {
		limit = {
			has_war = yes
		}
		add_to_variable = { credit_rating_change_aggregate = -1 }
	}
	else = {
		add_to_variable = { credit_rating_change_aggregate = 1 }
	}

	add_to_variable = { credit_rating_change_aggregate = modifier@monthly_credit_rating_progress }

	# socdev? dunno
}

apply_credit_rating_effects = {
	if = {
		limit = { has_variable = credit_rating } # doing this to skip over some startup errors in the log
		clamp_variable = {
			var = credit_rating
			min = credit_rating_min
			max = credit_rating_max
		}
	}
	if = {
		limit = {
			NOT = {
				check_variable = { credit_rating_effect_applied = credit_rating }
			}
		}
		if = {
			limit = {
				check_variable = { credit_rating = 0 }
			}
			log = "credit rating was 0. This should not occur."
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 1 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1 }
			set_variable = { interest_rate_from_credit_rating = 20 }
			set_variable = { credit_rating_interest_rates_from_debt = 1 }
			set_variable = { stability_from_credit_rating = -0.2 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = -0.5 }

			set_variable = { credit_rating_effect_applied = 1 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 2 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.1 }
			set_variable = { interest_rate_from_credit_rating = 12.4 }
			set_variable = { credit_rating_interest_rates_from_debt = 0.5 }
			set_variable = { stability_from_credit_rating = -0.1 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = -0.4 }

			set_variable = { credit_rating_effect_applied = 2 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 3 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.2 }
			set_variable = { interest_rate_from_credit_rating = 9.8 }
			set_variable = { credit_rating_interest_rates_from_debt = 0.35 }
			set_variable = { stability_from_credit_rating = -0.075 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = -0.3 }


			set_variable = { credit_rating_effect_applied = 3 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 4 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.3 }
			set_variable = { interest_rate_from_credit_rating = 7.6 }
			set_variable = { credit_rating_interest_rates_from_debt = 0.2 }
			set_variable = { stability_from_credit_rating = -0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = -0.2 }


			set_variable = { credit_rating_effect_applied = 4 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 5 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.4 }
			set_variable = { interest_rate_from_credit_rating = 5.8 }
			set_variable = { credit_rating_interest_rates_from_debt = 0 }
			set_variable = { stability_from_credit_rating = 0 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = -0.1 }


			set_variable = { credit_rating_effect_applied = 5 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 6 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.5 }
			set_variable = { interest_rate_from_credit_rating = 4.2 }
			set_variable = { credit_rating_interest_rates_from_debt = -0.2 }
			set_variable = { stability_from_credit_rating = 0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0 }


			set_variable = { credit_rating_effect_applied = 6 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 7 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 1.75 }
			set_variable = { interest_rate_from_credit_rating = 3.0 }
			set_variable = { credit_rating_interest_rates_from_debt = -0.4 }
			set_variable = { stability_from_credit_rating = 0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0.05 }


			set_variable = { credit_rating_effect_applied = 7 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 8 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 2 }
			set_variable = { interest_rate_from_credit_rating = 2.2 }
			set_variable = { credit_rating_interest_rates_from_debt = -0.6 }
			set_variable = { stability_from_credit_rating = 0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0.1 }


			set_variable = { credit_rating_effect_applied = 8 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 9 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 2.5 }
			set_variable = { interest_rate_from_credit_rating = 1.7 }
			set_variable = { credit_rating_interest_rates_from_debt = -0.8 }
			set_variable = { stability_from_credit_rating = 0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0.15 }


			set_variable = { credit_rating_effect_applied = 9 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 10 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 500 }
			set_variable = { interest_rate_from_credit_rating = 1.5 }
			set_variable = { credit_rating_interest_rates_from_debt = -0.9 }
			set_variable = { stability_from_credit_rating = 0.05 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0.25 }


			set_variable = { credit_rating_effect_applied = 10 }
		}
		else_if = {
			limit = {
				check_variable = { credit_rating = 11 }
			}
			set_variable = { debt_ceiling_from_credit_rating = 0 }
			set_variable = { interest_rate_from_credit_rating = 0 }
			set_variable = { credit_rating_interest_rates_from_debt = 0 }
			set_variable = { stability_from_credit_rating = 0 }
			set_variable = { credit_rating_effect_on_debt_GDP_effect = 0 }


			set_variable = { credit_rating_effect_applied = 11 }
		}
	}
}

apply_central_bank_policy = {
	add_dynamic_modifier = { modifier = Central_Bank_Dynamic_Modifier }

	# resets the growth
	set_variable = { central_bank_gdp_growth_modifier = 0 }

	#Policy 0
	if = { # add to growth counter
		limit = { check_variable = { selected_central_bank_id = 0 } }
		add_to_variable = { central_bank_effectiveness_0 = 0.2 }
	}
	else = { # subtracts to inflation counter
		subtract_from_variable = { central_bank_effectiveness_0 = 0.2 }
	}
	clamp_variable = { var = central_bank_effectiveness_0 min = 0 max = 1 }

	#Policy 1
	if = { # add to inflation counter
		limit = { check_variable = { selected_central_bank_id = 1 } }
		add_to_variable = { central_bank_effectiveness_1 = 0.1 }
	}
	else = { # subtracts to inflation counter
		subtract_from_variable = { central_bank_effectiveness_1 = 0.1 }
	}
	clamp_variable = { var = central_bank_effectiveness_1 min = 0 max = 1 }

	#Policy 2
	if = { # add to poverty reduction and gdp reduction counter
		limit = { check_variable = { selected_central_bank_id = 2 } }
		add_to_variable = { central_bank_effectiveness_2 = 0.1 }
	}
	else = { # subtracts to poverty reduction and gdp reduction counter
		subtract_from_variable = { central_bank_effectiveness_2 = 0.1 }
	}
	clamp_variable = { var = central_bank_effectiveness_2 min = 0 max = 1 }

	#Policy 3
	if = { # add to poverty reduction and gdp reduction counter
		limit = { check_variable = { selected_central_bank_id = 3 } }
		add_to_variable = { central_bank_effectiveness_3 = 0.1 }
	}
	else = { # subtracts to poverty reduction and gdp reduction counter
		subtract_from_variable = { central_bank_effectiveness_3 = 0.1 }
	}
	clamp_variable = { var = central_bank_effectiveness_3 min = 0 max = 1 }

	set_variable = { central_bank_growth = central_bank_effectiveness_0 }
	set_variable = { central_bank_growth_display = central_bank_growth }
	divide_variable = { central_bank_growth_display = 100 }
	add_to_variable = { central_bank_gdp_growth_modifier = central_bank_growth }

	# resets the inflation
	add_to_variable = { base_inflation_rate = suppressed_inflation }

	# calculates and applies effect again
	set_variable = { suppressed_inflation = base_inflation_rate }
	multiply_variable = { suppressed_inflation = central_bank_effectiveness_1 }
	multiply_variable = { suppressed_inflation = 0.2 }
	clamp_variable = { var = suppressed_inflation min = 0 max = 3 }
	subtract_from_variable = { base_inflation_rate = suppressed_inflation }

	#policy 2 calculations
	set_variable = { central_bank_poverty_monthly_rate = central_bank_effectiveness_2 }
	divide_variable = { central_bank_poverty_monthly_rate = 10 }

	set_variable = { central_bank_effectiveness_2_gdp_cost = central_bank_effectiveness_2 }
	divide_variable = { central_bank_effectiveness_2_gdp_cost = 2 }
	set_variable = { central_bank_effectiveness_2_gdp_cost_display = central_bank_effectiveness_2_gdp_cost }
	divide_variable = { central_bank_effectiveness_2_gdp_cost_display = 10 }
	subtract_from_variable = { central_bank_gdp_growth_modifier = central_bank_effectiveness_2_gdp_cost }

	#policy 3
	set_variable = { central_bank_power = central_bank_effectiveness_3 }
	multiply_variable = { central_bank_power = 0.15 }
	set_variable = { central_bank_power_display = central_bank_power }
	multiply_variable = { central_bank_power = resource@power }
	round_variable = central_bank_power

	set_variable = { central_bank_effectiveness_3_gdp_cost = central_bank_effectiveness_3 }
	divide_variable = { central_bank_effectiveness_3_gdp_cost = 2 }
	set_variable = { central_bank_effectiveness_3_gdp_cost_display = central_bank_effectiveness_3_gdp_cost }
	#divide_variable = { central_bank_effectiveness_3_gdp_cost_display = 10 }
	subtract_from_variable = { central_bank_gdp_growth_modifier = central_bank_effectiveness_3_gdp_cost }
}


calculate_debt_ceiling = {
	set_variable = { debt_ceiling = base_debt_ceiling }
	add_to_variable = { debt_ceiling = debt_ceiling_from_credit_rating }
	add_to_variable = { debt_ceiling = modifier@debt_to_GDP_ceiling_modifier }
	clamp_variable = {
		var = debt_ceiling
		min = 0
	}
}

round_this_power = {
	#temp variable 'counting_var' must be set to 1 before this is called

	set_temp_variable = { new_power = this_power }

	set_temp_variable = { check = this_power }
	subtract_from_temp_variable = { check = counting_var }
	if = {
		limit = {
			check_variable = { check > 0.5 }
			check_variable = { check < 1 }
		}
		add_to_temp_variable = { new_power = 1 }
	}
	else_if = {
		limit = {
			check_variable = { counting_var < 100 } #failsafe to avoud a really long loop
			check_variable = { check > 1 }
		}
		add_to_temp_variable = { counting_var = 1 }
		round_this_power = yes
	}
}

grid_power_production_tt_effect = {
	#temp variable 'current_state' must be set to 0 before this is called
	#this never actually gets called, it makes the tooltip for the grid power meter in the top bar
	if = {
		limit = {
			check_variable = { current_state = 0 }
		}
		set_temp_variable = { total_power = 0 }
	}
	if = {
		limit = {
			check_variable = { current_state < num_owned_states }
		}

		var:owned_states^current_state = {
			if = {
				limit = {
					check_variable = { resource@power > 0 }
				}
				set_temp_variable = { this_power = 0 }
				add_to_temp_variable = { this_power = resource@power }

				set_temp_variable = { mod = PREV.modifier@local_resources_factor }
				add_to_temp_variable = { mod = 1 }

				multiply_temp_variable = { this_power = mod }
				#round_temp_variable = this_power #this doesn't work for some reason
				#modulo_temp_variable = { this_power = 1 } #neither does this

				set_temp_variable = { counting_var = 1 }
				round_this_power = yes

				custom_effect_tooltip = economy_topbar_power_from_a_state
			}
		}


		add_to_temp_variable = { current_state = 1 }
		grid_power_production_tt_effect = yes
	}
	else = {
		custom_effect_tooltip = economy_topbar_power_changed_by_modifier
	}
}

#####################################################################################
#################            AI ECON STRATEGY             ###########################
#####################################################################################

update_ai_invest_reserves = {
	if = {
		limit = {
			check_variable = {
				var = money_reserves
				value = national_debt
				compare = less_than_or_equals
			}
		}
		subtract_from_variable = { national_debt = money_reserves }
		set_variable = { money_reserves = 0 }
		set_variable = { reserves_management_amount = 0 }
		else = {
			subtract_from_variable = { money_reserves = national_debt }
			set_variable = { national_debt = 0 }
			set_variable = { reserves_management_amount = 0 }
		}
	}


	divide_variable = { money_reserves = 20 }
	add_to_variable = { money_reserves = GDP }
	multiply_variable = { money_reserves = 10 }
	divide_variable = { money_reserves = GDP }

	every_owned_state = {
		multiply_variable = { state_value = PREV.money_reserves }
		divide_variable = { state_value = 10 }
	}

	set_variable = { money_reserves = 0 }
}

update_ai_slider_logic = {
	if = {
		limit = { check_variable = { national_debt > 0 } }

		set_variable = { econ_social_expenditures_slider_pct = econ_social_expenditures_minimal_pct }
		set_variable = { econ_admin_expenditures_slider_pct = econ_admin_expenditures_minimal_pct }
		set_variable = { econ_research_expenditures_slider_pct = econ_research_expenditures_minimal_pct }

		if = {
			limit = { has_war = no }
			set_variable = { econ_army_expenditures_slider_pct = econ_army_expenditures_minimal_pct }
			set_variable = { econ_naval_expenditures_slider_pct = econ_naval_expenditures_minimal_pct }
			set_variable = { econ_nuclear_expenditures_slider_pct = econ_nuclear_expenditures_minimal_pct }
		} 
		else = {
			set_variable = { econ_army_expenditures_slider_pct = econ_army_expenditures_maximal_pct }
			set_variable = { econ_naval_expenditures_slider_pct = econ_naval_expenditures_maximal_pct }
			set_variable = { econ_nuclear_expenditures_slider_pct = econ_nuclear_expenditures_maximal_pct }
		}
	} 
	else = {
		set_variable = { econ_social_expenditures_slider_pct = econ_social_expenditures_maximal_pct }
		set_variable = { econ_admin_expenditures_slider_pct = econ_admin_expenditures_maximal_pct }
		set_variable = { econ_research_expenditures_slider_pct = econ_research_expenditures_maximal_pct }

		set_variable = { econ_army_expenditures_slider_pct = econ_army_expenditures_maximal_pct }
		set_variable = { econ_naval_expenditures_slider_pct = econ_naval_expenditures_maximal_pct }
		set_variable = { econ_nuclear_expenditures_slider_pct = econ_nuclear_expenditures_maximal_pct }
	}

	update_social_subsliders = yes
	update_army_subsliders = yes
	update_admin_subsliders = yes
	update_research_subsliders = yes
	update_economy_tab = yes
}