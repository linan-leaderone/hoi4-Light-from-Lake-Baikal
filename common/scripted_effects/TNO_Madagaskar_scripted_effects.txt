MAD_setup_civil_war = {
	set_global_flag = MAD_civil_war_ongoing
	set_variable = { global.MAD_war_prog = 33 }
	FRA = { end_puppet = MAD }
	MAD = {
		set_capital = {
			state = 543
			remember_old_capital = yes
		}
		delete_unit_template_and_units = { division_template = "Compagnie de Gendarmerie" disband = no }
		add_dynamic_modifier = { modifier = MAD_modif_fractious_united_front }
		set_variable = { MADCW_war_stage = 1 }
		add_manpower = -20000
		set_cosmetic_tag = MAD_insurgent
		set_country_flag = MAD_insurgent_path
		MAD_Gilles_Andriamahazo = {
			promote_character = despotism_interim_government_subtype
		}
		set_party_name = {
			ideology = despotism
			long_name = MAD_despotism_police_party_long
			name = MAD_despotism_police_party
		}
		#set_party_name = {
		#	ideology = despotism
		#	long_name = MAD_despotism_tafama_party_long
		#	name = MAD_despotism_tafama_party
		#}
		add_popularity = {
			ideology = despotism
			popularity = 1
		}
		leave_faction = yes
		econ_leave_sphere = yes
		set_temp_variable = { TNO_economy_subtype_temp = token:Econ_Subtype_Dirigisme }
		econ_subtype_change = yes
		remove_ideas = {
			Pakt_Mitstreiter
			MAD_last_french_colony
			MAD_military_commission_for_madagascar
			MAD_disloyal_gendarmerie
			MAD_secret_societies
		}
		add_ideas = {
			MAD_tsiazombazaha
			MAD_neverending_supply_crisis
			MAD_fractious_united_front_modif
		}

		remove_state_core = 706
		remove_state_core = 707

		delete_unit_template_and_units = { division_template = "Infanterie-Division" disband = yes }
		delete_unit_template_and_units = { division_template = "Panzergrenadier-Division" disband = yes }

		transfer_navy = { target = MDG }
		every_character = {
			limit = {
				has_character_flag = MDG_character
			}
			set_nationality = MDG
		}

		load_oob = "MAD_Uprising"

		add_equipment_to_stockpile = {
			type = infantry_equipment_1
			amount = 600
			producer = FRS
		}
		add_equipment_to_stockpile = {
			type = infantry_equipment_2
			amount = 80
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = support_equipment_1
			amount = 80
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = anti_tank_equipment_0
			amount = 20
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = motorized_equipment_1
			amount = 30
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = artillery_equipment_1
			amount = 16
			producer = GER
		}

		if = {
			limit = {
				NOT = {
					has_dlc = "No Step Back"
				}
			}
			add_equipment_to_stockpile = {
				type = armored_car_equipment_1
				amount = 100
				producer = GER
			}
		}
		if = {
			limit = {
				has_dlc = "No Step Back"
			}
			create_equipment_variant = {
				name = "Spz Kurz 4-2"
				type = armored_car_chassis_1
				parent_version = 0
				modules = {
					main_armament_slot = tank_auto_cannon_2
					turret_type_slot = AC_one_man_tank_turret
					suspension_type_slot = tank_torsion_bar_suspension
					armor_type_slot = tank_welded_armor
					engine_type_slot = tank_gasoline_engine
					special_type_slot_1 = smoke_launchers
				}

				icon = GFX_GER_AC_1950_medium
				upgrades = {
					ac_nsb_engine_upgrade = 5
					ac_nsb_armor_upgrade = 2
				}
			}
			add_equipment_to_stockpile = {
				type = armored_car_chassis_1
				amount = 100
				producer = GER
			}
		}
	}

	GER = {
		transfer_state = 706
		transfer_state = 707
	}

	every_state = {
		limit = { is_owned_by = MAD }
		MDG = { add_state_core = PREV }
	}

	MDG = {
		inherit_technology = MAD
		add_manpower = 20000
		set_capital = {
			state = 946
			remember_old_capital = no
		}

		#add_state_core = 944
		#add_state_core = 945
		#add_state_core = 946
		#add_state_core = 947
		#add_state_core = 1042
		#add_state_core = 1857
		#add_state_core = 1858
		#add_state_core = 1860
		#add_state_core = 1862
		add_state_core = 706
		add_state_core = 707

		transfer_state = 944
		transfer_state = 945
		transfer_state = 946
		transfer_state = 947
		transfer_state = 1042
		transfer_state = 1857
		transfer_state = 1858
		transfer_state = 1860
		transfer_state = 1862

		if = { #prevents the error log from going insane
			limit = { has_character = MDG_Emil_Maurice }
			MDG_Emil_Maurice = { promote_character = national_socialism_technocratic_nazism_subtype }
		}

		add_equipment_to_stockpile = {
			type = infantry_equipment_1
			amount = 2000
			producer = FRS
		}
		add_equipment_to_stockpile = {
			type = infantry_equipment_2
			amount = 1000
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = support_equipment_1
			amount = 150
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = anti_tank_equipment_0
			amount = 100
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = motorized_equipment_1
			amount = 120
			producer = GER
		}
		add_equipment_to_stockpile = {
			type = artillery_equipment_1
			amount = 30
			producer = GER
		}

		load_oob = "MDG_Uprising"
		if = {
			limit = {
				NOT = {
					has_dlc = "No Step Back"
				}
			}
			add_equipment_to_stockpile = {
				type = APC_equipment_1
				amount = 74
				producer = GER
			}
			add_equipment_to_stockpile = {
				type = APC_equipment_2
				amount = 20
				producer = GER
			}
			add_equipment_to_stockpile = {
				type = armored_car_equipment_1
				amount = 80
				producer = GER
			}
		}
		if = {
			limit = {
				has_dlc = "No Step Back"
			}
			create_equipment_variant = {
				name = "Spz Kurz 4-2"
				type = armored_car_chassis_1
				parent_version = 0
				modules = {
					main_armament_slot = tank_auto_cannon_2
					turret_type_slot = AC_one_man_tank_turret
					suspension_type_slot = tank_torsion_bar_suspension
					armor_type_slot = tank_welded_armor
					engine_type_slot = tank_gasoline_engine
					special_type_slot_1 = smoke_launchers
				}

				icon = GFX_GER_AC_1950_medium
				upgrades = {
					ac_nsb_engine_upgrade = 5
					ac_nsb_armor_upgrade = 2
				}
			}

			create_equipment_variant = {
				name = "Schützenpanzer Zobel"
				type = APC_chassis_2
				parent_version = 0
				modules = {
					APC_designation_slot = APC_infantry
					APC_armament_slot = APC_infantry_weapon_2
					suspension_type_slot = tank_torsion_bar_suspension
					armor_type_slot = tank_welded_armor
					engine_type_slot = tank_gasoline_engine
					special_type_slot_1 = smoke_launchers
				}

				icon = GFX_GER_APC_1960_medium
				upgrades = {
					ac_nsb_engine_upgrade = 5
					ac_nsb_armor_upgrade = 3
				}
			}

			create_equipment_variant = {
				name = "Schützenpanzer Lang HS.30"
				type = APC_chassis_1
				parent_version = 0
				modules = {
					APC_designation_slot = APC_infantry
					APC_armament_slot = APC_infantry_weapon_2
					suspension_type_slot = tank_torsion_bar_suspension
					armor_type_slot = tank_welded_armor
					engine_type_slot = tank_gasoline_engine
					special_type_slot_1 = additional_machine_guns
					special_type_slot_2 = additional_armour
				}

				icon = GFX_GER_APC_1950_medium
				upgrades = {
					ac_nsb_engine_upgrade = 7
					ac_nsb_armor_upgrade = 5
				}
				obsolete = yes
			}
			add_equipment_to_stockpile = {
				type = APC_chassis_1
				amount = 74
				producer = GER
			}
			add_equipment_to_stockpile = {
				type = APC_chassis_2
				amount = 20
				producer = GER
			}
			add_equipment_to_stockpile = {
				type = armored_car_chassis_1
				amount = 80
				producer = GER
			}
		}
	}

	every_state = {
		limit = {
			is_owned_by = MAD
			NOT = {
				OR = {
					state = 543
					state = 1867
					state = 1879
				}
			}
		}
		MDM = {
			add_state_core = PREV
			transfer_state = PREV
		}
		add_dynamic_modifier = { modifier = MAD_No_Authority }
		set_demilitarized_zone = yes
	}
	# French
	946 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}
	1857 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}
	944 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}
	1860 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}
	945 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}

	1858 = {
		add_dynamic_modifier = { modifier = MAD_Limited_Authority }
	}
	947 = {
		add_dynamic_modifier = { modifier = MAD_Limited_Authority }
	}
	1862 = {
		add_dynamic_modifier = { modifier = MAD_Limited_Authority }
	}
	1042 = {
		add_dynamic_modifier = { modifier = MAD_Limited_Authority }
	}
	# Malagasy
	1867 = {
		add_dynamic_modifier = { modifier = MAD_No_Authority }
	}
	543 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}
	1879 = {
		add_dynamic_modifier = { modifier = MAD_Base_of_Operations }
	}

	MDM = {
		add_state_core = 1597 # this state allows us to avoid a capital showing up for the anarchy tag in madagascar
		transfer_state = 1597
		set_capital = {
			state = 1597
			remember_old_capital = no
		}
		add_ideas = {
			MDM_disconnected_settlements
		}
	}

	# fire events here to notify each participating country (USA, FRA, GER, JAP) of madagascar funnies and that they may now intervene etc

	every_country = {
		limit = { is_ai = no }
		news_event = { id = MAD_news.1 hours = 6 }
	}

	MAD_setup_values = yes
}

# Run separately for every tag, fired from TNO_fopo_add_madagascar_conflict_tab
MAD_setup_proxy_array = {
	set_variable = { Madagascar_selected_city = 1857 }
}


####-------------- GLOSSARY OF VARIABLES ####--------------#####

#	NAME								SCOPE		NOTES
#============================================================#
#	Madagascar_strength_var_<tag>		STATE		<tag> = USA / GER / JAP
#	Madagascar_investment				COUNTRY		-----
#	Madagascar_contributions			COUNTRY		-----
#	global.Madagascar_<tag>_influence	GLOBAL		<tag> = USA / JAP / GER / FRA
#													USA vs. JAP || GER vs. FRA
#													Opposing variables MUST add up to a total of 100

#### State names

## Selected state is stored in `Madagascar_selected_city`

# 1857	-	Majunga
# 1969	-	Ambatondrazaka
# 944	-	Tamatave
# 945	-	Antananarivo
# 1970	-	Moramanga
# 1974	-	Ambositra
# 1975	-	Fianarantsoa
# 1860	-	Manakara
# 946	-	Tulear

# Run this once only
MAD_setup_values = {
	set_variable = { USA.US_opp_strength_mad = 1 }

	1857 =	{ set_variable = { MADCW_LOCAL_ARMS = 300 } }
	1969 =	{ set_variable = { MADCW_LOCAL_ARMS = 400 } }
	944 =	{ set_variable = { MADCW_LOCAL_ARMS = 500 } }
	945 = 	{ set_variable = { MADCW_LOCAL_ARMS = 500 } }
	1970 = 	{ set_variable = { MADCW_LOCAL_ARMS = 1250 } }
	1974 = 	{ set_variable = { MADCW_LOCAL_ARMS = 1250 } }
	1975 = 	{ set_variable = { MADCW_LOCAL_ARMS = 1250 } }
	1860 = 	{ set_variable = { MADCW_LOCAL_ARMS = 300 } }
	946 = 	{ set_variable = { MADCW_LOCAL_ARMS = 300 } }

	1969 =	{ set_variable = { Madagascar_strength_var_USA = 50 } }
	945 = 	{ set_variable = { Madagascar_strength_var_USA = 20 } }
	1970 = 	{ set_variable = { Madagascar_strength_var_USA = 30 } }
	1974 = 	{ set_variable = { Madagascar_strength_var_USA = 30 } }
	1975 = 	{ set_variable = { Madagascar_strength_var_USA = 40 } }
	1857 =	{ set_variable = { Madagascar_strength_var_USA = 30 } }
	944 =	{ set_variable = { Madagascar_strength_var_USA = 30 } }
	1860 = 	{ set_variable = { Madagascar_strength_var_USA = 20 } }
	946 = 	{ set_variable = { Madagascar_strength_var_USA = 0 } }

	1969 =	{ set_variable = { Madagascar_strength_var_JAP = 50 } }
	945 = 	{ set_variable = { Madagascar_strength_var_JAP = 20 } }
	1970 = 	{ set_variable = { Madagascar_strength_var_JAP = 30 } }
	1974 = 	{ set_variable = { Madagascar_strength_var_JAP = 30 } }
	1975 = 	{ set_variable = { Madagascar_strength_var_JAP = 40 } }
	1857 =	{ set_variable = { Madagascar_strength_var_JAP = 30 } }
	944 =	{ set_variable = { Madagascar_strength_var_JAP = 30 } }
	1860 = 	{ set_variable = { Madagascar_strength_var_JAP = 20 } }
	946 = 	{ set_variable = { Madagascar_strength_var_JAP = 0 } }

	1969 =	{ set_variable = { Madagascar_strength_var_GER = 30 } }
	945 = 	{ set_variable = { Madagascar_strength_var_GER = 80 } }
	1970 = 	{ set_variable = { Madagascar_strength_var_GER = 40 } }
	1974 = 	{ set_variable = { Madagascar_strength_var_GER = 40 } }
	1975 = 	{ set_variable = { Madagascar_strength_var_GER = 40 } }
	1857 =	{ set_variable = { Madagascar_strength_var_GER = 70 } }
	944 =	{ set_variable = { Madagascar_strength_var_GER = 60 } }
	1860 = 	{ set_variable = { Madagascar_strength_var_GER = 80 } }
	946 = 	{ set_variable = { Madagascar_strength_var_GER = 100 } }

	USA = {
		set_variable = { Madagascar_investment = 60 }
		set_variable = { Madagascar_contributions = 30 }
	}
	JAP = {
		set_variable = { Madagascar_investment = 40 }
		set_variable = { Madagascar_contributions = 70 }

		set_variable = { madagascar_pie_usa_frame = global.Madagascar_JAP_influence }
		round_variable = madagascar_pie_usa_frame
		multiply_variable = { madagascar_pie_usa_frame = 1000 }
		add_to_variable = { madagascar_pie_usa_frame = 100 }
	}
	GER = {
		set_variable = { Madagascar_investment = 90 }
		set_variable = { Madagascar_contributions = 90 }

		set_variable = { madagascar_pie_germany_frame = global.Madagascar_FRA_influence }
		round_variable = madagascar_pie_germany_frame
		multiply_variable = { madagascar_pie_germany_frame = 1000 }
		add_to_variable = { madagascar_pie_germany_frame = 100 }
	}

	if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_PADESM
			}
		}
		set_variable = { global.Madagascar_USA_influence = 60 }
		set_variable = { global.Madagascar_JAP_influence = 40 }
	}
	else_if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_TAFAMA
			}
		}
		set_variable = { global.Madagascar_USA_influence = 40 }
		set_variable = { global.Madagascar_JAP_influence = 60 }
	}
	else = {
		set_variable = { global.Madagascar_USA_influence = 50 }
		set_variable = { global.Madagascar_JAP_influence = 50 }
	}

	set_variable = { global.Madagascar_GER_influence = 34 }
	set_variable = { global.Madagascar_FRA_influence = 66 }

	USA = {
		set_variable = { madagascar_pie_usa_frame = global.Madagascar_JAP_influence }
		round_variable = madagascar_pie_usa_frame
		multiply_variable = { madagascar_pie_usa_frame = 1000 }
		add_to_variable = { madagascar_pie_usa_frame = 100 }
	}
	JAP = {
		set_variable = { madagascar_pie_usa_frame = global.Madagascar_JAP_influence }
		round_variable = madagascar_pie_usa_frame
		multiply_variable = { madagascar_pie_usa_frame = 1000 }
		add_to_variable = { madagascar_pie_usa_frame = 100 }
	}
	GER = {
		set_variable = { madagascar_pie_germany_frame = global.Madagascar_FRA_influence }
		round_variable = madagascar_pie_germany_frame
		multiply_variable = { madagascar_pie_germany_frame = 1000 }
		add_to_variable = { madagascar_pie_germany_frame = 100 }
	}

}

MAD_change_local_arms = {
	custom_effect_tooltip = MADCW_TT_Change_Local_Arms_tt
	add_to_variable = { MADCW_LOCAL_ARMS = temp_arms }
}

MAD_increase_local_authority = {
	if = {
		limit = {
			has_dynamic_modifier = { modifier = MAD_Isolated_Authority }
		}
		remove_dynamic_modifier = { modifier = MAD_Isolated_Authority }
		add_dynamic_modifier = { modifier = MAD_Hostile_Territory }
	}
	else_if = {
		limit = {
			has_dynamic_modifier = { modifier = MAD_No_Authority }
		}
		remove_dynamic_modifier = { modifier = MAD_No_Authority }
		add_dynamic_modifier = { modifier = MAD_Hostile_Territory }
	}
	else_if = {
		limit = {
			has_dynamic_modifier = { modifier = MAD_Hostile_Territory }
		}
		remove_dynamic_modifier = { modifier = MAD_Hostile_Territory }
		add_dynamic_modifier = { modifier = MAD_Limited_Authority }
	}
	else_if = {
		limit = {
			has_dynamic_modifier = { modifier = MAD_Limited_Authority }
		}
		remove_dynamic_modifier = { modifier = MAD_Limited_Authority }
		add_dynamic_modifier = { modifier = MAD_Tamed_Territory }
	}
}

MAD_adjust_investment = {
	add_to_variable = { Madagascar_investment = TEMP_MADCW_Investment }
	custom_effect_tooltip = MADCW_TT_Adjust_Investment_tt

	clamp_variable = {
		var = USA.Madagascar_investment
		min = 0
		max = 100
	}
	clamp_variable = {
		var = JAP.Madagascar_investment
		min = 0
		max = 100
	}
	clamp_variable = {
		var = GER.Madagascar_investment
		min = 0
		max = 100
	}
}
MAD_adjust_contribution = {
	add_to_variable = { Madagascar_contributions = TEMP_MADCW_Contribution }
	custom_effect_tooltip = MADCW_TT_Adjust_Contribution_tt

	if = {
		limit = {
			tag = USA
		}
		multiply_temp_variable = { TEMP_MADCW_Contribution = -1 }
		add_to_variable = { JAP.Madagascar_contributions = TEMP_MADCW_Contribution }

		clamp_variable = {
			var = USA.Madagascar_contributions
			min = 0
			max = 100
		}
		clamp_variable = {
			var = JAP.Madagascar_contributions
			min = 0
			max = 100
		}
	}
	else_if = {
		limit = {
			tag = JAP
		}
		multiply_temp_variable = { TEMP_MADCW_Contribution = -1 }
		add_to_variable = { USA.Madagascar_contributions = TEMP_MADCW_Contribution }

		clamp_variable = {
			var = USA.Madagascar_contributions
			min = 0
			max = 100
		}
		clamp_variable = {
			var = JAP.Madagascar_contributions
			min = 0
			max = 100
		}
	}
	MAD = {
		set_variable = { MADCW_America_cont_vr1 = 0.50 } # needs to be double intended value due to math used
		set_variable = { MADCW_America_cont_vr2 = 0.60 }

		set_variable = { MADCW_Jaabn_cont_vr1 = 0.2 }

		set_temp_variable = { eichmerikkkan_modif = USA.Madagascar_contributions }
		divide_temp_variable = { eichmerikkkan_modif = 100 }
		subtract_from_temp_variable = { eichmerikkkan_modif = 0.5 }

		multiply_variable = { MADCW_America_cont_vr1 = eichmerikkkan_modif }
		multiply_variable = { MADCW_America_cont_vr2 = eichmerikkkan_modif }
		#
		set_temp_variable = { japan_modif = JAP.Madagascar_contributions }
		divide_temp_variable = { japan_modif = 100 }
		subtract_from_temp_variable = { japan_modif = 0.5 }

		multiply_variable = { MADCW_Jaabn_cont_vr1 = japan_modif }
	}

	clamp_variable = {
		var = GER.Madagascar_contributions
		min = 0
		max = 100
	}
}

MAD_adjust_USA_factionalism = {

	set_temp_variable = { usa_influence = USA.Madagascar_contributions }
	set_temp_variable = { jap_influence = JAP.Madagascar_contributions }
	set_temp_variable = { fiddy = 50 }
	subtract_from_temp_variable = { usa_influence = jap_influence }
	divide_temp_variable = { usa_influence = fiddy }
	add_to_temp_variable = { usa_influence = 1 }

	multiply_temp_variable = { TEMP_MADCW_Factionalism = usa_influence }
	round_temp_variable = TEMP_MADCW_Factionalism
	add_to_variable = { global.Madagascar_USA_influence = TEMP_MADCW_Factionalism }
	set_temp_variable = { TEMP_MADCW_Factionalism_2 = TEMP_MADCW_Factionalism }
	multiply_temp_variable = { TEMP_MADCW_Factionalism_2 = -1 }
	add_to_variable = { global.Madagascar_JAP_influence = TEMP_MADCW_Factionalism_2 }

	clamp_variable = {
		var = global.Madagascar_USA_influence
		min = 1
		max = 99
	}
	clamp_variable = {
		var = global.Madagascar_JAP_influence
		min = 1
		max = 99
	}

	if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_PADESM
			}
			NOT = {
				check_variable = {
					var = global.Madagascar_USA_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			NOT = {
				USA = {
					has_country_flag = USA_MADCW_exposed_madagascar
				}
			}
		}
		set_variable = { global.Madagascar_USA_influence = 60 }
		set_variable = { global.Madagascar_JAP_influence = 40 }
	}
	else_if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_TAFAMA
			}
			NOT = {
				check_variable = {
					var = global.Madagascar_JAP_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
		}
		set_variable = { global.Madagascar_USA_influence = 40 }
		set_variable = { global.Madagascar_JAP_influence = 60 }
	}
	else_if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_DEADLOCK
			}
		}
		if = {
			limit = {
				check_variable = {
					var = global.Madagascar_USA_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			set_variable = { global.Madagascar_USA_influence = 59 }
			set_variable = { global.Madagascar_JAP_influence = 41 }
		}
		else_if = {
			limit = {
				check_variable = {
					var = global.Madagascar_JAP_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			set_variable = { global.Madagascar_USA_influence = 41 }
			set_variable = { global.Madagascar_JAP_influence = 59 }
		}
	}

	set_variable = { madagascar_pie_usa_frame = global.Madagascar_JAP_influence }
	round_variable = madagascar_pie_usa_frame
	multiply_variable = { madagascar_pie_usa_frame = 1000 }
	add_to_variable = { madagascar_pie_usa_frame = 100 }

	USA = { custom_effect_tooltip = MADCW_TT_Adjust_Factionalism_tt }
}
MAD_adjust_JAP_factionalism = {

	set_temp_variable = { usa_influence = USA.Madagascar_contributions }
	set_temp_variable = { jap_influence = JAP.Madagascar_contributions }
	set_temp_variable = { fiddy = 50 }
	subtract_from_temp_variable = { jap_influence = usa_influence }
	divide_temp_variable = { jap_influence = fiddy }
	add_to_temp_variable = { jap_influence = 1 }

	multiply_temp_variable = { TEMP_MADCW_Factionalism = jap_influence }
	round_temp_variable = TEMP_MADCW_Factionalism
	add_to_variable = { global.Madagascar_JAP_influence = TEMP_MADCW_Factionalism }
	set_temp_variable = { TEMP_MADCW_Factionalism_2 = TEMP_MADCW_Factionalism }
	multiply_temp_variable = { TEMP_MADCW_Factionalism_2 = -1 }
	add_to_variable = { global.Madagascar_USA_influence = TEMP_MADCW_Factionalism_2 }

	clamp_variable = {
		var = global.Madagascar_USA_influence
		min = 1
		max = 99
	}
	clamp_variable = {
		var = global.Madagascar_JAP_influence
		min = 1
		max = 99
	}

	if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_PADESM
			}
			NOT = {
				check_variable = {
					var = global.Madagascar_USA_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			NOT = {
				USA = {
					has_country_flag = USA_MADCW_exposed_madagascar
				}
			}
		}
		set_variable = { global.Madagascar_USA_influence = 60 }
		set_variable = { global.Madagascar_JAP_influence = 40 }
	}
	else_if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_TAFAMA
			}
			NOT = {
				check_variable = {
					var = global.Madagascar_JAP_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
		}
		set_variable = { global.Madagascar_USA_influence = 40 }
		set_variable = { global.Madagascar_JAP_influence = 60 }
	}
	else_if = {
		limit = {
			has_game_rule = {
				rule = MAD_CONSTITUTION
				option = MAD_CONSTITUTION_DEADLOCK
			}
		}
		if = {
			limit = {
				check_variable = {
					var = global.Madagascar_USA_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			set_variable = { global.Madagascar_USA_influence = 59 }
			set_variable = { global.Madagascar_JAP_influence = 41 }
		}
		else_if = {
			limit = {
				check_variable = {
					var = global.Madagascar_JAP_influence
					value = 60
					compare = greater_than_or_equals
				}
			}
			set_variable = { global.Madagascar_USA_influence = 41 }
			set_variable = { global.Madagascar_JAP_influence = 59 }
		}
	}

	set_variable = { madagascar_pie_usa_frame = global.Madagascar_JAP_influence }
	round_variable = madagascar_pie_usa_frame
	multiply_variable = { madagascar_pie_usa_frame = 1000 }
	add_to_variable = { madagascar_pie_usa_frame = 100 }

	JAP = { custom_effect_tooltip = MADCW_TT_Adjust_Factionalism_tt }
}
MAD_adjust_GER_factionalism = {

	set_temp_variable = { ger_influence = GER.Madagascar_contributions }
	set_temp_variable = { fiddy = 50 }
	divide_temp_variable = { ger_influence = 2 }
	divide_temp_variable = { ger_influence = fiddy }
	add_to_temp_variable = { ger_influence = 0.8 }

	multiply_temp_variable = { TEMP_MADCW_Factionalism = ger_influence }
	round_temp_variable = TEMP_MADCW_Factionalism
	add_to_variable = { global.Madagascar_GER_influence = TEMP_MADCW_Factionalism }
	set_temp_variable = { TEMP_MADCW_Factionalism_2 = TEMP_MADCW_Factionalism }
	multiply_temp_variable = { TEMP_MADCW_Factionalism_2 = -1 }
	add_to_variable = { global.Madagascar_FRA_influence = TEMP_MADCW_Factionalism_2 }

	clamp_variable = {
		var = global.Madagascar_GER_influence
		min = 1
		max = 99
	}
	clamp_variable = {
		var = global.Madagascar_FRA_influence
		min = 1
		max = 99
	}

	set_variable = { madagascar_pie_germany_frame = global.Madagascar_FRA_influence }
	round_variable = madagascar_pie_germany_frame
	multiply_variable = { madagascar_pie_germany_frame = 1000 }
	add_to_variable = { madagascar_pie_germany_frame = 100 }

	GER = { custom_effect_tooltip = MADCW_TT_Adjust_Factionalism_tt }
}

USA_operation_less = {
	set_temp_variable = { MADCW_limited_actions_temp = MADCW_limited_actions }
	subtract_from_temp_variable = { MADCW_limited_actions_temp = 1 }
	if = {
		limit = {
			check_variable = { MADCW_limited_actions_temp > -1 }
		}
		custom_effect_tooltip = USA_MAD_remove_1_action_tt
	}
	else = {
		custom_effect_tooltip = USA_MAD_will_violate_strike_tt
		if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 0 }
			}
			custom_effect_tooltip = USA_MAD_result_strike_1_tt
		}
		else_if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 1 }
			}
			custom_effect_tooltip = USA_MAD_result_strike_2_tt
		}
		else_if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 2 }
			}
			custom_effect_tooltip = USA_MAD_result_strike_3_tt
		}
	}
	if = {
		limit = {
			OR = {
				check_variable = { MAD.MADCW_war_stage = 2 }
				check_variable = { MAD.MADCW_war_stage = 3 }
			}
		}
		custom_effect_tooltip = MADCW_Germany_can_take_away_actions_tt
	}

	add_to_variable = { MADCW_limited_actions = -1 }
	if = {
		limit = {
			check_variable = { MADCW_limited_actions < 0 }
			has_country_leader = { character = USA_Richard_Nixon ruling_only = yes }
			NOT = {
				AND = {
					is_ai = yes
					has_game_rule = {
						rule = MAD_CONSTITUTION
						option = MAD_CONSTITUTION_PADESM
					}
					check_variable = { MADCW_USA_STRIKES = 2 }
					NOT = {
						MAD = {
							has_country_flag = MAD_padesm_path
						}
					}
				}
			}
		}
		if = {
			limit = {
				is_ai = yes
			}
			random = {
				chance = 20
				add_to_variable = { MADCW_USA_STRIKES = 1 }
			}
		}
		else = {
			add_to_variable = { MADCW_USA_STRIKES = 1 }
		}

		if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 1 }
			}
			hidden_effect = {
				USA = {
					country_event = {
						id = USA_MAD_impeach.1
						days = 2
					}
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 2 }
			}
			hidden_effect = {
				USA = {
					country_event = {
						id = USA_MAD_impeach.3
						days = 2
					}
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { MADCW_USA_STRIKES = 3 }
			}
			hidden_effect = {
				USA = {
					country_event = {
						id = USA_MAD_impeach.6
						days = 2
					}
				}
			}
		}
	}
	clamp_variable = {
		var = MADCW_limited_actions
		min = 0
	}
}

# Run to remind yourself what each state is
MAD_print_city_ids = {
	for_each_loop = {
		array = Madagascar_map_array

		if = {
			limit = {
				OR = {
					check_variable = { Madagascar_is_city^i = 1 }
					check_variable = { Madagascar_is_city^i = 2 }
				}
			}
			log = "[?v]: [?v.GetName]"
		}
	}
}

MAD_clear_proxy = {
	clr_global_flag = MAD_civil_war_ongoing
	set_global_flag = MAD_civil_war_over

	MAD = {
		every_owned_state = {
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_Isolated_Authority } }
				remove_dynamic_modifier = { modifier = MAD_Isolated_Authority }
			}
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_No_Authority } }
				remove_dynamic_modifier = { modifier = MAD_No_Authority }
			}
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_Hostile_Territory } }
				remove_dynamic_modifier = { modifier = MAD_Hostile_Territory }
			}
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_Limited_Authority } }
				remove_dynamic_modifier = { modifier = MAD_Limited_Authority }
			}
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_Tamed_Territory } }
				remove_dynamic_modifier = { modifier = MAD_Tamed_Territory }
			}
			if = {
				limit = { has_dynamic_modifier = { modifier = MAD_Base_of_Operations } }
				remove_dynamic_modifier = { modifier = MAD_Base_of_Operations }
			}
			remove_core_of = MDG
			remove_core_of = MDM
		}
	}

	USA = {
		TNO_fopo_remove_madagascar_conflict_tab = yes
		set_temp_variable = { target = MAD }
		TNO_clear_and_recall_volunteers = yes
	}
	JAP = {
		TNO_fopo_remove_madagascar_conflict_tab = yes
		set_temp_variable = { target = MAD }
		TNO_clear_and_recall_volunteers = yes
	}
	GER = {
		TNO_fopo_remove_madagascar_conflict_tab = yes
		set_temp_variable = { target = MDG }
		TNO_clear_and_recall_volunteers = yes
	}
	FRS = {
		TNO_fopo_remove_madagascar_conflict_tab = yes
		set_temp_variable = { target = MDG }
		TNO_clear_and_recall_volunteers = yes
	}
}

MAD_Rebel_Victory = {
	MDG = { transfer_navy = { target = FRA } }

	JAP = {
		#set_temp_variable = { Victory_ID = 26 }
		#set_temp_variable = { Victory_Outcome = 4 }
		#set_temp_variable = { Victory_Points = 100 }
		#Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.1
			days = 1
		}
	}
	USA = {
		#set_temp_variable = { Victory_ID = 26 }
		#set_temp_variable = { Victory_Outcome = 4 }
		#set_temp_variable = { Victory_Points = 100 }
		#Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.1
			days = 1
		}
	}
	GER = {
		#set_temp_variable = { Victory_ID = 26 }
		#set_temp_variable = { Victory_Outcome = 2 }
		#set_temp_variable = { Victory_Points = -100 }
		#Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.1
			days = 1
		}
	}
	MAD = {
		annex_country = {
			target = MDG
			transfer_troops = no
		}

		MAD_Governing_Council = {
			promote_character = paternalism_provisional_government_subtype
		}
		set_politics = {
			ruling_party = paternalism
			elections_allowed = no
		}
		set_popularities = {
			despotism = 25
			liberal_conservatism = 25
			progressivism = 25
			socialist = 25
		}
		if = {
			limit = {
				country_exists = MDM
			}
			annex_country = { target = MDM }
		}
		if = {
			limit = {
				has_game_rule = {
					rule = MADAGASKAR_CIVIL_WAR_OUTCOME
					option = MADAGASKAR_CIVIL_WAR_OUTCOME_MAD
				}
			}
			remove_war_buff = yes
		}
		remove_dynamic_modifier = { modifier = MAD_modif_fractious_united_front }
		remove_ideas = {
			MAD_tsiazombazaha
			MAD_fractious_united_front_modif
			MAD_neverending_supply_crisis
		}
	}

	# post war setup
	# post war events

	# depending on how you measure influence you can add the PADESM (MAD.20) vs TAFAMA (MAD.30) victory events here

	if = {
		limit = {
			OR = {
				AND = {
					check_variable = {
						var = global.Madagascar_USA_influence
						value = 60
						compare = greater_than_or_equals
					}
					has_game_rule = {
						rule = MAD_CONSTITUTION
						option = DEFAULT
					}
				}
				AND = {
					has_game_rule = {
						rule = MAD_CONSTITUTION
						option = MAD_CONSTITUTION_PADESM
					}
					NOT = {
						USA = {
							has_country_flag = USA_MADCW_exposed_madagascar
						}
					}
				}
			}
		}
		MAD = {
			country_event = {
				id = MAD.20
				days = 20
			}
		}
	}
	else_if = {
		limit = {
			OR = {
				AND = {
					check_variable = {
						var = global.Madagascar_JAP_influence
						value = 60
						compare = greater_than_or_equals
					}
					has_game_rule = {
						rule = MAD_CONSTITUTION
						option = DEFAULT
					}
				}
				has_game_rule = {
					rule = MAD_CONSTITUTION
					option = MAD_CONSTITUTION_TAFAMA
				}
			}
		}
		MAD = {
			country_event = {
				id = MAD.30
				days = 20
			}
		}
	}
	else = {
		MAD = {
			country_event = {
				id = MAD.5
				days = 20
			}
		}
	}

	every_country = {
		limit = { is_ai = no }
		news_event = { id = MAD_news.3 hours = 6 }
	}
}

MAD_Colonial_Victory = {
	MDG = {
		every_character = {
			limit = { has_character_flag = MDG_character }
			set_nationality = MAD
		}
	}

	GER = {
		set_temp_variable = { Victory_ID = 26 }
		set_temp_variable = { Victory_Outcome = 5 }
		set_temp_variable = { Victory_Points = 100 }
		Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.2
			days = 1
		}
	}
	USA = {
		set_temp_variable = { Victory_ID = 26 }
		set_temp_variable = { Victory_Outcome = 1 }
		set_temp_variable = { Victory_Points = -100 }
		Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.2
			days = 1
		}
	}
	JAP = {
		set_temp_variable = { Victory_ID = 26 }
		set_temp_variable = { Victory_Outcome = 1 }
		set_temp_variable = { Victory_Points = -100 }
		Cold_War_GUI_AddVictory = yes
		country_event = {
			id = MAD_vic.2
			days = 1
		}
	}
	MDG = {
		transfer_navy = { target = FRA }
		if = {
			limit = {
				has_game_rule = {
					rule = MADAGASKAR_CIVIL_WAR_OUTCOME
					option = MADAGASKAR_CIVIL_WAR_OUTCOME_MDG
				}
			}
			remove_war_buff = yes
		}
	}
	MAD = {
		if = {
			limit = { has_global_flag = german_civil_war_end }

			# check if speer or bormann won the GCW in order to set a new admin in the island

			GER = {
				add_to_faction = MAD
				puppet = MAD
				set_autonomy = {
					target = MAD
					autonomy_state = autonomy_occupied_territory
				}
			}

			if = {
				limit = { 
					check_variable = {
						var = global.Madagascar_GER_influence
						value = global.Madagascar_FRA_influence
						compare = greater_than_or_equals
					}
				}
				# event, legal annex 
				country_event = {
					id = MAD.600
					days = 14
				}
			}
			else = {
				# illegal annex
				country_event = {
					id = MAD.601
					days = 14
				}
			}
		}
		set_temp_variable = { TNO_economy_subtype_temp = token:Econ_Subtype_Military_Directed }
		econ_subtype_change = yes

		delete_unit_template_and_units = { division_template = "Volontaires de la France Libre" disband = no }
		delete_unit_template_and_units = { division_template = "Reziman'ny Mpikomy" disband = no }
		delete_unit_template_and_units = { division_template = "Reziman'ny an-Tendrombohitra" disband = no }
		delete_unit_template_and_units = { division_template = "Fizarana Infantry" disband = no }
		delete_unit_template_and_units = { division_template = "Compagnie de Gendarmerie" disband = no }

		delete_unit_template_and_units = { division_template = "Territorialetruppe" disband = yes }

		set_party_name = {
			ideology = national_socialism
			long_name = MAD_GER_nazi_party_long
			name = MAD_GER_nazi_party
		}
		annex_country = {
			target = MDG
			transfer_troops = yes
		}

		if = {
			limit = {
				country_exists = MDM
			}
			annex_country = { target = MDM }
		}
		remove_ideas = {
			MAD_tsiazombazaha
			MAD_fractious_united_front_modif
			MAD_neverending_supply_crisis
			MDG_neverending_supply_crisis
			MDG_generalburo
		}
		remove_dynamic_modifier = { modifier = MAD_modif_fractious_united_front }
		drop_cosmetic_tag = yes
		MDG_Generalburo_Madagassische = { promote_character = national_socialism_subtype }
		set_cosmetic_tag = MDG_GERMAN
		set_politics = {
			ruling_party = national_socialism
			elections_allowed = no
		}
		set_popularities = {
			national_socialism = 100
		}
	}

	# new administration events
	# oil crisis insurgency events

	every_country = {
		limit = { is_ai = no }
		news_event = { id = MAD_news.4 hours = 6 }
	}
}

MAD_AI_USA_State_GUI = {
	if = {
		limit = {
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_USA > 19 } }
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_USA > 19 } }
			OR = {
				AND = {
					TNO_fopo_MADCW_War_Stage_1 = yes
					TNO_fopo_MDM_controls_state = yes
				}
				AND = {
					TNO_fopo_MADCW_War_Stage_2 = yes
					TNO_fopo_MAD_controls_state = yes
				}
			}
			check_variable = { USA.Madagascar_investment > 5 }
		}
		var:Madagascar_selected_city = {
			set_temp_variable = { us_side_swap = 10 }
			set_temp_variable = { germoney_side_swap = -10 }
			add_to_variable = { Madagascar_strength_var_USA = us_side_swap }
			add_to_variable = { Madagascar_strength_var_GER = germoney_side_swap }
			clamp_variable = {
				var = Madagascar_strength_var_USA
				min = 0
				max = 100
			}
			set_variable = { Madagascar_strength_var_JAP = Madagascar_strength_var_USA }
			clamp_variable = {
				var = Madagascar_strength_var_GER
				min = 0
				max = 100
			}
		}
		hidden_effect = {
			set_temp_variable = { TEMP_MADCW_Investment = -5 }
			MAD_adjust_investment = yes
		}
		set_temp_variable = { TEMP_MADCW_Contribution = 5 }
		MAD_adjust_contribution = yes
	}
	if = {
		limit = {
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_USA > 49 } }
			OR = {
				AND = {
					TNO_fopo_MADCW_War_Stage_1 = yes
					TNO_fopo_MDM_controls_state = yes
					command_power > 2.99
				}
				AND = {
					TNO_fopo_MADCW_War_Stage_2 = yes
					TNO_fopo_MAD_controls_state = yes
					command_power > 7.99
				}
			}
		}
		var:Madagascar_selected_city = {
			set_demilitarized_zone = no
			transfer_state_to = MAD
			create_unit = {
				division = "name = \"Fizarana Infantry\" division_template = \"Fizarana Infantry\" start_experience_factor = 0.5"
				owner = MAD
			}
			if = {
				limit = { TNO_fopo_MADCW_War_Stage_1 = yes }
				remove_dynamic_modifier = { modifier = MAD_No_Authority }
				add_dynamic_modifier = { modifier = MAD_Isolated_Authority }
			}
		}
		hidden_effect = {
			add_command_power = -5
		}
	}
}

MAD_AI_Germany_State_GUI = {
	if = {
		limit = {
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_GER > 19 } }
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_GER > 19 } }
			OR = {
				AND = {
					TNO_fopo_MADCW_War_Stage_1 = yes
					TNO_fopo_MDM_controls_state = yes
				}
				AND = {
					TNO_fopo_MADCW_War_Stage_2 = yes
					TNO_fopo_MAD_controls_state = yes
				}
			}
			# check_variable = { GER.Madagascar_investment > 5 }
		}
		var:Madagascar_selected_city = {
			set_temp_variable = { us_side_swap = -10 }
			set_temp_variable = { germoney_side_swap = 10 }
			add_to_variable = { Madagascar_strength_var_USA = us_side_swap }
			add_to_variable = { Madagascar_strength_var_GER = germoney_side_swap }
			clamp_variable = {
				var = Madagascar_strength_var_USA
				min = 0
				max = 100
			}
			set_variable = { Madagascar_strength_var_JAP = Madagascar_strength_var_USA }
			clamp_variable = {
				var = Madagascar_strength_var_GER
				min = 0
				max = 100
			}
		}
		hidden_effect = {
			set_temp_variable = { TEMP_MADCW_Investment = -5 }
			MAD_adjust_investment = yes
		}
		set_temp_variable = { TEMP_MADCW_Contribution = 5 }
		MAD_adjust_contribution = yes
	}
	if = {
		limit = {
			var:Madagascar_selected_city = { check_variable = { Madagascar_strength_var_GER > 49 } }
			OR = {
				AND = {
					TNO_fopo_MADCW_War_Stage_1 = yes
					TNO_fopo_MDM_controls_state = yes
					command_power > 2.99
				}
				AND = {
					TNO_fopo_MADCW_War_Stage_2 = yes
					TNO_fopo_MAD_controls_state = yes
					command_power > 7.99
				}
			}
		}
		var:Madagascar_selected_city = {
			set_demilitarized_zone = no
			transfer_state_to = MDG
			create_unit = {
				division = "name = \"Infanterie-Division\" division_template = \"Infanterie-Division\" start_experience_factor = 0.5"
				owner = MDG
			}
			if = {
				limit = { TNO_fopo_MADCW_War_Stage_1 = yes }
				remove_dynamic_modifier = { modifier = MAD_No_Authority }
				add_dynamic_modifier = { modifier = MAD_Isolated_Authority }
			}
		}
		hidden_effect = {
			add_command_power = -15
		}
	}
}